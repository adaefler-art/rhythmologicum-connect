# B2.2 — Step-by-Step Navigation Testing Guide

## Übersicht

Dieses Dokument beschreibt die Test-Szenarien für die neue step-basierte Navigation mit Validierungsintegration.

## Voraussetzungen

- Lokale Entwicklungsumgebung mit `npm run dev`
- Supabase Datenbank mit stress funnel konfiguriert
- Test-Patient-Account

## Test-Szenarien

### T1: Step-Navigation Forward

**Ziel:** Verify that forward navigation works correctly through steps

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte alle Pflichtfragen in Schritt 1
3. Klicke auf "Weiter →"
4. Verify:
   - Step 2 wird angezeigt
   - Header zeigt "Schritt 2 von 2"
   - Scroll position ist oben
   - Keine Fehlermeldung

**Erwartetes Ergebnis:** ✅ Navigation zu Schritt 2 erfolgreich

---

### T2: Step-Navigation Backward

**Ziel:** Verify that backward navigation works correctly

**Schritte:**
1. Navigiere zu Schritt 2 (siehe T1)
2. Klicke auf "← Zurück"
3. Verify:
   - Schritt 1 wird wieder angezeigt
   - Header zeigt "Schritt 1 von 2"
   - Vorher eingegebene Antworten sind noch sichtbar
   - "← Zurück" Button ist nicht sichtbar (weil erster Schritt)

**Erwartetes Ergebnis:** ✅ Rückwärtsnavigation funktioniert

---

### T3: Validation Blocking - Missing Required Questions

**Ziel:** Verify that validation blocks forward navigation when required questions are unanswered

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte nur 2 von 4 Pflichtfragen in Schritt 1
3. Klicke auf "Weiter →"
4. Verify:
   - Navigation wird blockiert
   - Fehlermeldung erscheint: "Bitte beantworten Sie alle Pflichtfragen in diesem Schritt (2 fehlend)."
   - Fehlende Fragen werden mit rotem Rahmen hervorgehoben
   - Warnung "⚠️ Diese Pflichtfrage muss beantwortet werden" unter fehlenden Fragen

**Erwartetes Ergebnis:** ✅ Navigation blockiert, Fehler angezeigt

---

### T4: Scroll-to-Missing-Question

**Ziel:** Verify that the page scrolls to the first missing required question

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Scrolle nach unten
3. Beantworte die ersten 2 Fragen
4. Lasse Frage 3 und 4 leer
5. Klicke auf "Weiter →"
6. Verify:
   - Seite scrollt automatisch zu Frage 3
   - Frage 3 hat roten Rahmen
   - Frage 3 ist im Viewport sichtbar (centered)

**Erwartetes Ergebnis:** ✅ Automatischer Scroll zur ersten fehlenden Frage

---

### T5: Auto-Save Answers

**Ziel:** Verify that answers are automatically saved to the database

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte Frage 1 mit Wert "3"
3. Öffne Supabase Dashboard → `assessment_answers` Tabelle
4. Verify:
   - Ein neuer Datensatz wurde erstellt
   - `question_id` entspricht dem key der Frage
   - `answer_value` ist 3
   - `assessment_id` ist gesetzt

**Erwartetes Ergebnis:** ✅ Antwort sofort in DB gespeichert

---

### T6: Progress Indicator

**Ziel:** Verify that progress indicator updates correctly

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Initial state: "Frage 0 von 8 beantwortet", "0% abgeschlossen"
3. Beantworte Frage 1
4. Verify: "Frage 1 von 8 beantwortet", "12% abgeschlossen"
5. Beantworte alle 4 Fragen in Schritt 1
6. Verify: "Frage 4 von 8 beantwortet", "50% abgeschlossen"
7. Progress bar visuell bei 50%

**Erwartetes Ergebnis:** ✅ Progress wird korrekt aktualisiert

---

### T7: Complete Assessment Flow

**Ziel:** Verify end-to-end assessment completion

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte alle 4 Fragen in Schritt 1
3. Klicke "Weiter →"
4. Beantworte alle 4 Fragen in Schritt 2
5. Klicke "✓ Antworten speichern & weiter"
6. Verify:
   - Weiterleitung zu `/patient/stress-check/result?assessmentId=<uuid>`
   - Assessment in DB hat `completed_at` Timestamp
   - Alle 8 Antworten in `assessment_answers`

**Erwartetes Ergebnis:** ✅ Vollständiger Flow funktioniert

---

### T8: Optional Questions

**Ziel:** Verify that optional questions don't block navigation

**Vorbedingung:** Markiere mindestens eine Frage als optional in DB
```sql
UPDATE funnel_step_questions 
SET is_required = false 
WHERE question_id = '<question-id>'
```

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte nur Pflichtfragen, lasse optionale leer
3. Klicke "Weiter →"
4. Verify:
   - Navigation funktioniert
   - Keine Fehlermeldung
   - Optionale Fragen haben "Optional" Badge

**Erwartetes Ergebnis:** ✅ Navigation trotz leerer optionaler Fragen

---

### T9: Error Clearing

**Ziel:** Verify that errors are cleared when questions are answered

**Schritte:**
1. Trigger validation error (siehe T3)
2. Beantworte eine der fehlenden Fragen
3. Verify:
   - Roter Rahmen verschwindet für diese Frage
   - Fehlerzähler in Fehlermeldung aktualisiert sich
4. Beantworte alle fehlenden Fragen
5. Verify:
   - Fehlermeldung verschwindet komplett
   - Alle roten Rahmen verschwunden

**Erwartetes Ergebnis:** ✅ Fehler werden dynamisch aktualisiert

---

### T10: Back Button After Validation Error

**Ziel:** Verify that back navigation works even after validation error

**Schritte:**
1. Trigger validation error in Schritt 1 (siehe T3)
2. Beantworte NICHT die fehlenden Fragen
3. Versuche "Weiter →" mehrmals (bleibt blockiert)
4. ABER: Schritt 1 sollte theoretisch keine "Zurück" Button haben
5. Navigiere stattdessen zu Schritt 2 (nach Beantwortung)
6. Klicke "← Zurück"
7. Verify:
   - Zurück zu Schritt 1
   - Keine Fehlermeldung (wurde gelöscht)
   - Antworten noch vorhanden

**Erwartetes Ergebnis:** ✅ Rückwärtsnavigation cleared Fehler

---

### T11: Mobile Responsiveness

**Ziel:** Verify that step navigation works on mobile

**Schritte:**
1. Öffne `/patient/stress-check` in mobile viewport (< 640px)
2. Beantworte Fragen
3. Navigate forward/backward
4. Verify:
   - Buttons sind touch-friendly
   - Text ist lesbar
   - Progress bar funktioniert
   - Scroll-to-missing funktioniert
   - Keine UI-Überlappungen

**Erwartetes Ergebnis:** ✅ Mobile UX funktioniert einwandfrei

---

### T12: Browser Navigation (Back/Forward)

**Ziel:** Verify behavior with browser back/forward buttons

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte Fragen in Schritt 1, navigiere zu Schritt 2
3. Verwende Browser "Zurück" Button
4. Verify:
   - URL bleibt `/patient/stress-check` (kein History-Entry pro Step)
   - UI bleibt auf Schritt 2 (state-basiert, kein URL routing)
5. Dies ist KORREKT - steps sind state, nicht routes

**Erwartetes Ergebnis:** ✅ Browser navigation hat keinen Effekt auf steps (by design)

---

### T13: Page Refresh During Assessment

**Ziel:** Verify behavior when page is refreshed mid-assessment

**Schritte:**
1. Navigiere zu `/patient/stress-check`
2. Beantworte 2 Fragen
3. Refresh page (F5)
4. Verify:
   - Startet wieder bei Schritt 1
   - Vorher beantwortete Fragen sind SICHTBAR (weil aus DB geladen)
   - Assessment-ID wurde beibehalten
   - Keine doppelten Assessments in DB

**Known Limitation:** 
- Current implementation doesn't restore `currentStepIndex` after refresh
- User starts at Step 1 again but answers are preserved
- This is acceptable for v1 (könnte in Zukunft mit localStorage verbessert werden)

**Erwartetes Ergebnis:** ✅ Antworten bleiben erhalten, step index resettet

---

## API Validation Tests

### T14: API - validate-step Endpoint

**Ziel:** Test the validation API directly

**Request:**
```bash
curl -X POST http://localhost:3000/api/assessment-validation/validate-step \
  -H "Content-Type: application/json" \
  -d '{
    "assessmentId": "<uuid>",
    "stepId": "<step-uuid>"
  }'
```

**Expected Response (valid):**
```json
{
  "success": true,
  "isValid": true,
  "missingQuestions": []
}
```

**Expected Response (invalid):**
```json
{
  "success": true,
  "isValid": false,
  "missingQuestions": [
    {
      "questionId": "<uuid>",
      "questionKey": "question_key",
      "questionLabel": "Frage text",
      "orderIndex": 1
    }
  ]
}
```

---

## Database Integrity Tests

### T15: Assessment Creation

**Query:**
```sql
SELECT * FROM assessments 
WHERE funnel = 'stress' 
ORDER BY started_at DESC 
LIMIT 5;
```

**Verify:**
- New assessment created on first answer
- Only ONE assessment per user session
- `started_at` is set
- `completed_at` is NULL until final submission

---

### T16: Answer Storage

**Query:**
```sql
SELECT aa.*, q.key as question_key, q.label
FROM assessment_answers aa
JOIN questions q ON q.key = aa.question_id
WHERE aa.assessment_id = '<assessment-id>'
ORDER BY aa.created_at;
```

**Verify:**
- Each answer stored with correct `question_id` (uses question.key)
- No duplicate answers (upsert works)
- `answer_value` correct
- Answers can be updated (re-selecting option works)

---

## Performance Tests

### T17: Load Time

**Metric:** Time from page load to first interactive
**Expected:** < 2 seconds

**Schritte:**
1. Clear cache
2. Navigate to `/patient/stress-check`
3. Measure time until "Weiter →" button is clickable

---

### T18: Validation Response Time

**Metric:** Time from clicking "Weiter" to validation result
**Expected:** < 500ms

**Schritte:**
1. Fill out step
2. Click "Weiter →"
3. Measure time until navigation or error

---

## Edge Cases

### T19: Multiple Assessments

**Ziel:** Verify user can complete multiple assessments

**Schritte:**
1. Complete full assessment (T7)
2. Navigate to `/patient/stress-check` again
3. Verify:
   - NEW assessment is created
   - Previous assessment NOT affected
   - Can complete second assessment independently

**Erwartetes Ergebnis:** ✅ Multiple assessments möglich

---

### T20: Network Interruption During Save

**Ziel:** Test resilience to network issues

**Schritte:**
1. Open DevTools → Network tab
2. Answer question
3. Immediately set network to "Offline"
4. Verify:
   - Error message appears
   - Answer NOT saved to DB
5. Re-enable network
6. Answer question again
7. Verify:
   - Save succeeds this time

**Erwartetes Ergebnis:** ✅ Graceful error handling

---

## Regression Tests

### T21: Result Page Still Works

**Ziel:** Verify result page compatible with new assessment structure

**Schritte:**
1. Complete assessment
2. View result page
3. Verify:
   - Stress score displayed
   - Sleep score displayed
   - AMY report generated
   - All data correct

---

### T22: Clinician Dashboard Still Works

**Ziel:** Verify clinician can see new assessments

**Schritte:**
1. Complete assessment as patient
2. Log in as clinician
3. Navigate to `/clinician`
4. Verify:
   - New assessment visible
   - Can view details
   - Report generated

---

## Checkliste für Release

Vor dem Deployment müssen folgende Tests bestanden sein:

- [ ] T1: Forward navigation
- [ ] T2: Backward navigation
- [ ] T3: Validation blocking
- [ ] T4: Scroll-to-missing
- [ ] T5: Auto-save
- [ ] T6: Progress indicator
- [ ] T7: Complete flow
- [ ] T8: Optional questions
- [ ] T11: Mobile responsiveness
- [ ] T14: API validation
- [ ] T21: Result page
- [ ] T22: Clinician dashboard

**Optional (Nice-to-have):**
- [ ] T9: Error clearing
- [ ] T10: Back after error
- [ ] T15-T16: Database integrity
- [ ] T17-T18: Performance
- [ ] T19-T20: Edge cases

---

## Known Issues / Limitations

1. **currentStepIndex not persisted:** After page refresh, user starts at step 1 (but answers are preserved)
2. **No browser history per step:** Browser back/forward don't navigate between steps (by design)
3. **No offline mode:** Answers must be saved immediately (requires network)

---

## Datum

**Erstellt:** 2024-12-09
**Version:** 1.0
**Status:** Bereit für Testing
