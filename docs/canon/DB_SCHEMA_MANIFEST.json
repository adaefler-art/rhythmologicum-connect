{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "version": "0.5.0",
  "description": "Canonical DB Schema Manifest - Single source of truth for allowed database objects in Rhythmologicum Connect",
  "lastUpdated": "2026-01-06",
  "_comment_deprecation": "DEPRECATION MODEL: Deprecated objects remain in the 'tables' or 'enums' arrays (to allow existing migrations to pass validation) AND are listed in the 'deprecated' section (to warn on usage). This dual-listing is intentional and supports gradual migration away from legacy objects. See 'notes.deprecation_model' for details.",
  "tables": [
    "assessment_answers",
    "assessment_events",
    "assessments",
    "audit_log",
    "calculated_results",
    "clinician_patient_assignments",
    "content_page_sections",
    "content_pages",
    "documents",
    "funnel_question_rules",
    "funnel_step_questions",
    "funnel_steps",
    "funnel_versions",
    "funnels",
    "funnels_catalog",
    "medical_validation_results",
    "notifications",
    "organizations",
    "patient_funnels",
    "patient_measures",
    "patient_profiles",
    "pillars",
    "priority_rankings",
    "pre_screening_calls",
    "processing_jobs",
    "questions",
    "review_records",
    "report_sections",
    "reports",
    "risk_bundles",
    "safety_check_results",
    "rls_test_results",
    "tasks",
    "user_consents",
    "user_org_membership",
    "user_profiles"
  ],
  "enums": [
    "assessment_state",
    "assessment_status",
    "notification_status",
    "parsing_status",
    "processing_stage",
    "processing_status",
    "report_status",
    "review_status",
    "safety_action",
    "task_status",
    "user_role",
    "validation_status"
  ],
  "deprecated": {
    "tables": [
      {
        "name": "funnels",
        "reason": "Replaced by funnels_catalog in V0.5",
        "replacement": "funnels_catalog",
        "deprecatedSince": "0.5.0"
      }
    ],
    "enums": []
  },
  "columns": {
    "funnels_catalog": [
      "id",
      "slug",
      "title",
      "pillar_id",
      "description",
      "is_active",
      "org_id",
      "est_duration_min",
      "outcomes",
      "default_version_id",
      "created_at",
      "updated_at"
    ],
    "funnel_versions": [
      "id",
      "funnel_id",
      "version",
      "questionnaire_config",
      "content_manifest",
      "algorithm_bundle_version",
      "prompt_version",
      "is_default",
      "rollout_percent",
      "created_at",
      "updated_at"
    ],
    "assessments": [
      "id",
      "user_id",
      "patient_id",
      "funnel_id",
      "state",
      "current_step_id",
      "created_at",
      "updated_at",
      "completed_at"
    ],
    "organizations": [
      "id",
      "name",
      "slug",
      "settings",
      "is_active",
      "created_at",
      "updated_at"
    ],
    "user_profiles": [
      "id",
      "user_id",
      "organization_id",
      "display_name",
      "metadata",
      "created_at",
      "updated_at"
    ],
    "user_org_membership": [
      "id",
      "user_id",
      "organization_id",
      "role",
      "is_active",
      "created_at",
      "updated_at"
    ],
    "patient_profiles": [
      "id",
      "user_id",
      "date_of_birth",
      "gender",
      "created_at",
      "updated_at"
    ],
    "pillars": [
      "id",
      "key",
      "title",
      "description",
      "sort_order",
      "created_at",
      "updated_at"
    ],
    "processing_jobs": [
      "id",
      "assessment_id",
      "correlation_id",
      "status",
      "stage",
      "attempt",
      "max_attempts",
      "created_at",
      "updated_at",
      "started_at",
      "completed_at",
      "errors",
      "schema_version",
      "pdf_path",
      "pdf_metadata",
      "pdf_generated_at",
      "delivery_status",
      "delivery_timestamp",
      "delivery_metadata",
      "delivery_attempt"
    ],
    "risk_bundles": [
      "id",
      "job_id",
      "assessment_id",
      "risk_bundle_version",
      "algorithm_version",
      "funnel_version",
      "calculated_at",
      "created_at",
      "updated_at",
      "bundle_data"
    ],
    "priority_rankings": [
      "id",
      "job_id",
      "risk_bundle_id",
      "ranking_version",
      "algorithm_version",
      "registry_version",
      "program_tier",
      "ranked_at",
      "created_at",
      "updated_at",
      "ranking_data"
    ],
    "medical_validation_results": [
      "id",
      "job_id",
      "sections_id",
      "validation_version",
      "engine_version",
      "ruleset_hash",
      "overall_status",
      "overall_passed",
      "validation_data",
      "flags_raised_count",
      "critical_flags_count",
      "warning_flags_count",
      "info_flags_count",
      "rules_evaluated_count",
      "validation_time_ms",
      "validated_at",
      "created_at",
      "updated_at"
    ],
    "notifications": [
      "id",
      "user_id",
      "job_id",
      "assessment_id",
      "notification_type",
      "status",
      "channel",
      "priority",
      "subject",
      "message",
      "metadata",
      "consent_verified",
      "consent_version",
      "sent_at",
      "delivered_at",
      "read_at",
      "failed_at",
      "error_message",
      "follow_up_at",
      "follow_up_completed",
      "created_at",
      "updated_at",
      "expires_at"
    ],
    "review_records": [
      "id",
      "job_id",
      "review_iteration",
      "status",
      "queue_reasons",
      "is_sampled",
      "sampling_hash",
      "sampling_config_version",
      "validation_result_id",
      "safety_check_id",
      "reviewer_user_id",
      "reviewer_role",
      "decision_reason_code",
      "decision_notes",
      "decided_at",
      "audit_metadata",
      "created_at",
      "updated_at"
    ],
    "safety_check_results": [
      "id",
      "job_id",
      "sections_id",
      "safety_version",
      "prompt_version",
      "model_provider",
      "model_name",
      "model_temperature",
      "model_max_tokens",
      "overall_action",
      "safety_score",
      "overall_severity",
      "check_data",
      "findings_count",
      "critical_findings_count",
      "high_findings_count",
      "medium_findings_count",
      "low_findings_count",
      "evaluation_time_ms",
      "llm_call_count",
      "prompt_tokens",
      "completion_tokens",
      "total_tokens",
      "fallback_used",
      "evaluation_key_hash",
      "evaluated_at",
      "created_at",
      "updated_at"
    ]
  },
  "constraints": {
    "funnels_catalog": [
      "funnels_catalog_slug_key"
    ],
    "funnel_versions": [
      "funnel_versions_funnel_id_version_key"
    ],
    "user_org_membership": [
      "user_org_membership_user_id_organization_id_key"
    ],
    "calculated_results": [
      "calculated_results_assessment_version_unique"
    ],
    "reports": [
      "reports_assessment_version_unique"
    ],
    "report_sections": [
      "report_sections_report_key_unique"
    ],
    "processing_jobs": [
      "processing_jobs_assessment_correlation_version_unique"
    ],
    "risk_bundles": [
      "risk_bundles_job_id_unique"
    ],
    "priority_rankings": [
      "priority_rankings_job_version_unique"
    ],
    "medical_validation_results": [
      "medical_validation_results_job_version_hash_unique"
    ],
    "review_records": [
      "review_records_job_iteration_unique",
      "review_records_decision_notes_length",
      "review_records_reviewer_required"
    ],
    "safety_check_results": [
      "safety_check_results_job_id_unique",
      "safety_check_results_evaluation_key_unique"
    ]
  },
  "notes": {
    "purpose": "This manifest serves as the canonical allowlist for database objects. Any CREATE TABLE or CREATE TYPE statement in migrations must reference objects listed here.",
    "usage": "Run scripts/db/lint-migrations.ps1 to validate migrations against this manifest",
    "maintenance": "When adding new canonical tables/enums, update this manifest AND document the change in docs/canon/DB_MIGRATIONS.md",
    "legacy": "The 'deprecated' section lists objects that should be flagged in migrations. These may exist for backward compatibility but should not be used in new migrations.",
    "deprecation_model": "Deprecated objects remain in the 'tables' or 'enums' array to allow existing migrations to pass validation, but are ALSO listed in the 'deprecated' section to warn on usage. This supports gradual migration away from legacy objects."
  }
}
