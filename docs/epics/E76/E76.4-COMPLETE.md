# E76.4 ‚Äî Execution Worker: Diagnose-Run ausf√ºhren + Artefakt persistieren ‚Äî COMPLETE

## Summary

Successfully implemented E76.4: Diagnosis Execution Worker for processing queued diagnosis runs with full lifecycle management, schema validation, error handling, and artifact persistence.

## What Was Delivered

### 1. Database Schema (Migration: `20260204104959_e76_4_diagnosis_runs_and_artifacts.sql`)

**Created Tables:**

#### `diagnosis_runs`
- **Purpose**: Tracks diagnosis run execution lifecycle
- **Status Lifecycle**: `queued` ‚Üí `running` ‚Üí `completed|failed`
- **Key Fields**:
  - `id`: Unique run identifier (UUID)
  - `patient_id`: Patient being diagnosed
  - `clinician_id`: Clinician who initiated the run
  - `status`: Current run status
  - `inputs_hash`: SHA256 hash for idempotency
  - `error_code`, `error_message`, `error_details`: Error tracking
  - `mcp_run_id`: MCP server correlation ID
  - `processing_time_ms`: Total processing duration
  - `retry_count`, `max_retries`: Retry configuration

#### `diagnosis_artifacts`
- **Purpose**: Stores diagnosis results and related artifacts
- **Artifact Types**: `diagnosis_json`, `context_pack`, `mcp_response`
- **Key Fields**:
  - `id`: Unique artifact identifier (UUID)
  - `run_id`: Foreign key to diagnosis_runs
  - `artifact_data`: Full JSON payload
  - `risk_level`: Extracted risk level (`low`, `medium`, `high`, `critical`)
  - `confidence_score`: Extracted confidence score (0.0 to 1.0, stored as `real`)
  - `primary_findings`: Extracted findings array
  - `recommendations_count`: Count of recommendations

**Indexes Created:**
- `idx_diagnosis_runs_patient_id`, `idx_diagnosis_runs_clinician_id`
- `idx_diagnosis_runs_status`, `idx_diagnosis_runs_created_at`
- `idx_diagnosis_runs_inputs_hash`
- `idx_diagnosis_artifacts_run_id`, `idx_diagnosis_artifacts_patient_id`
- `idx_diagnosis_artifacts_created_at`, `idx_diagnosis_artifacts_risk_level`

**RLS Policies:**
- Clinicians/admins can read all diagnosis runs and artifacts
- Clinicians/admins can create diagnosis runs
- System (service role) can update diagnosis runs and insert artifacts
- Row-level security enabled on both tables

**Triggers:**
- `updated_at` auto-update trigger on `diagnosis_runs`

### 2. Contracts & Types (`lib/contracts/diagnosis.ts`)

**Enums Defined:**
- `DIAGNOSIS_RUN_STATUS`: `queued`, `running`, `completed`, `failed`
- `DIAGNOSIS_ERROR_CODE`: `VALIDATION_ERROR`, `LLM_ERROR`, `CONTEXT_PACK_ERROR`, `MCP_ERROR`, `NETWORK_ERROR`, `TIMEOUT_ERROR`, `UNKNOWN_ERROR`
- `ARTIFACT_TYPE`: `diagnosis_json`, `context_pack`, `mcp_response`
- `RISK_LEVEL`: `low`, `medium`, `high`, `critical`

**Zod Schemas Created:**
- `DiagnosisErrorDetailsSchema`: Error details structure
- `DiagnosisResultSchema`: LLM diagnosis output validation
- `DiagnosisArtifactDataSchema`: Full artifact data structure
- `DiagnosisRunSchema`: Database record validation
- `DiagnosisArtifactSchema`: Artifact record validation
- `CreateDiagnosisRunSchema`: Input validation for creating runs
- `UpdateDiagnosisRunSchema`: Input validation for updating runs

**Constants:**
- `DEFAULT_SCHEMA_VERSION = 'v1'`
- `DEFAULT_MAX_RETRIES = 3`
- `DIAGNOSIS_TIMEOUT_MS = 300000` (5 minutes)
- `MIN_CONFIDENCE_SCORE = 0.5`

### 3. Execution Worker (`lib/diagnosis/worker.ts`)

**Main Function:** `executeDiagnosisRun(adminClient, runId)`

**Lifecycle Steps:**
1. **Fetch & Status Check**
   - Retrieves diagnosis run from database
   - Validates status is `queued` (concurrency prevention)
   - Returns error if already processing

2. **Update to Running**
   - Sets status to `running`
   - Records `started_at` timestamp

3. **Build Context Pack**
   - Calls `buildPatientContextPack()` from E76.2
   - Catches and handles context pack errors

4. **Call MCP/LLM**
   - Fetches MCP_SERVER_URL (validates in production)
   - Posts to `/tools` endpoint with `run_diagnosis` tool
   - Handles network and MCP errors

5. **Validate Diagnosis Result**
   - Uses `DiagnosisResultSchema.parse()` for validation
   - Catches validation errors with `VALIDATION_ERROR` code
   - Includes received data in error details

6. **Persist Artifact**
   - Inserts into `diagnosis_artifacts` table
   - Extracts risk_level, confidence_score, primary_findings
   - Records metadata (mcp_run_id, versions, timestamps)

7. **Update Status**
   - Sets status to `completed` on success
   - Sets status to `failed` on error with error details
   - Records `completed_at` and `processing_time_ms`

**Helper Function:** `updateRunAsFailed(adminClient, runId, error)`
- Centralizes failed status updates
- Records error code, message, and details

**Batch Function:** `processQueuedDiagnosisRuns(adminClient, limit)`
- Fetches queued runs (FIFO order)
- Executes each run sequentially
- Returns array of execution results

### 4. API Route (`/api/studio/diagnosis/execute`)

**File:** `apps/rhythm-studio-ui/app/api/studio/diagnosis/execute/route.ts`

**Endpoint:** `POST /api/studio/diagnosis/execute`

**Features:**
- Feature-gated behind `NEXT_PUBLIC_FEATURE_DIAGNOSIS_ENABLED`
- Returns 503 if feature disabled
- Requires authentication (clinician or admin)
- Returns 401 for unauthenticated, 403 for unauthorized

**Request Body:**
```typescript
{
  run_id?: string,    // Optional: UUID of specific run to execute
  limit?: number      // Optional: Max runs to process (default: 10)
}
```

**Response (Single Run):**
```typescript
{
  success: boolean,
  data: {
    success: boolean,
    run_id: string,
    artifact_id?: string,
    error?: {
      code: DiagnosisErrorCode,
      message: string,
      details?: Record<string, unknown>
    }
  }
}
```

**Response (Batch Processing):**
```typescript
{
  success: boolean,
  data: {
    processed: number,
    results: DiagnosisExecutionResult[]
  }
}
```

### 5. UUID Validation Utility (`lib/validators/uuid.ts`)

**Exports:**
- `UUID_REGEX`: RFC 4122 compliant regex pattern
- `isValidUUID(value)`: Type guard for UUID validation
- `validateUUID(value, paramName)`: Assert function with error throwing

**Used In:**
- `/api/studio/diagnosis/execute/route.ts`
- `/api/mcp/context-pack/route.ts`

**Benefits:**
- Eliminates code duplication
- Ensures consistent UUID validation across codebase
- Type-safe with TypeScript

### 6. Literal Callsite (Strategy A Compliance)

**File:** `apps/rhythm-studio-ui/app/admin/diagnostics/mcp-test/page.tsx`

**Added:**
- `testDiagnosisExecution()` function
- Literal string: `'/api/studio/diagnosis/execute'`
- Test button: "Test Diagnosis Execution Endpoint"
- Result display with scrollable JSON output

**Compliance:**
- ‚úÖ Contains literal endpoint string
- ‚úÖ Enables manual testing
- ‚úÖ Satisfies Strategy A requirement

### 7. Feature Flag

**File:** `lib/featureFlags.ts`

**Added:**
- `DIAGNOSIS_ENABLED: boolean` to `FeatureFlags` type
- Environment variable: `NEXT_PUBLIC_FEATURE_DIAGNOSIS_ENABLED`
- Default value: `false` (not yet production-ready)

**File:** `.env.example`

**Added:**
```bash
# -------------------------------------------------------------------
# OPTIONAL: Diagnosis Execution Worker Configuration (E76.4)
# -------------------------------------------------------------------
# Feature flag to enable/disable diagnosis execution worker
# Default: false (not yet production-ready)
NEXT_PUBLIC_FEATURE_DIAGNOSIS_ENABLED=false
```

### 8. Verification Script

**File:** `scripts/ci/verify-e76-4-diagnosis-worker.mjs`

**Verifies 10 Rules:**
1. R-E76.4-001: Database migration exists
2. R-E76.4-002: Diagnosis contract exists
3. R-E76.4-003: Worker module exists
4. R-E76.4-004: Schema validation implemented
5. R-E76.4-005: VALIDATION_ERROR handling present
6. R-E76.4-006: Concurrency prevention implemented
7. R-E76.4-007: API route exists
8. R-E76.4-008: Literal callsite exists
9. R-E76.4-009: Feature flag exists
10. R-E76.4-010: Authorization check present

**Usage:** `npm run verify:e76-4`

**All checks pass:** ‚úÖ

### 9. Documentation Updates

**Updated Files:**
1. `docs/guardrails/RULES_VS_CHECKS_MATRIX.md` - Added 10 E76.4 rules with complete details
2. `docs/api/endpoint-allowlist.json` - Added `/api/studio/diagnosis/execute`
3. `package.json` - Added `verify:e76-4` script

**Summary Statistics:**
- Total Rules: 52 (42 prior + 10 E76.4)
- Coverage: 100%
- All rules have verification scripts

## Architecture Decisions

### 1. Separate Tables for Runs and Artifacts

**Decision:** Use `diagnosis_runs` and `diagnosis_artifacts` as separate tables

**Rationale:**
- Clear separation of execution state vs. output data
- Allows multiple artifacts per run (context pack, MCP response, diagnosis JSON)
- Easier to query by run status vs. artifact content
- Supports future artifact types without schema changes

### 2. Real Type for Confidence Score

**Decision:** Use `real` instead of `numeric(3, 2)` for confidence_score

**Rationale:**
- More flexible for floating-point values
- Avoids precision limitations (numeric(3,2) can't represent 1.00 properly)
- CHECK constraint still enforces 0.0 to 1.0 range
- Consistent with typical ML confidence scores

### 3. Status-Based Concurrency Prevention

**Decision:** Check status = 'queued' before processing

**Rationale:**
- Simple and effective race condition prevention
- No need for database locks or transactions
- Status transition provides audit trail
- Workers can safely poll for queued runs

### 4. Error Codes with Structured Details

**Decision:** Use enum error codes + JSON error_details

**Rationale:**
- Categorized errors for easier handling
- Details field allows context-specific information
- PHI-safe (can redact sensitive data in details)
- Enables automated error recovery strategies

### 5. Feature Flag Default: false

**Decision:** `DIAGNOSIS_ENABLED` defaults to false

**Rationale:**
- Not yet production-ready (uses stubbed MCP responses)
- Requires manual opt-in for testing
- Prevents accidental execution in production
- Aligns with "dark launch" pattern

### 6. MCP Server URL Validation in Production

**Decision:** Throw error if MCP_SERVER_URL not set in production

**Rationale:**
- Prevents silent failures in production
- Documents required configuration
- Allows localhost default for development
- Fail-fast on misconfiguration

### 7. Shared UUID Validation Utility

**Decision:** Extract UUID validation to `lib/validators/uuid.ts`

**Rationale:**
- Eliminates code duplication (used in 2+ routes)
- Ensures consistent validation across codebase
- Type-safe with TypeScript type guards
- Easy to test and maintain

## Testing Evidence

### Verification Script Test
```bash
$ npm run verify:e76-4

üîç E76.4: Verifying Diagnosis Execution Worker implementation...

‚úÖ All E76.4 guardrails satisfied

Verified 10 rules:
  ‚úì R-E76.4-001: Database migration for diagnosis_runs and diagnosis_artifacts must exist
  ‚úì R-E76.4-002: Diagnosis contract with types and schemas must exist
  ‚úì R-E76.4-003: Worker module must exist
  ‚úì R-E76.4-004: Worker must implement schema validation for diagnosis result
  ‚úì R-E76.4-005: Worker must handle VALIDATION_ERROR for invalid results
  ‚úì R-E76.4-006: Worker must implement concurrency prevention (status check)
  ‚úì R-E76.4-007: API route /api/studio/diagnosis/execute must exist
  ‚úì R-E76.4-008: Literal callsite for /api/studio/diagnosis/execute must exist
  ‚úì R-E76.4-009: Feature flag DIAGNOSIS_ENABLED must exist
  ‚úì R-E76.4-010: API route must check authorization (clinician/admin only)
```

### Build Test
```bash
$ npm run build:studio
‚úì Compiled successfully in 9.5s
```

### Security Scan Results
```bash
$ CodeQL Analysis
Analysis Result for 'javascript'. Found 0 alerts.
‚úÖ No security vulnerabilities detected
```

### Code Review Results
All 3 issues identified and fixed:
1. ‚úÖ Confidence score type changed to `real`
2. ‚úÖ MCP server URL validation added for production
3. ‚úÖ UUID validation extracted to shared utility

## Acceptance Criteria Met ‚úÖ

### Run Processed, Artifact Written
- ‚úÖ Worker processes queued runs sequentially
- ‚úÖ Context pack fetched via existing builder
- ‚úÖ MCP server called for diagnosis
- ‚úÖ Artifact persisted to database
- ‚úÖ Run status updated to completed

### Invalid Result: Status Failed with VALIDATION_ERROR
- ‚úÖ DiagnosisResultSchema validates all responses
- ‚úÖ Validation errors caught and logged
- ‚úÖ Run status set to `failed`
- ‚úÖ Error code set to `VALIDATION_ERROR`
- ‚úÖ Error message and details recorded

### API Route with Literal Callsite
- ‚úÖ Route exists: `/api/studio/diagnosis/execute`
- ‚úÖ Literal string in test page
- ‚úÖ Strategy A compliant
- ‚úÖ Feature-flagged but string preserved

### Endpoint Wiring Gate
- ‚úÖ No orphan (added to allowlist)
- ‚úÖ Verification script passes
- ‚úÖ Authorization check enforced

### Guardrails Complete
- ‚úÖ All 10 rules verified
- ‚úÖ 100% coverage
- ‚úÖ Documentation updated

## Files Changed

### Created (8 files)
1. `supabase/migrations/20260204104959_e76_4_diagnosis_runs_and_artifacts.sql` - Database schema
2. `lib/contracts/diagnosis.ts` - Types and schemas
3. `lib/diagnosis/worker.ts` - Execution worker
4. `lib/validators/uuid.ts` - UUID validation utility
5. `apps/rhythm-studio-ui/app/api/studio/diagnosis/execute/route.ts` - API route
6. `scripts/ci/verify-e76-4-diagnosis-worker.mjs` - Verification script

### Modified (6 files)
1. `apps/rhythm-studio-ui/app/admin/diagnostics/mcp-test/page.tsx` - Added test UI
2. `apps/rhythm-studio-ui/app/api/mcp/context-pack/route.ts` - Use shared UUID validation
3. `lib/featureFlags.ts` - Added DIAGNOSIS_ENABLED flag
4. `.env.example` - Added configuration
5. `docs/guardrails/RULES_VS_CHECKS_MATRIX.md` - Added E76.4 rules
6. `docs/api/endpoint-allowlist.json` - Added new endpoint
7. `package.json` - Added verify script

## Current Limitations (Acknowledged)

1. **Stubbed MCP Responses**: MCP server returns mock data, not real diagnostics (E76.1 limitation)
2. **No Real LLM Integration**: LLM call not yet implemented (future epic)
3. **No Retry Mechanism**: Worker does not automatically retry failed runs (manual retry required)
4. **Sequential Processing**: Batch processing is sequential, not parallel (sufficient for MVP)
5. **No Cron/Queue Integration**: Worker must be called manually via API (no automated scheduling yet)
6. **Local-Only Testing**: No end-to-end tests with real database and MCP server

These limitations are intentional for E76.4 scope and will be addressed in future epics.

## Next Steps (Future Work)

### E76.5: Prompt v1 & Output Schema Contract (Planned)
- Define diagnosis JSON schema specification
- Implement prompt template for LLM
- Update MCP server to use real LLM API
- Validate output structure

### E76.6: Studio UI for Diagnosis Runs (Planned)
- List diagnosis runs for a patient
- View diagnosis artifacts (JSON viewer)
- Trigger new diagnosis runs
- Display risk levels and findings

### E76.7: Security & Audit (Planned)
- RLS policies refinement
- Audit logging for diagnosis runs
- PHI redaction in error details
- Access control enforcement

### E76.8: Determinism & Idempotency (Planned)
- Use inputs_hash for duplicate detection
- Implement deduplication policy
- Cache context packs by hash
- Optimize repeated runs

### E76.9: Developer Runbook (Planned)
- Troubleshooting guide
- Manual testing procedures
- Production deployment checklist
- Monitoring and alerting setup

## Conclusion

E76.4 is **COMPLETE** and **READY FOR REVIEW**.

All requirements met:
- ‚úÖ Diagnosis runs and artifacts tables with full schema
- ‚úÖ Execution worker with complete lifecycle management
- ‚úÖ Schema validation using Zod
- ‚úÖ Error handling with VALIDATION_ERROR support
- ‚úÖ Concurrency prevention (status check)
- ‚úÖ API route with authorization
- ‚úÖ Literal callsite (Strategy A)
- ‚úÖ Feature flag implementation
- ‚úÖ UUID validation utility
- ‚úÖ Complete guardrails with verification script
- ‚úÖ RULES_VS_CHECKS_MATRIX.md updated
- ‚úÖ Code review issues addressed
- ‚úÖ Security scan passed (0 vulnerabilities)
- ‚úÖ Build succeeds with no errors

The diagnosis execution worker provides a solid foundation for LLM-based diagnosis while maintaining strict quality, security, and compliance standards. It integrates seamlessly with the existing MCP server (E76.1) and context pack builder (E76.2), and is ready for the next phase of the E76 epic.
