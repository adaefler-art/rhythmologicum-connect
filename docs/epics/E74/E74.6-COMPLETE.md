# E74.6 - COMPLETE

## Summary

Successfully implemented E74.6: Patient Funnels Lifecycle + Org Scoping with assignment, status management, audit logging, and UI integration.

## What Was Delivered

### 1. Database Migration
**File:** `supabase/migrations/20260201151428_e74_6_patient_funnels_lifecycle.sql`

- ✅ RLS policy: Staff can INSERT patient_funnels for org patients
- ✅ RLS policy: Staff can UPDATE patient_funnels for org patients  
- ✅ RLS policy: Staff can SELECT patient_funnels (already existed)
- ✅ Audit logging trigger for all patient_funnels changes
- ✅ Updated_at trigger for patient_funnels
- ✅ Proper org scoping via user_org_membership
- ✅ Support for direct patient assignments

### 2. API Endpoints
**Files:**
- `apps/rhythm-studio-ui/app/api/clinician/patient-funnels/route.ts`
- `apps/rhythm-studio-ui/app/api/clinician/patient-funnels/[id]/route.ts`
- `apps/rhythm-studio-ui/app/api/clinician/patients/[patientId]/funnels/route.ts`

**POST /api/clinician/patient-funnels** - Assign funnel to patient
- ✅ Validates funnel exists and is active
- ✅ Validates version exists and is published
- ✅ Prevents duplicate active/paused assignments
- ✅ RLS enforces org scoping
- ✅ Role check: clinician/admin/nurse

**PATCH /api/clinician/patient-funnels/[id]** - Update status or version
- ✅ Status transitions: active ↔ paused ↔ completed
- ✅ Version changes (only to published versions)
- ✅ Automatic completed_at timestamp management
- ✅ RLS enforces org scoping
- ✅ Role check: clinician/admin/nurse

**GET /api/clinician/patients/[patientId]/funnels** - List patient funnels
- ✅ Returns funnels with related data (funnel_catalog, funnel_versions)
- ✅ Ordered by created_at descending
- ✅ RLS enforces org scoping
- ✅ Role check: clinician/admin/nurse

### 3. UI Components
**Files:**
- `apps/rhythm-studio-ui/app/clinician/patient/[id]/FunnelsSection.tsx`
- `apps/rhythm-studio-ui/app/clinician/patient/[id]/page.tsx` (updated)

**FunnelsSection Component:**
- ✅ Lists all patient funnel assignments
- ✅ Displays status with color-coded badges
- ✅ Shows version number and pillar
- ✅ Status controls:
  - Active → Pause or Complete
  - Paused → Resume or Complete
  - Completed → Reactivate
- ✅ Real-time UI updates after status changes
- ✅ Error handling and loading states

**Patient Detail Page:**
- ✅ Added "Funnels" tab to existing tabs
- ✅ Integrated FunnelsSection component
- ✅ Consistent with existing UI patterns

### 4. Verification Script
**File:** `scripts/ci/verify-e74-6-patient-funnels.mjs`

Implements 4 validation checks:
- ✅ `checkRLSPolicies()` - Verifies staff INSERT/UPDATE/SELECT policies
- ✅ `checkTriggers()` - Verifies audit and updated_at triggers
- ✅ `checkStatusConstraint()` - Verifies status constraint
- ✅ `checkAPIEndpoints()` - Verifies API files and role checks

**Usage:** `npm run verify:e74-6`

### 5. Documentation

**RULES_VS_CHECKS_MATRIX.md** (Updated)
- Added 8 E74.6 rules
- Added 8 E74.6 error codes
- Updated coverage metrics: 44 total rules (18+8+10+8)
- 100% coverage maintained

**E74.6-COMPLETE.md** (This file)
- Complete implementation guide
- Files changed with detailed explanations
- Acceptance criteria validation
- Testing instructions

## Acceptance Criteria

✅ **Assignment:** Clinicians can assign funnels to patients
- POST /api/clinician/patient-funnels creates assignment
- Validates funnel is active and version is published
- Prevents duplicate assignments

✅ **Status Management:** Clinicians can pause, resume, complete funnels
- PATCH /api/clinician/patient-funnels/[id] updates status
- UI provides intuitive status controls
- Status transitions are validated

✅ **Version Selection:** Clinicians can assign specific versions
- POST accepts active_version_id parameter
- Defaults to funnel's default_version_id
- Only published versions allowed

✅ **Audit Logging:** All changes are logged
- Trigger logs INSERT/UPDATE/DELETE to audit_log
- Captures before/after state in diff field
- Records actor, org, and metadata

✅ **Authorization:** Only authorized staff can manage
- RLS policies enforce org scoping
- API endpoints require clinician/admin/nurse role
- Patients cannot modify their own funnels via these endpoints

## Guardrails Met

✅ **Every rule has a check implementation**
- 8/8 E74.6 rules implemented in verification script

✅ **Every check references a rule ID**
- Complete ERROR_CODE_TO_RULE_ID mapping in script

✅ **Check output contains "violates R-XYZ"**
- Format: `[ERROR_CODE] violates R-E74.6-XXX: message`

✅ **RULES_VS_CHECKS_MATRIX.md updated**
- All rules documented
- All error codes mapped
- Coverage audit updated

## Architecture

### Data Flow

```
Clinician Action (UI)
    ↓
API Endpoint (Auth + Role Check)
    ↓
Supabase Client (RLS Enforcement)
    ↓
patient_funnels Table
    ↓
Triggers (Audit Log + Updated_at)
```

### Security Layers

1. **API Level:** Authentication + Role validation
2. **RLS Level:** Org scoping via user_org_membership
3. **Constraint Level:** Status validation
4. **Audit Level:** Complete change tracking

### Status Lifecycle

```
[Not Assigned]
    ↓ (assign)
[Active]
    ↓ (pause)        ↓ (complete)
[Paused]          [Completed]
    ↓ (resume)        ↓ (reactivate)
[Active]          [Active]
```

## Files Changed

### Database
- `supabase/migrations/20260201151428_e74_6_patient_funnels_lifecycle.sql` - New migration

### API Routes
- `apps/rhythm-studio-ui/app/api/clinician/patient-funnels/route.ts` - New (POST)
- `apps/rhythm-studio-ui/app/api/clinician/patient-funnels/[id]/route.ts` - New (PATCH)
- `apps/rhythm-studio-ui/app/api/clinician/patients/[patientId]/funnels/route.ts` - New (GET)

### UI Components
- `apps/rhythm-studio-ui/app/clinician/patient/[id]/FunnelsSection.tsx` - New
- `apps/rhythm-studio-ui/app/clinician/patient/[id]/page.tsx` - Modified (added Funnels tab)

### Guardrails
- `scripts/ci/verify-e74-6-patient-funnels.mjs` - New
- `package.json` - Modified (added verify:e74-6 script)
- `docs/RULES_VS_CHECKS_MATRIX.md` - Modified (added E74.6 rules and checks)

### Documentation
- `E74.6-COMPLETE.md` - New (this file)

## Testing

### Automated Verification
```bash
npm run verify:e74-6
```

Expected output: ✅ All checks passed (with possible warnings for programmatic verification)

### Manual Testing Scenarios

#### 1. Assignment Test
**Setup:** Log in as clinician, navigate to patient detail page
**Steps:**
1. Click "Funnels" tab
2. (Future) Click "Assign Funnel" button
3. Select funnel and version
4. Submit assignment
**Expected:** Funnel appears in list with "Active" status

#### 2. Status Change Test
**Setup:** Patient has active funnel assigned
**Steps:**
1. Navigate to patient Funnels tab
2. Click "Pausieren" button
3. Observe status change to "Paused"
4. Click "Fortsetzen" button
**Expected:** Status changes reflected immediately, audit log created

#### 3. Completion Test
**Setup:** Patient has active funnel
**Steps:**
1. Click "Abschließen" button
2. Verify completed_at timestamp is set
3. Try to pause (should show "Reaktivieren" instead)
**Expected:** Status = completed, buttons updated

#### 4. Org Scoping Test
**Setup:** Two clinicians in different orgs
**Steps:**
1. Clinician A assigns funnel to Patient X
2. Clinician B (different org) tries to view Patient X's funnels
**Expected:** Clinician B gets 403 or empty list (RLS blocks access)

#### 5. Audit Log Test
**Setup:** Patient with funnel
**Steps:**
1. Change funnel status
2. Query audit_log table:
   ```sql
   SELECT * FROM audit_log 
   WHERE entity_type = 'patient_funnel' 
   ORDER BY created_at DESC LIMIT 5;
   ```
**Expected:** Audit entry with diff showing status change

## Known Limitations

1. **Funnel Assignment UI:** Currently no "Assign New Funnel" button in UI (marked as TODO in FunnelsSection.tsx). Can be assigned via API.

2. **Version Selection UI:** No UI control to change version after assignment (can be done via API).

3. **Archived Status:** UI does not show controls for archived funnels (status=archived is supported in DB/API).

4. **Available Funnels List:** No endpoint yet to list available funnels for assignment (would need to filter funnels_catalog by is_active=true).

## Future Enhancements

- [ ] Add "Assign New Funnel" dialog with funnel selection
- [ ] Add version selection dropdown in UI
- [ ] Add bulk assignment (assign funnel to multiple patients)
- [ ] Add funnel progress tracking (e.g., percentage complete)
- [ ] Add filtering/sorting in funnels list
- [ ] Add funnel history view (show all status changes)
- [ ] Add notifications for status changes
- [ ] Add funnel templates for common assignments

## Related Work

- E74.1: Canonical funnel definition schema
- E74.2: Migration to canonical v1
- E74.3: Studio editor (draft/publish/versioning)
- E74.5: Persistence and idempotency
- V0.5: patient_funnels table creation
- RLS: Org scoping infrastructure

## Migration Path

If upgrading from earlier version:

1. **Run Migration:**
   ```bash
   supabase migration up
   ```

2. **Verify RLS Policies:**
   ```sql
   SELECT policyname, cmd 
   FROM pg_policies 
   WHERE tablename = 'patient_funnels';
   ```

3. **Verify Triggers:**
   ```sql
   SELECT tgname 
   FROM pg_trigger t
   JOIN pg_class c ON t.tgrelid = c.oid
   WHERE c.relname = 'patient_funnels';
   ```

4. **Run Verification:**
   ```bash
   npm run verify:e74-6
   ```

## Troubleshooting

| Issue | Check | Fix |
|-------|-------|-----|
| Can't assign funnel | RLS policy exists? | Run migration |
| 403 on API call | User has clinician role? | Check user.app_metadata.role |
| Status not updating | Trigger exists? | Check pg_trigger table |
| No audit log | Trigger working? | Test with manual INSERT |
| UI not updating | API returning success? | Check browser console for errors |

## Security Considerations

✅ **RLS Enforcement:** All database access goes through RLS
✅ **Role-Based Access:** API endpoints check user role
✅ **Org Scoping:** Can only manage patients in same org
✅ **Audit Trail:** All changes logged with actor
✅ **Version Safety:** Only published versions can be assigned
✅ **Status Constraints:** Database enforces valid status values

## Contact

For questions or issues with E74.6 implementation, refer to:
- This document (E74.6-COMPLETE.md)
- RULES_VS_CHECKS_MATRIX.md (rules reference)
- Verification script: scripts/ci/verify-e74-6-patient-funnels.mjs

---

**Last Updated:** 2026-02-01  
**Status:** ✅ COMPLETE  
**Verification:** Run `npm run verify:e74-6`
