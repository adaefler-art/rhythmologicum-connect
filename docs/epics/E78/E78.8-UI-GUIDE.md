# E78.8 â€” UI Guide: Patient Reactivation Feature

## Overview
This guide demonstrates the patient reactivation UI in the Clinician Triage Inbox.

## UI Location
**File:** `/apps/rhythm-studio-ui/app/clinician/triage/page.tsx`  
**Route:** `/clinician/triage`

## Visual Flow

### 1. Archive/Active Toggle
Located at the top of the triage inbox:

```tsx
{/* Active/Archive Toggle */}
<div className="flex gap-2">
  <Button
    variant={showActive ? 'primary' : 'outline'}
    size="sm"
    onClick={() => setShowActive(true)}
    icon={<Inbox className="w-4 h-4" />}
  >
    Aktiv
  </Button>
  <Button
    variant={!showActive ? 'primary' : 'outline'}
    size="sm"
    onClick={() => setShowActive(false)}
    icon={<Archive className="w-4 h-4" />}
  >
    Archiv
  </Button>
</div>
```

**Visual:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Inbox                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Aktiv ]  [ Archiv ]                  â”‚ â† Toggle buttons
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Case List with Action Menu
Each case row has a "â‹¯" (More) button that opens an action dropdown:

```tsx
{/* Actions Column */}
{
  header: 'Aktionen',
  accessor: (row) => (
    <div className="relative">
      <Button
        variant="ghost"
        size="sm"
        onClick={(e) => toggleDropdown(row.case_id, e)}
        icon={<MoreHorizontal className="w-4 h-4" />}
      >
        <span className="sr-only">Aktionen Ã¶ffnen</span>
      </Button>
      
      {openDropdownId === row.case_id && (
        <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-50">
          {/* Dropdown menu items */}
        </div>
      )}
    </div>
  )
}
```

**Visual:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Patient:in      â”‚ Funnel   â”‚ Status  â”‚ Next Action â”‚ [ â‹¯ ]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Max Mustermann  â”‚ stress-1 â”‚ Closed  â”‚ None        â”‚ [ â‹¯ ] â—„â”€â”€â”¤ Click here
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Reactivation Button in Dropdown
When the dropdown is open, the "WiedererÃ¶ffnen" (Reopen) button is visible:

```tsx
{openDropdownId === row.case_id && (
  <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg z-50">
    <div className="py-1">
      {/* ... other action buttons ... */}
      
      <button
        onClick={(e) => handleRowAction('reopen', row, e)}
        className="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2"
      >
        <RotateCcw className="w-4 h-4" />
        WiedererÃ¶ffnen
      </button>
      
      {/* ... more action buttons ... */}
    </div>
  </div>
)}
```

**Visual:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚  âŠ™ BestÃ¤tigen                  â”‚
â”‚  âš‘ Markieren                   â”‚
â”‚  âœ• Markierung entfernen        â”‚
â”‚  ğŸ• ZurÃ¼ckstellen              â”‚
â”‚  âœ“ SchlieÃŸen                   â”‚
â”‚  â†» WiedererÃ¶ffnen         â—„â”€â”€â”€â”€â”¤ Reactivation button
â”‚  â˜ Notiz hinzufÃ¼gen            â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Reopen Action Handler
When clicked, the handler prompts for an optional reason:

```tsx
case 'reopen': {
  const reason = window.prompt('Grund (optional):')?.trim()
  result = await triageCaseReopen(
    triageCase.case_id,
    {
      ...(reason ? { reason } : {}),
    },
    triageCase.patient_id
  )
  break
}
```

**Visual:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Grund (optional):                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Patient wÃ¼nscht Fortsetzung      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚         [ Abbrechen ]  [ OK ]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. After Reactivation
After successfully reopening:
1. Case automatically moves from "Archiv" to "Aktiv" view
2. `is_active` becomes `true`
3. `next_action` is recalculated based on assessment state
4. Case appears in Active inbox with meaningful next action

**Visual - Before:**
```
Archive View:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Patient         â”‚ Status  â”‚ Next Action â”‚ Actions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Max Mustermann  â”‚ Closed  â”‚ None        â”‚ [ â‹¯ ]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Visual - After:**
```
Active View:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Patient         â”‚ Status      â”‚ Next Action           â”‚ ... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚ Max Mustermann  â”‚ In Progress â”‚ patient_continue      â”‚ ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Flow

```
User Action â†’ UI Handler â†’ API Endpoint â†’ Database â†’ View Refresh

1. User clicks "WiedererÃ¶ffnen"
   â†“
2. Optional reason prompt
   â†“
3. triageCaseReopen(caseId, { reason })
   â†“
4. POST /api/clinician/triage/cases/{caseId}/reopen
   â†“
5. Record action in triage_case_actions
   â†“
6. triage_cases_v1 view recalculates is_active = true
   â†“
7. UI reloads case list via loadTriageData()
   â†“
8. Case appears in Active view
```

## Code References

### UI Component
- **File:** `/apps/rhythm-studio-ui/app/clinician/triage/page.tsx`
- **Toggle:** Lines 894-911
- **Dropdown:** Lines 604-669
- **Reopen Button:** Lines 652-658
- **Handler:** Lines 466-476

### API Client
- **File:** `/apps/rhythm-studio-ui/lib/fetchClinician.ts`
- **Function:** `triageCaseReopen(caseId, payload, patientId)`

### API Endpoint
- **File:** `/apps/rhythm-studio-ui/app/api/clinician/triage/cases/[caseId]/reopen/route.ts`
- **Method:** POST
- **Payload:** `{ reason?: string }`

### Database View
- **File:** `/supabase/migrations/20260207042600_e78_5_effective_state_integration.sql`
- **View:** `triage_cases_v1`
- **Logic:** Lines 372-393 (is_active computation)

## Styling

The UI follows the application's design system:
- **Primary Color:** Blue for active states
- **Icons:** Lucide React icons
- **Dark Mode:** Full support with dark theme colors
- **Accessibility:** Screen reader labels, keyboard navigation
- **Responsive:** Mobile-friendly dropdown positioning

## Keyboard Navigation

- **Tab:** Navigate between buttons
- **Enter/Space:** Activate button
- **Escape:** Close dropdown (implied)
- **Arrow Keys:** Navigate dropdown items (browser default)

## User Experience

1. **Discoverability:** Reopen button always visible in dropdown menu
2. **Flexibility:** Available in both Active and Archive views
3. **Safety:** Optional reason helps document why case was reopened
4. **Feedback:** Case immediately moves to Active view after success
5. **Idempotency:** Safe to click multiple times (no-op if already open)

## Testing Checklist

- [ ] Navigate to `/clinician/triage`
- [ ] Verify "Archiv" button is visible
- [ ] Click "Archiv" to view archived cases
- [ ] Verify archived cases are displayed
- [ ] Click "â‹¯" action menu on any case
- [ ] Verify "WiedererÃ¶ffnen" button is visible
- [ ] Click "WiedererÃ¶ffnen"
- [ ] Verify reason prompt appears (optional)
- [ ] Submit with or without reason
- [ ] Verify case moves to "Aktiv" view
- [ ] Verify next_action is meaningful
- [ ] Check `triage_case_actions` table for logged action
