# E74.8 — Assessment Timeline View: Data Flow

## Component Architecture

```
┌─────────────────────────────────────────────────────────────┐
│          Clinician Patient Detail Page                      │
│          /clinician/patient/[id]/page.tsx                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────┐         │
│  │  Assessments Tab                                │         │
│  │                                                 │         │
│  │  ┌──────────────────────────────────┐          │         │
│  │  │  Assessment Card (Clickable)     │          │         │
│  │  │  - Funnel Name                   │◄─────────┼─────┐   │
│  │  │  - Status Badge                  │  Click   │     │   │
│  │  │  - Stress/Sleep Scores           │          │     │   │
│  │  │  - "Details →" indicator         │          │     │   │
│  │  └──────────────────────────────────┘          │     │   │
│  │                                                 │     │   │
│  │  [selectedAssessmentId state]                  │     │   │
│  │            │                                    │     │   │
│  │            ▼                                    │     │   │
│  │  ┌──────────────────────────────────┐          │     │   │
│  │  │  AssessmentRunDetails            │          │     │   │
│  │  │  Component                       │          │     │   │
│  │  │  - Fetches detail data           │          │     │   │
│  │  │  - Shows timeline                │          │     │   │
│  │  │  - Shows results                 │          │     │   │
│  │  │  - [Close] button                │──────────┼─────┘   │
│  │  └──────────────────────────────────┘          │         │
│  └────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## API Request Flow

```
┌──────────────────┐
│  Browser         │
│  (Client Side)   │
└────────┬─────────┘
         │
         │ 1. User clicks assessment
         │    setSelectedAssessmentId(id)
         │
         ▼
┌──────────────────────────────────┐
│  AssessmentRunDetails Component  │
│  - useEffect triggers on mount   │
│  - assessmentId from props       │
└────────┬─────────────────────────┘
         │
         │ 2. GET /api/clinician/assessments/[id]/details
         │
         ▼
┌────────────────────────────────────────────────┐
│  API Route Handler                             │
│  /api/clinician/assessments/[id]/details       │
├────────────────────────────────────────────────┤
│  1. Auth check (getUser)                       │
│  2. Role check (clinician/admin/nurse)         │
│  3. Query assessment + funnels                 │
│  4. Query answers + questions (LEFT JOIN)      │
│  5. Query calculated_results (OPTIONAL)        │
│  6. Query reports (OPTIONAL)                   │
│  7. Transform & combine data                   │
│  8. Return JSON response                       │
└────────┬───────────────────────────────────────┘
         │
         │ 3. Response with combined data
         │
         ▼
┌────────────────────────────────────┐
│  Database (Supabase PostgreSQL)    │
│  with RLS Policies                 │
├────────────────────────────────────┤
│  ┌──────────────┐                  │
│  │ assessments  │                  │
│  └──────┬───────┘                  │
│         │                          │
│         ├─► ┌──────────────────┐   │
│         │   │ funnels          │   │
│         │   └──────────────────┘   │
│         │                          │
│         ├─► ┌──────────────────┐   │
│         │   │ assessment_      │   │
│         │   │ answers          │   │
│         │   └────┬─────────────┘   │
│         │        │                 │
│         │        └─► ┌──────────┐  │
│         │            │questions │  │
│         │            └──────────┘  │
│         │                          │
│         ├─► ┌──────────────────┐   │
│         │   │ calculated_      │   │
│         │   │ results          │   │
│         │   └──────────────────┘   │
│         │                          │
│         └─► ┌──────────────────┐   │
│             │ reports          │   │
│             └──────────────────┘   │
│                                    │
│  RLS: Filters by organization_id   │
│  via patient → user context        │
└────────────────────────────────────┘
```

## Data Transformation Flow

```
┌─────────────────────────────────┐
│  Raw Database Response          │
├─────────────────────────────────┤
│                                 │
│  assessment: {                  │
│    id, patient_id, funnel,      │
│    funnel_id, status,           │
│    started_at, completed_at,    │
│    funnels: { slug, title }     │
│  }                              │
│                                 │
│  answersData: [{                │
│    id, question_id,             │
│    answer_value, answer_data,   │
│    created_at,                  │
│    questions: {                 │
│      id, question_text,         │
│      question_type              │
│    }                            │
│  }]                             │
│                                 │
│  resultData: {                  │
│    scores, risk_models,         │
│    algorithm_version,           │
│    computed_at                  │
│  }                              │
│                                 │
│  reportData: {                  │
│    score_numeric, sleep_score,  │
│    risk_level, report_text_...  │
│  }                              │
└────────┬────────────────────────┘
         │
         │ Transform
         ▼
┌─────────────────────────────────┐
│  Transformed Response           │
├─────────────────────────────────┤
│                                 │
│  {                              │
│    success: true,               │
│    data: {                      │
│      assessment: {              │
│        id,                      │
│        patientId,               │
│        funnelSlug,              │
│        funnelName,              │
│        status,                  │
│        startedAt,               │
│        completedAt              │
│      },                         │
│      answers: [{                │
│        id,                      │
│        questionId,              │
│        questionText,            │
│        questionType,            │
│        answerValue,             │
│        answerData,              │
│        createdAt                │
│      }],                        │
│      result: {                  │
│        scores,                  │
│        riskModels,              │
│        algorithmVersion,        │
│        computedAt               │
│      } | null,                  │
│      report: {                  │
│        scoreNumeric,            │
│        sleepScore,              │
│        riskLevel,               │
│        reportTextShort          │
│      } | null                   │
│    }                            │
│  }                              │
└────────┬────────────────────────┘
         │
         │ Parse & Display
         ▼
┌─────────────────────────────────┐
│  UI Component Render            │
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────────────┐  │
│  │ Assessment Header         │  │
│  │ - Funnel name             │  │
│  │ - Status badge            │  │
│  │ - Risk badge              │  │
│  │ - Start/completion dates  │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │ Result Summary            │  │
│  │ - Stress score            │  │
│  │ - Sleep score             │  │
│  │ - Report preview          │  │
│  │ - Algorithm version       │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │ Answers Timeline          │  │
│  │ - Question 1 + Answer 1   │  │
│  │ - Question 2 + Answer 2   │  │
│  │ - ...                     │  │
│  │ [Show all X answers]      │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
```

## Security & Access Control

```
┌──────────────────┐
│  API Request     │
└────────┬─────────┘
         │
         ▼
┌────────────────────────┐
│  Authentication Check  │
│  supabase.auth.getUser │
└────────┬───────────────┘
         │
         ├─── Not Authenticated ──► 401 Unauthorized
         │
         ▼
┌────────────────────────┐
│  Role Check            │
│  user.app_metadata.role│
└────────┬───────────────┘
         │
         ├─── Not Clinician/Admin/Nurse ──► 403 Forbidden
         │
         ▼
┌─────────────────────────────────┐
│  RLS Policy Enforcement         │
│  (Automatic via Supabase)       │
├─────────────────────────────────┤
│  Filters:                       │
│  - Patient organization_id      │
│    matches clinician org        │
│  - Only accessible patients     │
│                                 │
│  Prevents:                      │
│  - Cross-organization access    │
│  - Unauthorized patient data    │
└────────┬────────────────────────┘
         │
         ▼
┌────────────────────────┐
│  Data Access Granted   │
│  Return filtered data  │
└────────────────────────┘
```

## State Management

```
Patient Detail Page State:
┌──────────────────────────────────┐
│  selectedAssessmentId: null      │ ◄─── Initial state
└──────────────────────────────────┘
                │
                │ User clicks assessment
                ▼
┌──────────────────────────────────┐
│  selectedAssessmentId: "abc..."  │ ◄─── Selected
└──────────────────────────────────┘
                │
                │ Triggers conditional render
                ▼
┌──────────────────────────────────┐
│  <AssessmentRunDetails>          │
│    assessmentId={selected}       │
│    onClose={clear}               │
│  />                              │
└──────────────────────────────────┘
                │
                │ User clicks "Schließen"
                ▼
┌──────────────────────────────────┐
│  selectedAssessmentId: null      │ ◄─── Back to list
└──────────────────────────────────┘
```

## Error Handling Flow

```
┌────────────────────┐
│  API Request       │
└─────────┬──────────┘
          │
          ▼
     [Try Block]
          │
          ├──► Assessment Query
          │         │
          │         ├─── Error ──► 404 Not Found
          │         │
          │         ▼
          ├──► Answers Query
          │         │
          │         ├─── Error ──► Log & Continue (graceful)
          │         │
          │         ▼
          ├──► Results Query
          │         │
          │         ├─── Error (not PGRST116) ──► Log & Continue
          │         │
          │         ▼
          └──► Report Query
                    │
                    ├─── Error (not PGRST116) ──► Log & Continue
                    │
                    ▼
            [Transform & Return]
                    │
                    ▼
            ┌────────────────┐
            │  200 Success   │
            └────────────────┘

     [Catch Block]
          │
          ▼
   ┌───────────────────┐
   │  500 Internal     │
   │  Generic Error    │
   └───────────────────┘
```
