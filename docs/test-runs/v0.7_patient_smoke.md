# v0.7 Patient Smoke Pack â€” Test Run Documentation

**Epic:** I2 â€” Patient Smoke Pack v0.7  
**Date:** 2026-01-26  
**Version:** v0.7  
**Test Type:** Manual Smoke Test  
**Status:** ğŸŸ¡ Pending Execution

---

## Purpose

Provide a reproducible test run for Epic 2 acceptance, ensuring the Assessment Handoff Contract (I72.6) is properly integrated with AMY Orchestrator. This test validates that AMY can reliably handle different assessment states without requiring a fully implemented assessment flow.

---

## Scope

### In Scope
- **I72.6 Assessment Handoff Contract**: Verify `lastAssessment` integration in PatientState
- **AMY Orchestrator Routing**: Validate AMY decision logic based on assessment status
- **Patient Flow**: Test dashboard â†’ triage â†’ assessment routing
- **State Management**: Confirm patient state correctly reflects assessment status

### Out of Scope
- Full assessment implementation (only handoff contract)
- Detailed AMY conversational AI
- Performance testing
- Cross-browser compatibility

---

## Intent

Make E72 (AMY/Triage) robust against the current assessment state by:
1. Reading `lastAssessment` from PatientState
2. Routing based on status:
   - **none**: Suggest "Start Assessment" action
   - **in_progress**: Suggest "Continue" action
   - **completed**: Can trigger "Insights/Next Step/Content"
3. Avoiding fake results when no assessment exists
4. No new assessment logic - just read and route

---

## Test Environment

**Prerequisites:**
- Local development environment running
- Supabase instance available
- Test patient account created
- Environment variables configured

**Setup Commands:**
```bash
npm run preflight   # Verify guardrails
npm run build       # Build application
npm run dev         # Start dev server
```

**Canonical URLs:**
- Patient Dashboard: `http://localhost:3000/patient/dashboard`
- AMY Triage: `http://localhost:3000/api/amy/triage` (POST)
- Patient State: `http://localhost:3000/api/patient/state` (GET/POST)

---

## Test Cases

### TC1: No Assessment State (not_started)

**Setup:**
1. Create or use test patient with no assessments
2. Clear patient state if exists

**Steps:**
1. Login as patient
2. Navigate to dashboard
3. Trigger AMY triage with text: "Ich habe Stress"
4. Observe triage response

**Expected:**
- âœ… Triage returns `nextAction: "start_funnel_a"`
- âœ… No fake assessment results shown
- âœ… Patient state shows `status: "not_started"`
- âœ… AMY suggests starting assessment
- âœ… No errors in console

**Actual:**
_[To be filled during test execution]_

**Result:** â˜ Pass | â˜ Fail

---

### TC2: In-Progress Assessment

**Setup:**
1. Create test patient
2. Start an assessment but don't complete it
3. Update patient state with:
   ```json
   {
     "assessment": {
       "lastAssessment": {
         "status": "in_progress",
         "funnelSlug": "stress-assessment",
         "updatedAt": "2026-01-26T10:00:00Z",
         "answersCount": 5,
         "reportId": null
       }
     }
   }
   ```

**Steps:**
1. Login as patient
2. Navigate to dashboard
3. Trigger AMY triage with text: "Wie geht es weiter?"
4. Observe triage response

**Expected:**
- âœ… Triage recognizes in-progress state
- âœ… Returns `nextAction: "start_funnel_a"` (continue assessment)
- âœ… Frontend shows "Continue" button (implementation detail)
- âœ… No duplicate assessment started
- âœ… No errors in console

**Actual:**
_[To be filled during test execution]_

**Result:** â˜ Pass | â˜ Fail

---

### TC3: Completed Assessment

**Setup:**
1. Create test patient
2. Complete an assessment
3. Update patient state with:
   ```json
   {
     "assessment": {
       "lastAssessment": {
         "status": "completed",
         "funnelSlug": "stress-assessment",
         "updatedAt": "2026-01-25T15:00:00Z",
         "answersCount": 15,
         "reportId": "uuid-of-report"
       }
     }
   }
   ```

**Steps:**
1. Login as patient
2. Navigate to dashboard
3. Trigger AMY triage with text: "Was sind meine Ergebnisse?"
4. Observe triage response

**Expected:**
- âœ… Triage recognizes completed state
- âœ… Returns `nextAction: "show_content"` (insights/next step)
- âœ… Can access insights or results
- âœ… AMY can reference existing assessment
- âœ… No errors in console

**Actual:**
_[To be filled during test execution]_

**Result:** â˜ Pass | â˜ Fail

---

### TC4: Assessment Handoff Contract Validation

**Setup:**
1. Test patient with various assessment states

**Steps:**
1. Verify `AssessmentSummarySchema` in contract
2. Check patient state includes `lastAssessment`
3. Validate schema accepts all required fields
4. Test partial updates to assessment state

**Expected:**
- âœ… Schema exports `AssessmentSummary` type
- âœ… Fields: `status`, `funnelSlug`, `updatedAt`, `answersCount`, `reportId`
- âœ… Validation passes for valid data
- âœ… Validation fails for invalid data
- âœ… Helper function `buildAssessmentSummary` exists

**Actual:**
_[To be filled during test execution]_

**Result:** â˜ Pass | â˜ Fail

---

### TC5: Build & Verification

**Steps:**
1. Run `npm run build`
2. Run `npm run verify`
3. Run `npm run verify:ui-v2`
4. Check for errors

**Expected:**
- âœ… Build completes without errors
- âœ… All verification scripts pass
- âœ… No TypeScript errors
- âœ… RLS policies pass
- âœ… Endpoint catalog valid

**Actual:**
_[To be filled during test execution]_

**Result:** â˜ Pass | â˜ Fail

---

## Test Artifacts

### Screenshots
- [ ] Dashboard with no assessment state
- [ ] Dashboard with in-progress assessment
- [ ] Dashboard with completed assessment
- [ ] AMY triage response samples

### Logs
- [ ] Browser console logs (errors/warnings)
- [ ] Server logs for triage endpoint
- [ ] Patient state fetch logs

### Database State
- [ ] Patient state table records
- [ ] Assessment table records
- [ ] Triage session records

---

## Deviations

### Expected Deviations
_[Document any expected differences from ideal behavior]_

### Unexpected Issues
_[Document any bugs or unexpected behavior found during testing]_

---

## Acceptance Decision

### Criteria Checklist
- [ ] TC1: No assessment state routing works
- [ ] TC2: In-progress assessment routing works
- [ ] TC3: Completed assessment routing works
- [ ] TC4: Assessment handoff contract validated
- [ ] TC5: Build and verification pass
- [ ] No critical errors or crashes
- [ ] Patient state correctly reflects assessment status
- [ ] AMY routing decisions are deterministic
- [ ] No fake results when no assessment exists

### Final Decision
â˜ **PASS** â€” All criteria met, Epic 2 accepted  
â˜ **FAIL** â€” Criteria not met, issues need resolution  
â˜ **CONDITIONAL PASS** â€” Minor issues documented, acceptable for v0.7

**Tester:** _[Name]_  
**Date:** _[Date]_  
**Notes:**
_[Additional comments or observations]_

---

## Guardrails Verification

### Pre-Implementation Evidence
```
âœ… Endpoint catalog verified successfully
âš ï¸  WARNINGS (3 deprecated objects detected) - Expected, non-blocking
âœ… Migration lint passed
âŒ Supabase not installed locally - Expected in CI environment
```

### Post-Implementation Evidence
_[Paste output of `npm run preflight` after implementation]_

### RLS Verification
```bash
# R-DB-009: RLS verify must pass
# [Paste RLS verification output]
```

### Typegen Verification
```bash
# R-DB-007: Typegen verify must pass
npm run db:typegen:verify
# [Paste typegen verification output]
```

### Endpoint Wiring
```bash
# Verify no orphan endpoints
npm run api:catalog:verify
# [Paste endpoint catalog verification output]
```

---

## References

- **Issue:** [I2.6] v0.7 Patient Smoke Pack: Testlauf (Template) + optional Playwright Smoke
- **Related Epic:** I72.6 â€” Assessment Handoff Contract
- **Contract:** `lib/api/contracts/patient/state.ts` - AssessmentSummary
- **Engine:** `lib/triage/engine.ts` - AMY Orchestrator routing
- **Route:** `apps/rhythm-legacy/app/api/amy/triage/route.ts` - Patient state fetch

---

## Execution Log

**Test Run #1**  
**Date:** _[Date]_  
**Environment:** Local Development  
**Tester:** _[Name]_

_[Document test execution results, observations, and any issues encountered]_

---

**End of Test Run Documentation**
