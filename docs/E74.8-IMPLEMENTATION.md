# E74.8 — Clinician View v1: Funnel Run Timeline + Answers + Result Summary

## Overview

This feature provides clinicians with a comprehensive view of patient assessment runs, including a detailed timeline of answers, result summaries, and metadata.

## Implementation Summary

### Components

#### 1. API Endpoint: `/api/clinician/assessments/[assessmentId]/details`

**Location**: `apps/rhythm-studio-ui/app/api/clinician/assessments/[assessmentId]/details/route.ts`

**Purpose**: Fetches comprehensive assessment data for clinician review

**Authorization**:
- Requires authenticated user
- Role-based access: `clinician`, `admin`, or `nurse`
- Organization-scoped via RLS policies

**Response Structure**:
```typescript
{
  success: true,
  data: {
    assessment: {
      id: string
      patientId: string
      funnelSlug: string | null
      funnelName: string
      status: string
      startedAt: string
      completedAt: string | null
    }
    answers: [{
      id: string
      questionId: string
      questionText: string
      questionType: string | null
      answerValue: number
      answerData: unknown
      createdAt: string
    }]
    result: {
      scores: Record<string, unknown>
      riskModels: Record<string, unknown> | null
      algorithmVersion: string
      computedAt: string
    } | null
    report: {
      scoreNumeric: number
      sleepScore: number
      riskLevel: string
      reportTextShort: string
    } | null
  }
}
```

**Data Flow**:
1. Validates authentication and role
2. Fetches assessment metadata with funnel info
3. Fetches all answers with joined question details
4. Fetches calculated results (if available)
5. Fetches report data (if available)
6. Transforms and returns combined data

#### 2. UI Component: `AssessmentRunDetails`

**Location**: `apps/rhythm-studio-ui/app/clinician/patient/[id]/AssessmentRunDetails.tsx`

**Purpose**: Displays comprehensive assessment details with timeline view

**Features**:
- **Assessment Header**: Shows funnel name, status badges, start/completion dates
- **Result Summary**: Displays stress/sleep scores, risk level, report preview, algorithm version
- **Answers Timeline**: Chronological list of questions and answers
  - Default view: First 5 answers
  - Expandable: "Show all X answers" button
  - Each answer shows question text, response, timestamp, and sequence number
- **Loading State**: Spinner with "Lade Details..." message
- **Error State**: User-friendly error display with retry option
- **Close Action**: Returns to assessment list view

**Props**:
```typescript
{
  assessmentId: string
  onClose?: () => void
}
```

#### 3. Integration: Patient Detail Page

**Location**: `apps/rhythm-studio-ui/app/clinician/patient/[id]/page.tsx`

**Changes**:
- Added import for `AssessmentRunDetails` component
- Added state: `selectedAssessmentId: string | null`
- Made assessment cards interactive with click handlers
- Conditional rendering: Shows detail view when assessment is selected
- Added "Details →" visual indicator on assessment cards

## User Flow

1. Clinician navigates to patient detail page
2. Views list of completed assessments with results
3. Clicks on an assessment card
4. Sees detailed view with:
   - Assessment metadata and status
   - Result summary with scores and risk level
   - Full timeline of all questions and answers
   - Report preview
5. Clicks "Schließen" (Close) to return to list view

## Technical Details

### Security

- **RBAC**: Server-side role check before data access
- **RLS**: Organization-scoped data filtering via Supabase RLS policies
- **Error Handling**: No sensitive information in error messages
- **Type Safety**: Proper TypeScript types for all data structures

### Performance

- **Lazy Loading**: Detail view only fetches data when clicked
- **Expandable Lists**: Shows first 5 answers by default to reduce initial render time
- **Efficient Queries**: Single query with joins for answers + questions
- **Caching**: Browser caching for repeated views (via fetch)

### Localization

- All dates formatted with German locale (`de-DE`)
- German language labels and messages
- Risk level translations (Hoch/Mittel/Niedrig)
- Status translations (Abgeschlossen/In Bearbeitung)

### Accessibility

- Semantic HTML structure
- Proper ARIA labels for icons
- Keyboard navigation support via interactive cards
- Loading/error states with descriptive text

## Database Schema

### Tables Used

1. **assessments**
   - `id`, `patient_id`, `funnel`, `funnel_id`, `status`, `started_at`, `completed_at`

2. **assessment_answers**
   - `id`, `assessment_id`, `question_id`, `answer_value`, `answer_data`, `created_at`

3. **questions**
   - `id`, `question_text`, `question_type`

4. **calculated_results**
   - `id`, `assessment_id`, `scores`, `risk_models`, `algorithm_version`, `computed_at`

5. **reports**
   - `score_numeric`, `sleep_score`, `risk_level`, `report_text_short`

6. **funnels**
   - `slug`, `title`

### Query Strategy

- **Joins**: Left joins for optional data (results, reports)
- **Ordering**: Answers ordered by `created_at` ascending for chronological timeline
- **Error Handling**: Graceful degradation if results/reports missing

## Testing Checklist

- [x] Build compiles successfully
- [x] No TypeScript errors
- [x] No ESLint errors
- [x] Code review feedback addressed
- [ ] Manual testing with real data
- [ ] RBAC verification (non-clinician cannot access)
- [ ] RLS verification (cross-organization access blocked)
- [ ] UI responsive design verification
- [ ] Dark mode compatibility
- [ ] Loading states work correctly
- [ ] Error states work correctly

## Future Enhancements

### Potential Improvements

1. **Processing Status**: Add indicators for assessments being processed
2. **Export Functionality**: Allow exporting assessment details to PDF/JSON
3. **Comparison View**: Compare multiple assessments side-by-side
4. **Filtering**: Filter answers by question type or score ranges
5. **Notes**: Allow clinicians to add notes to specific answers
6. **Highlighting**: Mark important answers or concerning patterns
7. **Timeline Visualization**: Graphical timeline view of assessment completion
8. **Real-time Updates**: WebSocket updates for processing status changes

### Known Limitations

1. No pagination for answers (all loaded at once)
2. No search/filter within answers
3. No export functionality
4. No comparison between assessments
5. No clinician notes or annotations

## Maintenance Notes

### Code Patterns

- Follow existing Supabase client patterns (`createServerSupabaseClient`)
- Use established UI component library (`@/lib/ui`)
- German locale for all user-facing text
- Consistent error handling with PHI-safe messages
- Type safety with explicit interfaces

### Dependencies

- Supabase client libraries
- Next.js App Router
- React hooks (useState, useEffect)
- Lucide React icons
- TailwindCSS for styling

### Documentation

- JSDoc comments for all public functions
- Inline comments for complex logic
- Type definitions for all data structures
- README for implementation summary

## References

- **Issue**: E74.8 - Clinician View v1: Funnel Run Timeline + Answers + Result Summary
- **Related**: E73.5 - SSOT for Patient Assessments with Results
- **API Docs**: See endpoint documentation in route file
- **Component Docs**: See JSDoc comments in component files
