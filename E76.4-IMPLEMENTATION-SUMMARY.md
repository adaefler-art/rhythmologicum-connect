# E76.4 — Execution Worker Implementation Summary

**Issue:** E76.4 — Execution Worker: Diagnose-Run ausführen + Artefakt persistieren  
**Status:** ✅ Complete  
**Date:** 2026-02-03

---

## Overview

Implemented a worker endpoint for executing queued diagnosis runs with:
- **State machine enforcement** - Only 'queued' runs can be executed
- **Concurrency protection** - Prevents double execution
- **Context pack retrieval** - Fetches comprehensive patient data
- **LLM integration** - Uses Anthropic Claude for diagnosis
- **Schema validation** - Validates diagnosis JSON structure
- **Artifact persistence** - Stores diagnosis results
- **Error handling** - Sets status to 'failed' with error details
- **Feature flag** - Gated behind DIAGNOSIS_WORKER_ENABLED (default: false)

---

## Implementation Details

### 1. Worker API Endpoint

**File:** `apps/rhythm-studio-ui/app/api/studio/diagnosis-runs/[runId]/execute/route.ts`

**Endpoint:** POST /api/studio/diagnosis-runs/{runId}/execute

**Workflow:**
```
1. Validate authentication (clinician/admin only)
2. Validate UUID format
3. Fetch diagnosis run (RLS enforced)
4. Concurrency check: Verify status is 'queued'
5. Transition to 'running' status
6. Try:
   a. Build patient context pack
   b. Call LLM for diagnosis
   c. Validate diagnosis JSON schema
   d. Persist artifact
   e. Link artifact to run
   f. Mark run as 'succeeded'
7. Catch errors:
   a. Set run status to 'failed'
   b. Store error_info with error code
   c. Return appropriate error response
```

**Concurrency Protection:**
```typescript
// Read-time check
if (run.status !== 'queued') {
  return conflictResponse(...)
}

// Write-time check (prevents race conditions)
await supabase
  .from('diagnosis_runs')
  .update({ status: 'running', ... })
  .eq('id', runId)
  .eq('status', 'queued') // Only update if still queued
```

**Diagnosis Schema:**
```typescript
interface DiagnosisResult {
  summary: string                    // Required
  findings: string[]                 // Required
  recommendations: string[]          // Required
  risk_level?: 'low' | 'moderate' | 'high' | 'critical'
  confidence_score?: number          // 0.0 to 1.0
}
```

**Error Codes:**
- `VALIDATION_ERROR` - Invalid diagnosis JSON schema
- `EXECUTION_ERROR` - General execution failure (LLM, DB, etc.)

---

### 2. Feature Flag

**File:** `lib/featureFlags.ts`

**Flag:** `DIAGNOSIS_WORKER_ENABLED`

**Environment Variable:** `NEXT_PUBLIC_FEATURE_DIAGNOSIS_WORKER_ENABLED`

**Default:** `false` (disabled by default)

**Usage:**
```typescript
export type FeatureFlags = {
  // ...
  DIAGNOSIS_WORKER_ENABLED: boolean
}

export const featureFlags: FeatureFlags = {
  // ...
  DIAGNOSIS_WORKER_ENABLED: resolveFlag(
    env.NEXT_PUBLIC_FEATURE_DIAGNOSIS_WORKER_ENABLED,
    false,
  ),
}
```

---

### 3. Literal Callsite

**File:** `apps/rhythm-studio-ui/components/studio/DiagnosisRunsPanel.tsx`

**Strategy A Compliance:**
```typescript
// E76.4: POST /api/studio/diagnosis-runs/{runId}/execute
const executeRun = async (runId: string) => {
  setLoading(true)
  setError(null)
  try {
    const response = await fetch(`/api/studio/diagnosis-runs/${runId}/execute`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    })
    const data = await response.json()
    if (data.success) {
      alert(`Run executed successfully. Status: ${data.data.run.status}`)
      fetchRun(runId)
      fetchRuns()
    } else {
      setError(data.error?.message || 'Failed to execute run')
    }
  } catch (err) {
    setError('Network error executing run')
  } finally {
    setLoading(false)
  }
}
```

**UI Integration:**
- "Execute" button appears only for runs with status='queued'
- Button is disabled while loading
- Success triggers refresh of run details and runs list
- Errors displayed in error banner

---

### 4. Verification Script

**File:** `scripts/ci/verify-e76-4-worker.mjs`

**Purpose:** Automated verification of E76.4 requirements

**Checks:**
1. ✅ Worker endpoint exists
2. ✅ Literal callsite exists
3. ✅ Feature flag exists
4. ✅ Rules vs. Checks Matrix exists
5. ✅ Status validation implemented
6. ✅ Running transition implemented
7. ✅ Context pack builder called
8. ✅ Diagnosis validation implemented
9. ✅ Artifact persistence implemented
10. ✅ Error handling implemented

**Usage:**
```bash
npm run verify:e76-4
```

**Exit Codes:**
- `0` - All guardrails satisfied
- `1` - Violations found (outputs "violates R-E76.4-XXX")
- `2` - Script error

---

### 5. Rules vs. Checks Matrix

**File:** `docs/e7/E76_4_RULES_VS_CHECKS_MATRIX.md`

**Purpose:** Bidirectional traceability between rules and checks

**Coverage:**
- **20 rules** defined
- **20 checks** implemented
- **100% coverage**
- **0 orphan checks**
- **0 rules without checks**

**Check Types:**
- Code Review: 17
- Code Search: 1
- CI Script: 2

---

## Security Considerations

### Access Control
1. **Authentication Required**
   - All requests must have valid Supabase session
   - Endpoint returns 401 Unauthorized if not authenticated

2. **Authorization Required**
   - Only clinicians and admins can execute runs
   - Checked via `hasAdminOrClinicianRole()`
   - Returns 403 Forbidden if not authorized

3. **RLS Enforcement**
   - Database queries automatically filtered by RLS policies
   - Clinicians can only access runs for assigned patients
   - Admins can access all runs in their organization

### Data Protection
1. **Sensitive Data Handling**
   - Context pack built using admin client (bypasses RLS for comprehensive data)
   - Justification: Clinician/admin endpoint requires cross-patient access for diagnosis
   - LLM API key stored in environment variable (not in code)

2. **Error Information**
   - Error messages sanitized to prevent information leakage
   - Full error details stored in `error_info` JSONB field (RLS protected)
   - Request IDs logged for audit trail

### Concurrency Protection
1. **Read-Time Check**
   - Validates run status before execution attempt
   - Returns 409 Conflict if not in 'queued' status

2. **Write-Time Check**
   - UPDATE query includes `.eq('status', 'queued')`
   - Prevents race condition if two workers attempt execution simultaneously
   - Only one worker will successfully transition to 'running'

---

## Testing Strategy

### Automated Verification
```bash
# Run E76.4 verification script
npm run verify:e76-4

# Expected output: ✅ All E76.4 guardrails satisfied
```

### Manual Testing Checklist
1. ☐ Create a diagnosis run (status: 'queued')
2. ☐ Execute the run via API endpoint
3. ☐ Verify run transitions to 'running' then 'succeeded'
4. ☐ Verify artifact is created and linked to run
5. ☐ Verify diagnosis result is stored in artifact_data
6. ☐ Test with invalid LLM response → verify status='failed' with VALIDATION_ERROR
7. ☐ Test with LLM API error → verify status='failed' with EXECUTION_ERROR
8. ☐ Test concurrency: Execute same run twice → verify only one succeeds
9. ☐ Test executing non-queued run → verify 409 Conflict response
10. ☐ Test without authentication → verify 401 Unauthorized
11. ☐ Test with non-clinician role → verify 403 Forbidden
12. ☐ Verify feature flag hides execute button when disabled

### Test Scenarios

#### Success Case
```
Input: Queued run with valid patient data
Expected:
- Run status: queued → running → succeeded
- Artifact created with diagnosis data
- Artifact linked to run
- output_data contains artifact_id and diagnosis
```

#### Validation Error Case
```
Input: LLM returns invalid JSON (missing required fields)
Expected:
- Run status: queued → running → failed
- error_info contains:
  - error_code: 'VALIDATION_ERROR'
  - validation_errors: [list of validation errors]
  - raw_response: original LLM response
```

#### Execution Error Case
```
Input: LLM API key missing or invalid
Expected:
- Run status: queued → running → failed
- error_info contains:
  - error_code: 'EXECUTION_ERROR'
  - message: error description
  - timestamp: error time
```

#### Concurrency Test
```
Input: Execute same run ID from two workers simultaneously
Expected:
- First worker: transitions to running, executes successfully
- Second worker: receives 409 Conflict (run no longer queued)
```

---

## API Examples

### Success Response
```json
{
  "success": true,
  "data": {
    "run": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "status": "succeeded",
      "artifact_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7"
    }
  },
  "requestId": "req-abc123"
}
```

### Validation Error Response
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Diagnosis validation failed",
    "errors": [
      "summary is required and must be a string",
      "findings is required and must be an array"
    ]
  },
  "requestId": "req-def456"
}
```

### Conflict Response (Already Executed)
```json
{
  "success": false,
  "error": {
    "code": "CONFLICT",
    "message": "Run is not in 'queued' status (current: running)"
  },
  "requestId": "req-ghi789"
}
```

---

## Future Enhancements

### Optional Features (Out of Scope for E76.4)
1. **Retry Logic**
   - Automatic retry for transient LLM failures
   - Exponential backoff strategy
   - Max retry limit

2. **Async Processing**
   - Queue-based execution (e.g., BullMQ, AWS SQS)
   - Webhook notifications on completion
   - WebSocket real-time status updates

3. **Advanced Validation**
   - Confidence score thresholds
   - Risk level consistency checks
   - Findings/recommendations quality checks

4. **Artifact Versioning**
   - Multiple diagnosis attempts for same run
   - Version tracking with sequence_order
   - Comparison between versions

5. **Performance Optimization**
   - Cache context packs by patient_id + hash
   - Batch execution of multiple queued runs
   - Parallel processing with worker pool

---

## Deployment Guide

### Prerequisites
1. Anthropic API key configured in environment:
   ```
   ANTHROPIC_API_KEY=sk-ant-xxx
   ```

2. Feature flag enabled (optional, for testing):
   ```
   NEXT_PUBLIC_FEATURE_DIAGNOSIS_WORKER_ENABLED=true
   ```

### Deployment Steps
1. Deploy code to environment

2. Verify environment variables:
   ```bash
   # Check Anthropic API key is set
   echo $ANTHROPIC_API_KEY
   ```

3. Run verification script:
   ```bash
   npm run verify:e76-4
   ```

4. Test with feature flag enabled:
   - Navigate to patient detail page with `?enableDiagnosisRuns`
   - Create a test run
   - Execute the run
   - Verify artifact is created

5. Monitor execution:
   - Check application logs for errors
   - Monitor run status transitions
   - Verify artifacts are being created

### Rollback Plan
If issues are found:
1. Disable feature flag:
   ```
   NEXT_PUBLIC_FEATURE_DIAGNOSIS_WORKER_ENABLED=false
   ```

2. Execute button will no longer appear in UI

3. Existing queued runs remain in database for later execution

4. No data loss - runs can be executed once issues are resolved

---

## Acceptance Criteria

✅ **All acceptance criteria met:**

- [x] Run verarbeitet (executes queued runs)
- [x] Artefakt geschrieben (persists diagnosis artifact)
- [x] Invalides Ergebnis: Status failed mit VALIDATION_ERROR
- [x] If an API route is introduced/changed: at least one in-repo literal callsite exists
- [x] Endpoint wiring gate shows no orphan for this endpoint (verify:e76-4 passes)
- [x] Rules vs. Checks Matrix exists (E76_4_RULES_VS_CHECKS_MATRIX.md)
- [x] Each rule has a check implementation
- [x] Each check references a rule ID
- [x] Check output contains "violates R-E76.4-XXX" on failure

---

## Files Changed

### New Files
1. `apps/rhythm-studio-ui/app/api/studio/diagnosis-runs/[runId]/execute/route.ts` - Worker endpoint
2. `scripts/ci/verify-e76-4-worker.mjs` - Verification script
3. `docs/e7/E76_4_RULES_VS_CHECKS_MATRIX.md` - Rules vs. Checks Matrix

### Modified Files
1. `lib/featureFlags.ts` - Added DIAGNOSIS_WORKER_ENABLED flag
2. `lib/env.ts` - Added NEXT_PUBLIC_FEATURE_DIAGNOSIS_WORKER_ENABLED
3. `apps/rhythm-studio-ui/components/studio/DiagnosisRunsPanel.tsx` - Added execute callsite
4. `package.json` - Added verify:e76-4 script

**Total:** 3 new files, 4 modified files

---

## Related Issues

- **E76.1** - MCP Server integration (LLM foundation)
- **E76.2** - Patient Context Pack builder (data source)
- **E76.3** - Diagnosis Runs API (state machine + CRUD)
- **E76.4** - Execution Worker (this implementation)

---

**Implementation Date:** 2026-02-03  
**Implemented By:** GitHub Copilot  
**Reviewed By:** Pending  
**Status:** ✅ Ready for Review
