name: DB Migrations CI — apply & schema check

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'prisma/**'
      - 'schema.sql'
      - '.github/**'
      - 'src/**'

jobs:
  migrations-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    env:
      PGHOST: 127.0.0.1
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: postgres

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" && break
            sleep 1
          done

      - name: Apply migrations (ordered)
        run: |
          set -euo pipefail
          # If you use supabase migrations naming, ensure files are applied in lexicographic order
          if [ -d "supabase/migrations" ]; then
            for f in $(ls supabase/migrations/*.sql | sort); do
              echo "Applying $f"
              psql "host=$PGHOST port=$PGPORT user=$PGUSER password=$PGPASSWORD dbname=$PGDATABASE" -f "$f"
            done
          else
            echo "No supabase/migrations dir found -> skipping migration run"
          fi

      - name: Dump schema (no owner/privileges)
        run: |
          pg_dump -s --no-owner --no-privileges -h $PGHOST -U $PGUSER $PGDATABASE > generated_schema.sql
          echo "Generated schema written to generated_schema.sql"

      - name: Compare generated schema with repo schema.sql
        run: |
          if [ ! -f schema.sql ]; then
            echo "schema.sql not found in repo — please maintain a canonical schema.sql via 'pg_dump -s' after migrations'"
            exit 1
          fi
          diff -u <(sed '/^--/d' generated_schema.sql | sed '/^$/d') <(sed '/^--/d' schema.sql | sed '/^$/d') || (echo "Schema drift detected: generated schema differs from schema.sql" && exit 1)

      - name: Run DB‑dependent tests (optional)
        if: always()
        run: |
          # Optional: add commands to run tests that rely on DB schema (e.g. npm ci && npm test)
          echo "Add project-specific tests here (skipped by default)"
