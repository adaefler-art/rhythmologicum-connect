name: DB Determinism Check

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'lib/types/supabase.ts'
      - 'schema/**'
      - 'docs/canon/DB_SCHEMA_MANIFEST.json'
      - '.github/workflows/db-determinism.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  db-determinism:
    name: Verify migrations, drift, and types
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for migration checks
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 2.63.1
      
      - name: Setup PowerShell
        run: |
          echo "âœ… PowerShell is already available on Ubuntu"
          pwsh --version
      
      # Check 0a: Test linter with fixtures (deterministic tests)
      - name: Test migration linter
        run: |
          echo "ğŸ§ª Running linter test suite..."
          pwsh -File scripts/db/test-linter.ps1
          echo "âœ… Linter tests passed"
      
      # Check 0b: Lint migrations against canonical schema manifest (V0.5+)
      - name: Lint migrations against schema manifest
        run: |
          echo "ğŸ” Linting migrations against canonical schema manifest..."
          pwsh -File scripts/db/lint-migrations.ps1
          echo "âœ… All migrations use canonical schema objects"
      
      # Check 1: Ensure no existing migrations were edited
      - name: Check migration immutability
        run: |
          echo "ğŸ” Checking migration immutability..."
          
          # Find merge base with target branch
          MERGE_BASE=$(git merge-base origin/${{ github.base_ref }} HEAD)
          echo "Merge base: $MERGE_BASE"
          
          # Check for modified migrations
          MODIFIED_MIGRATIONS=$(git diff --name-status $MERGE_BASE...HEAD -- supabase/migrations/*.sql | grep -v '^A' || true)
          
          if [ -n "$MODIFIED_MIGRATIONS" ]; then
            echo "âŒ ERROR: Existing migration files were modified:"
            echo "$MODIFIED_MIGRATIONS" | while IFS=$'\t' read -r status file; do
              echo "  [$status] $file"
            done
            echo ""
            echo "Migrations are append-only. Create a new migration instead of editing existing ones."
            echo "If this is an emergency hotfix, set ALLOW_MIGRATION_EDITS=1"
            exit 1
          fi
          
          echo "âœ… All migration changes are new additions"
        env:
          ALLOW_MIGRATION_EDITS: '0'

      - name: Lint new migrations for idempotency
        run: |
          echo "ğŸ” Linting new migrations for idempotency guard rails..."
          bash scripts/lint-new-migrations-idempotency.sh "origin/${{ github.base_ref }}"
      
      # Check 2: Start Supabase with clear lifecycle
      - name: Start Supabase local instance
        run: |
          echo "ğŸš€ Starting Supabase local instance..."
          supabase start
          echo ""
          echo "ğŸ“Š Supabase Status:"
          supabase status
          echo ""
      
      - name: Apply migrations
        run: |
          echo "ğŸ“¦ Applying all migrations via db reset..."
          supabase db reset
          echo "âœ… Migrations applied successfully"

      - name: Verify seed invariants
        run: |
          echo "ğŸ”’ Verifying baseline seed invariants..."
          pwsh -File scripts/db/verify-seed-invariants.ps1
          echo "âœ… Seed invariants satisfied"
      
      - name: Verify RLS policies on user data tables
        run: |
          echo "ğŸ”’ Verifying RLS policies (R-DB-009)..."
          pwsh -File scripts/db/verify-rls-policies.ps1
          echo "âœ… RLS policies verified"
      
      - name: Upload RLS verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rls-verification
          path: artifacts/rls-verify/
          retention-days: 30
      
      # Check 3: Verify no schema drift
      - name: Check for schema drift
        run: |
          echo "ğŸ” Checking for drift between migrations and actual schema..."
          DIFF_OUTPUT=$(supabase db diff --local 2>&1 || true)
          echo "$DIFF_OUTPUT"

          if echo "$DIFF_OUTPUT" | grep -Eqi 'No schema changes (found|detected)'; then
            echo "âœ… No schema drift detected"
            exit 0
          fi

          echo ""
          echo "âŒ Schema drift detected!"
          echo "This means there are database changes not captured in migrations."
          echo "Please create a new migration to capture these changes."
          echo ""
          exit 1
      
      # Check 4: Verify types match (deterministic hard gate)
      - name: Verify TypeScript types are deterministic
        run: |
          echo "ğŸ” Verifying types match committed version (deterministic hard gate)..."
          pwsh -File scripts/db/typegen.ps1 -Verify
          echo "âœ… Types are deterministic and up to date"
      
      # Success summary
      - name: Success summary
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ All DB determinism checks passed!"
          echo "   âœ… Linter tests passed (fixtures validated)"
          echo "   âœ… All schema objects are canonical"
          echo "   âœ… No existing migrations were edited"
          echo "   âœ… Migrations apply cleanly"
          echo "   âœ… Seed invariants satisfied"
          echo "   âœ… RLS policies verified (R-DB-009)"
          echo "   âœ… No schema drift detected"
          echo "   âœ… TypeScript types are deterministic"
          echo ""
          echo "Your database changes follow migration-first discipline."
      
      # Cleanup: Always stop Supabase
      - name: Stop Supabase
        if: always()
        run: |
          echo "ğŸ›‘ Stopping Supabase local instance..."
          supabase stop --no-backup
          echo "âœ… Supabase stopped"
