name: DB Determinism Check

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'lib/types/supabase.ts'
      - 'schema/**'
      - 'docs/canon/DB_SCHEMA_MANIFEST.json'
      - '.github/workflows/db-determinism.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  db-determinism:
    name: Verify migrations, drift, and types
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for migration checks
          ref: ${{ github.head_ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 2.63.1
      
      - name: Setup PowerShell
        run: |
          echo "‚úÖ PowerShell is already available on Ubuntu"
          pwsh --version
      
      # Check 0a: Test linter with fixtures (deterministic tests)
      - name: Test migration linter
        run: |
          echo "üß™ Running linter test suite..."
          pwsh -File scripts/db/test-linter.ps1
          echo "‚úÖ Linter tests passed"
      
      # Check 0b: Lint migrations against canonical schema manifest (V0.5+)
      - name: Lint migrations against schema manifest
        run: |
          echo "üîç Linting migrations against canonical schema manifest..."
          pwsh -File scripts/db/lint-migrations.ps1
          echo "‚úÖ All migrations use canonical schema objects"
      
      # Check 1: Ensure no existing migrations were edited
      - name: Check migration immutability
        run: |
          echo "üîç Checking migration immutability..."
          
          # Find merge base with target branch
          MERGE_BASE=$(git merge-base origin/${{ github.base_ref }} HEAD)
          echo "Merge base: $MERGE_BASE"
          
          # Check for modified migrations
          MODIFIED_MIGRATIONS=$(git diff --name-status $MERGE_BASE...HEAD -- supabase/migrations/*.sql | grep -v '^A' || true)
          
          if [ -n "$MODIFIED_MIGRATIONS" ]; then
            echo "‚ùå ERROR: Existing migration files were modified:"
            echo "$MODIFIED_MIGRATIONS" | while IFS=$'\t' read -r status file; do
              echo "  [$status] $file"
            done
            echo ""
            echo "Migrations are append-only. Create a new migration instead of editing existing ones."
            echo "If this is an emergency hotfix, set ALLOW_MIGRATION_EDITS=1"
            exit 1
          fi
          
          echo "‚úÖ All migration changes are new additions"
        env:
          ALLOW_MIGRATION_EDITS: '0'

      - name: Lint new migrations for idempotency
        run: |
          echo "üîç Linting new migrations for idempotency guard rails..."
          bash scripts/lint-new-migrations-idempotency.sh "origin/${{ github.base_ref }}"
      
      # Check 2: Start Supabase with clear lifecycle
      - name: Start Supabase local instance
        run: |
          echo "üöÄ Starting Supabase local instance..."
          supabase start
          echo ""
          echo "üìä Supabase Status:"
          supabase status
          echo ""
      
      - name: Apply migrations
        run: |
          echo "üì¶ Applying all migrations via db reset..."
          supabase db reset
          echo "‚úÖ Migrations applied successfully"

      - name: Verify seed invariants
        run: |
          echo "üîí Verifying baseline seed invariants..."
          pwsh -File scripts/db/verify-seed-invariants.ps1
          echo "‚úÖ Seed invariants satisfied"
      
      - name: Verify RLS policies on user data tables
        run: |
          echo "üîí Verifying RLS policies (R-DB-009)..."
          pwsh -File scripts/db/verify-rls-policies.ps1
          echo "‚úÖ RLS policies verified"
      
      - name: Upload RLS verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rls-verification
          path: artifacts/rls-verify/
          retention-days: 30
      
      # Check 3: Verify no schema drift
      - name: Check for schema drift
        run: |
          echo "üîç Checking for drift between migrations and actual schema..."
          DIFF_OUTPUT=$(supabase db diff --local 2>&1 || true)
          echo "$DIFF_OUTPUT"

          if echo "$DIFF_OUTPUT" | grep -Eqi 'No schema changes (found|detected)'; then
            echo "‚úÖ No schema drift detected"
            exit 0
          fi

          echo ""
          echo "‚ùå Schema drift detected!"
          echo "This means there are database changes not captured in migrations."
          echo "Please create a new migration to capture these changes."
          echo ""
          exit 1
      
      # Check 4: Verify types match (deterministic hard gate)
      - name: Verify TypeScript types are deterministic (auto-fix)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "üîç Verifying types match committed version (deterministic hard gate)..."
          pwsh -File scripts/db/typegen.ps1 -Verify
          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Types are deterministic and up to date"
            exit 0
          }

          Write-Host "‚ö†Ô∏è Typegen verify failed. Attempting auto-fix..." -ForegroundColor Yellow

          $prBranch = $env:GITHUB_HEAD_REF
          if ([string]::IsNullOrWhiteSpace($prBranch)) {
            Write-Host "‚ùå Auto-fix disabled on non-PR runs" -ForegroundColor Red
            exit 1
          }

          if ($prBranch -in @('main', 'master')) {
            Write-Host "‚ùå Auto-fix disabled on default branch" -ForegroundColor Red
            exit 1
          }

          $lastMessage = git log -1 --pretty=%s
          if ($lastMessage -match 'auto-update supabase types') {
            Write-Host "‚ùå Auto-fix already attempted (anti-loop guard)." -ForegroundColor Red
            exit 1
          }

          pwsh -File scripts/db/typegen.ps1 -Generate
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Typegen generate failed" -ForegroundColor Red
            exit 1
          }

          $changed = git diff --name-only
          if ($changed -contains 'lib/types/supabase.ts') {
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add lib/types/supabase.ts
            git commit -m "chore(db): auto-update supabase types"
            git push origin "HEAD:$prBranch"
          } else {
            Write-Host "‚ÑπÔ∏è No type changes to commit"
          }

          Write-Host "üîÅ Re-running typegen verify after auto-fix..."
          pwsh -File scripts/db/typegen.ps1 -Verify
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Typegen verify still failing after auto-fix" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Types are deterministic and up to date"

      - name: TypeGen fix instructions
        if: always()
        run: |
          echo ""
          echo "FIX: Download artifact 'supabase-typegen-output' from this run,"
          echo "copy artifacts/typegen/supabase.generated.ts to lib/types/supabase.ts,"
          echo "commit, push. Do not hand-edit."
      
      - name: Upload TypeGen artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-typegen-output
          path: |
            artifacts/typegen/supabase.generated.ts
            artifacts/typegen/stderr.log
          retention-days: 30
      
      # Success summary
      - name: Success summary
        if: success()
        run: |
          echo ""
          echo "üéâ All DB determinism checks passed!"
          echo "   ‚úÖ Linter tests passed (fixtures validated)"
          echo "   ‚úÖ All schema objects are canonical"
          echo "   ‚úÖ No existing migrations were edited"
          echo "   ‚úÖ Migrations apply cleanly"
          echo "   ‚úÖ Seed invariants satisfied"
          echo "   ‚úÖ RLS policies verified (R-DB-009)"
          echo "   ‚úÖ No schema drift detected"
          echo "   ‚úÖ TypeScript types are deterministic"
          echo ""
          echo "Your database changes follow migration-first discipline."
      
      # Cleanup: Always stop Supabase
      - name: Stop Supabase
        if: always()
        run: |
          echo "üõë Stopping Supabase local instance..."
          supabase stop --no-backup
          echo "‚úÖ Supabase stopped"
