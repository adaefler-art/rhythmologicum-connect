name: Apply Supabase migrations

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:
    inputs:
      include_all:
        description: 'Force apply migrations that would be inserted before last remote migration (passes --include-all to supabase db push). Use with care.'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      baseline_repair:
        description: 'Mark known baseline migrations as applied on remote (uses supabase migration repair; requires SUPABASE_DB_PASSWORD secret).'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read

jobs:
  apply-migrations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "ERROR: SUPABASE_ACCESS_TOKEN secret is not set"
            echo "Please add this secret in GitHub repository settings"
            exit 1
          fi
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_ID }}"
          if [ -z "$PROJECT_REF" ]; then
            PROJECT_REF="${{ secrets.SUPABASE_PROJECT_REF }}"
          fi
          if [ -z "$PROJECT_REF" ]; then
            echo "ERROR: Missing Supabase project ref secret"
            echo "Please set either SUPABASE_PROJECT_ID or SUPABASE_PROJECT_REF"
            echo "Hint: The project ref is the value in the Supabase Dashboard URL:"
            echo "  https://supabase.com/dashboard/project/<project-ref>"
            exit 1
          fi
          echo "✓ Required secrets are configured"

      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_ID || secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Show migration status (local vs remote)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Local + remote migration status:"
          supabase migration list --linked || supabase migration list || true

      - name: Optional baseline repair (remote history)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.baseline_repair == 'true' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "ERROR: SUPABASE_DB_URL secret is not set"
            echo "This step needs a Postgres connection string to update supabase_migrations.schema_migrations."
            echo "Tip: You can copy it from Supabase Dashboard > Project Settings > Database > Connection string."
            exit 1
          fi

          echo "Installing psql client..."
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

          echo "Repairing remote migration history for legacy baseline migrations (mark as applied, without executing SQL)..."

          psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 <<'SQL'
          INSERT INTO supabase_migrations.schema_migrations(version, name)
          VALUES
            ('01', '01_create_funnel_tables'),
            ('02', '02_add_funnel_id_to_assessments'),
            ('03', '03_create_content_pages'),
            ('20241203110000', '20241203110000_init_patient_profiles_and_assessments')
          ON CONFLICT (version) DO NOTHING;
          SQL

          echo "Baseline repair complete. Current remote migration list:"
          supabase migration list --linked || true

      - name: Apply pending migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Applying migrations to Supabase project..."
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.include_all }}" = "true" ]; then
            echo "NOTE: Running with --include-all (requested via workflow_dispatch input)"
            supabase db push --include-all
          else
            supabase db push
          fi

      - name: Verify migration status
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "✓ Migrations applied successfully"
          echo "Checking for any pending migrations..."
          supabase migration list || echo "Migration list command not available"
