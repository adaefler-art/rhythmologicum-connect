name: ESLint Gate (Changed Files)

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.ts'
      - '**.tsx'
      - 'eslint.config.mjs'
      - 'package.json'
      - 'tools/lint-changed-lines.mjs'
  push:
    branches: [ main ]
    paths:
      - '**.ts'
      - '**.tsx'
      - 'eslint.config.mjs'
      - 'package.json'

permissions:
  contents: read

jobs:
  lint-changed-files:
    runs-on: ubuntu-latest
    name: Lint Changed TS/TSX Files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine BASE_SHA (R-CI-002)
        id: base-sha
        shell: pwsh
        run: |
          # E72.ALIGN.P1.DETCON.001: Use shared BASE_SHA resolution script
          $output = & pwsh -File scripts/ci/get-base-sha.ps1 `
            -EventName "${{ github.event_name }}" `
            -PullRequestBaseSha "${{ github.event.pull_request.base.sha }}" `
            -EventBefore "${{ github.event.before }}" `
            -HeadSha "${{ github.sha }}"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ Failed to determine BASE_SHA (fail-closed)."
            exit 1
          }
          
          # Parse BASE_SHA and HEAD_SHA from output
          $baseSha = ""
          $headSha = ""
          
          foreach ($line in $output -split "`n") {
            if ($line -match '^BASE_SHA=(.+)$') {
              $baseSha = $Matches[1]
            }
            if ($line -match '^HEAD_SHA=(.+)$') {
              $headSha = $Matches[1]
            }
          }
          
          if ([string]::IsNullOrWhiteSpace($baseSha) -or [string]::IsNullOrWhiteSpace($headSha)) {
            Write-Host "❌ Failed to parse BASE_SHA or HEAD_SHA from script output."
            exit 1
          }
          
          # Export to GitHub environment
          echo "BASE_SHA=$baseSha" >> $env:GITHUB_ENV
          echo "HEAD_SHA=$headSha" >> $env:GITHUB_ENV
          
          Write-Host "✓ BASE_SHA and HEAD_SHA set for lint gate"

      - name: Run changed-files lint gate
        shell: bash
        run: |
          set -euo pipefail
          
          # BASE_SHA and HEAD_SHA are set by previous step
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
          
          # Export for lint:changed tool
          export BASE_SHA
          export HEAD_SHA
          
          # Run the lint gate tool
          npm run lint:changed

      - name: Success message
        if: success()
        run: |
          echo "✅ ESLint gate passed!"
          echo ""
          echo "Summary:"
          echo "  - No ESLint errors on changed lines"
          echo "  - Pre-existing errors outside changed ranges are ignored (interim policy)"
          echo "  - See docs/LINT_POLICY.md for details"
