name: Update canonical schema on merge

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Exit if triggered by the bot
        if: "github.actor == 'github-actions[bot]'"
        run: |
          echo "Run triggered by github-actions[bot]; exiting to avoid loop."
          exit 0

      - name: Install pg client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Dump schema
        env:
          PG_CONN: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$PG_CONN" ]; then
            echo "SUPABASE_DB_URL secret is not set. Aborting."
            exit 1
          fi
          # Fail fast if the connection string is missing a host.
          # When libpq gets a URL like postgresql://user:pass@/dbname it silently falls back to
          # local socket connections (e.g. /var/run/postgresql/.s.PGSQL.5432), which is confusing in CI.
          host=""
          db=""
          if echo "$PG_CONN" | grep -Eq '^postgres(ql)?://'; then
            conn_no_scheme="${PG_CONN#postgresql://}"
            conn_no_scheme="${conn_no_scheme#postgres://}"
            host_and_port="${conn_no_scheme#*@}"
            host_and_port="${host_and_port%%/*}"
            db_part="${conn_no_scheme#*/}"
            db_part="${db_part%%\?*}"
            host="$host_and_port"
            db="$db_part"

            if [ -z "$host" ] || echo "$PG_CONN" | grep -Eq '@/?'; then
              echo "ERROR: SUPABASE_DB_URL looks like a URL but does not include a host."
              echo "Expected format: postgresql://user:***@host:5432/dbname?sslmode=require"
              exit 1
            fi
          else
            # Keyword/value connection string support (e.g. host=... user=... dbname=...)
            host="$(echo "$PG_CONN" | sed -nE 's/.*(^|[[:space:]])host=([^[:space:]]+).*/\2/p')"
            db="$(echo "$PG_CONN" | sed -nE 's/.*(^|[[:space:]])dbname=([^[:space:]]+).*/\2/p')"

            if [ -z "$host" ]; then
              echo "ERROR: SUPABASE_DB_URL must include a host (URL form or host=... form)."
              exit 1
            fi
          fi

          echo "Using database host: $host"
          if [ -n "$db" ]; then
            echo "Using database name: $db"
          fi
          pg_dump --dbname="$PG_CONN" -s --no-owner --no-privileges -f schema_new.sql

      - name: Normalize schemas and diff
        run: |
          sed '/^--/d' schema_new.sql | sed -E '/^\\\\(un)?restrict /d' | sed '/^$/d' > /tmp/gen.sql
          if [ -f schema/schema.sql ]; then
            sed '/^--/d' schema/schema.sql | sed -E '/^\\\\(un)?restrict /d' | sed '/^$/d' > /tmp/old.sql
          else
            touch /tmp/old.sql
          fi

          if ! diff -u /tmp/old.sql /tmp/gen.sql > /tmp/schema.diff; then
            echo "schema differs, updating schema/schema.sql"
            mkdir -p schema
            mv schema_new.sql schema/schema.sql
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add schema/schema.sql
            git commit -m "ci: update canonical schema after merge" || echo "no changes to commit"
            git push origin HEAD:main
          else
            echo "No schema changes detected"
          fi
