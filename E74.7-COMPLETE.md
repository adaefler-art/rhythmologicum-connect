# E74.7 - COMPLETE

## Summary

Successfully implemented E74.7: Start/Resume Idempotency for assessments. Eliminated duplicate assessment runs and established clear resume/create semantics on server-side.

## What Was Delivered

### 1. Database Migration
**File:** `supabase/migrations/20260201163126_e74_7_assessment_idempotency.sql`

- ✅ Unique partial index: ONE in-progress assessment per patient+funnel
- ✅ Index name: `idx_assessments_one_in_progress_per_patient_funnel`
- ✅ Constraint: `CREATE UNIQUE INDEX ... ON assessments (patient_id, funnel) WHERE completed_at IS NULL`
- ✅ Updated comment on existing lookup index for clarity
- ✅ Prevents race conditions and duplicate assessments at database level

### 2. API Implementation
**Files:**
- `apps/rhythm-patient-ui/app/api/funnels/[slug]/assessments/route.ts`
- `apps/rhythm-legacy/app/api/funnels/[slug]/assessments/route.ts`

**POST /api/funnels/[slug]/assessments** - Start or Resume Assessment

**Default Behavior (RESUME_OR_CREATE):**
- ✅ Checks for existing in-progress assessment for patient+funnel
- ✅ Returns existing assessment with 200 status if found
- ✅ Creates new assessment with 201 status if none exists
- ✅ Prevents duplicate assessments from parallel/repeat requests

**ForceNew Behavior:**
- ✅ Accepts `forceNew: true` in request body
- ✅ Completes existing in-progress assessment (sets completed_at, status='completed')
- ✅ Creates new assessment after completing old one
- ✅ Returns new assessment with 201 status

**Implementation Details:**
- ✅ Parses request body for forceNew parameter
- ✅ Queries for existing in-progress assessment using efficient index
- ✅ Loads current step for existing assessment (legacy or V0.5)
- ✅ Atomic completion of old assessment before creating new
- ✅ Comprehensive logging for RESUME vs CREATE vs FORCE_NEW scenarios

### 3. Test Coverage
**File:** `apps/rhythm-legacy/app/api/funnels/__tests__/e74-7-idempotency.test.ts`

Comprehensive test suite covering:
- ✅ RESUME_OR_CREATE: Returns existing in-progress assessment with 200
- ✅ RESUME_OR_CREATE: Creates new assessment when none exists with 201
- ✅ forceNew=true: Completes old assessment and creates new one
- ✅ forceNew=true: Verifies update was called to complete old assessment
- ✅ Database constraint: Handles unique violation gracefully with 400
- ✅ Mock Supabase client with realistic behavior
- ✅ All test scenarios documented with clear expectations

### 4. Verification Script
**File:** `scripts/ci/verify-e74-7-idempotency.mjs`

Implements 3 validation checks:
- ✅ `checkMigration()` - Verifies migration file exists and creates required index
- ✅ `checkDatabaseConstraints()` - Verifies unique index and lookup index
- ✅ `checkAPIImplementation()` - Verifies RESUME_OR_CREATE logic and forceNew support

**Error Code Mapping:**
```javascript
const ERROR_CODE_TO_RULE_ID = {
  MISSING_UNIQUE_INDEX: 'R-E74.7-001',
  MISSING_LOOKUP_INDEX: 'R-E74.7-002',
  API_NO_RESUME_LOGIC: 'R-E74.7-003',
  API_NO_FORCE_NEW: 'R-E74.7-004',
  API_NO_COMPLETE_OLD: 'R-E74.7-005',
  API_NO_RACE_PROTECTION: 'R-E74.7-006',
}
```

**Usage:** `npm run verify:e74-7`

### 5. Documentation

**RULES_VS_CHECKS_MATRIX.md** (Updated)
- Added 6 E74.7 rules
- Added 6 E74.7 error codes
- Added 3 E74.7 check implementations
- Updated coverage metrics: 50 total rules (18+8+10+8+6)
- 100% coverage maintained

**E74.7-COMPLETE.md** (This file)
- Complete implementation guide
- Files changed with detailed explanations
- Acceptance criteria validation
- Testing instructions
- Troubleshooting guide

**package.json**
- Added `verify:e74-7` script

## Acceptance Criteria

✅ **Parallel/Repeat Requests Don't Create Duplicate Assessments**
- Unique database constraint prevents duplicates
- API checks for existing assessment before creating
- Returns existing assessment if found (RESUME)

✅ **Explicit New Run Properly Closes Previous One**
- forceNew=true parameter supported
- Old assessment completed (completed_at set, status='completed')
- New assessment created after old one is completed
- Logged and tracked separately from default behavior

✅ **All Rules Have Corresponding Checks**
- 6/6 E74.7 rules have check implementations

✅ **All Checks Reference Rule IDs**
- Complete ERROR_CODE_TO_RULE_ID mapping in verification script

✅ **Check Output Contains "violates R-XYZ"**
- Format: `[ERROR_CODE] violates R-E74.7-XXX: message`

## Guardrails Met

✅ **Every rule has a check implementation**
- 6/6 E74.7 rules implemented in verification script and code

✅ **Every check references a rule ID**
- Complete ERROR_CODE_TO_RULE_ID mapping in script

✅ **Check output contains "violates R-XYZ"**
- All error messages follow the pattern

✅ **RULES_VS_CHECKS_MATRIX.md updated**
- All rules documented
- All error codes mapped
- Coverage audit updated to 50 total rules

## Architecture

### Data Flow - Default (RESUME_OR_CREATE)

```
Patient Starts Assessment (UI)
    ↓
POST /api/funnels/{slug}/assessments (no forceNew)
    ↓
Check for existing in-progress assessment
    ├─ Found? → Return existing (200 OK) [RESUME]
    └─ Not found? → Create new (201 Created) [CREATE]
```

### Data Flow - Explicit New (forceNew=true)

```
Patient Starts New Assessment (UI)
    ↓
POST /api/funnels/{slug}/assessments (forceNew=true)
    ↓
Check for existing in-progress assessment
    ├─ Found? → Complete old + Create new (201 Created) [FORCE_NEW]
    └─ Not found? → Create new (201 Created) [CREATE]
```

### Database Constraint

```sql
CREATE UNIQUE INDEX idx_assessments_one_in_progress_per_patient_funnel
  ON assessments (patient_id, funnel)
  WHERE completed_at IS NULL;
```

This ensures:
- At most ONE in-progress assessment per (patient_id, funnel) combination
- Completed assessments don't interfere (WHERE clause)
- Concurrent requests fail fast (unique constraint violation)

### Security Layers

1. **Database Level:** Unique constraint prevents duplicates even with race conditions
2. **API Level:** Explicit check before insert for better UX
3. **Authorization:** Existing patient profile checks ensure proper ownership
4. **Logging:** All scenarios (RESUME, CREATE, FORCE_NEW) logged distinctly

## Behavior Scenarios

### Scenario 1: User Starts Assessment for First Time

**Request:**
```
POST /api/funnels/stress-assessment/assessments
{}
```

**Behavior:**
- No existing in-progress assessment found
- CREATE: New assessment created
- Response: 201 Created with assessmentId

### Scenario 2: User Starts Same Assessment Again (Forgot They Started)

**Request:**
```
POST /api/funnels/stress-assessment/assessments
{}
```

**Behavior:**
- Existing in-progress assessment found
- RESUME: Return existing assessment
- Response: 200 OK with existing assessmentId
- User continues where they left off

### Scenario 3: User Wants to Start Fresh (Explicit)

**Request:**
```
POST /api/funnels/stress-assessment/assessments
{ "forceNew": true }
```

**Behavior:**
- Existing in-progress assessment found
- FORCE_NEW: Complete old assessment
- CREATE: New assessment created
- Response: 201 Created with new assessmentId

### Scenario 4: Parallel Requests (Network Retry, Duplicate Tabs)

**Request 1:**
```
POST /api/funnels/stress-assessment/assessments
```

**Request 2 (parallel):**
```
POST /api/funnels/stress-assessment/assessments
```

**Behavior:**
- First request creates assessment
- Second request:
  - If database constraint not hit yet: finds existing, returns it (RESUME)
  - If database constraint hit: 400 error with data integrity message
- No duplicate assessments created

## Files Changed

### Database
- `supabase/migrations/20260201163126_e74_7_assessment_idempotency.sql` - New migration

### API Routes
- `apps/rhythm-patient-ui/app/api/funnels/[slug]/assessments/route.ts` - Modified (added RESUME_OR_CREATE logic)
- `apps/rhythm-legacy/app/api/funnels/[slug]/assessments/route.ts` - Modified (added RESUME_OR_CREATE logic)

### Tests
- `apps/rhythm-legacy/app/api/funnels/__tests__/e74-7-idempotency.test.ts` - New

### Guardrails
- `scripts/ci/verify-e74-7-idempotency.mjs` - New
- `package.json` - Modified (added verify:e74-7 script)
- `docs/RULES_VS_CHECKS_MATRIX.md` - Modified (added E74.7 rules and checks)

### Documentation
- `E74.7-COMPLETE.md` - New (this file)

## Testing

### Automated Verification

```bash
npm run verify:e74-7
```

Expected output: ✅ All checks passed (or warnings for programmatic verification limitations)

### Unit Tests

```bash
npm test -- e74-7-idempotency
```

Expected: All tests pass

### Manual Testing Scenarios

#### 1. Resume Test
**Setup:** Start assessment but don't complete
**Steps:**
1. POST /api/funnels/stress-assessment/assessments (first time)
2. Note assessmentId from response (201)
3. POST /api/funnels/stress-assessment/assessments (second time)
4. Verify same assessmentId returned (200)
**Expected:** Same assessment resumed, no duplicate created

#### 2. Force New Test
**Setup:** Have in-progress assessment
**Steps:**
1. POST /api/funnels/stress-assessment/assessments with forceNew=true
2. Note new assessmentId (201)
3. Check old assessment is completed (query database)
**Expected:** Old assessment has completed_at set, new assessment created

#### 3. Parallel Request Test
**Setup:** No existing assessment
**Steps:**
1. Send 2 identical POST requests in parallel (same slug, same patient)
2. Check database for assessments count
**Expected:** Only 1 assessment created, both requests succeed (one 201, one 200 or both 200)

#### 4. Different Funnel Test
**Setup:** Have stress-assessment in progress
**Steps:**
1. POST /api/funnels/cardiovascular-age/assessments
**Expected:** New assessment created (different funnel slug = different constraint)

#### 5. Completed Assessment Test
**Setup:** Have completed stress assessment
**Steps:**
1. POST /api/funnels/stress-assessment/assessments
**Expected:** New assessment created (completed_at IS NOT NULL = not constrained)

## Known Limitations

1. **Client-Side State:** Client must handle resume scenario gracefully (redirect to correct step)
2. **forceNew UI:** No UI button yet for "Start Fresh" - requires API integration
3. **Completion Trigger:** forceNew completes old assessment but doesn't trigger completion hooks (reports, etc.)

## Future Enhancements

- [ ] Add UI "Start Fresh" button with forceNew flag
- [ ] Add "Resume Assessment" banner when existing assessment found
- [ ] Add assessment history view showing completed + in-progress
- [ ] Add automatic cleanup of very old in-progress assessments (abandoned)
- [ ] Add telemetry events for RESUME vs CREATE scenarios
- [ ] Add migration to handle any existing duplicate in-progress assessments

## Migration Path

If upgrading from earlier version:

1. **Check for Existing Duplicates:**
   ```sql
   SELECT patient_id, funnel, COUNT(*)
   FROM assessments
   WHERE completed_at IS NULL
   GROUP BY patient_id, funnel
   HAVING COUNT(*) > 1;
   ```

2. **Resolve Duplicates (if any):**
   ```sql
   -- Complete all but the most recent per patient+funnel
   UPDATE assessments a1
   SET completed_at = NOW(), status = 'completed'
   WHERE completed_at IS NULL
     AND EXISTS (
       SELECT 1 FROM assessments a2
       WHERE a2.patient_id = a1.patient_id
         AND a2.funnel = a1.funnel
         AND a2.completed_at IS NULL
         AND a2.started_at > a1.started_at
     );
   ```

3. **Run Migration:**
   ```bash
   supabase migration up
   ```

4. **Verify Index:**
   ```sql
   SELECT indexname, indexdef
   FROM pg_indexes
   WHERE tablename = 'assessments'
     AND indexname LIKE '%in_progress%';
   ```

5. **Run Verification:**
   ```bash
   npm run verify:e74-7
   ```

## Troubleshooting

| Issue | Check | Fix |
|-------|-------|-----|
| Duplicate assessments created | Index exists? | Run migration |
| 400 error on create | Existing assessment? | Use RESUME or forceNew=true |
| Old assessment not completed | forceNew logic? | Check API implementation |
| Resume returns wrong step | getCurrentStep? | Check step loading logic |
| Constraint violation | Concurrent requests? | Expected behavior, one succeeds |

## Security Considerations

✅ **Ownership Enforcement:** Patient can only resume/create own assessments (existing RLS)
✅ **No Bypass:** Unique constraint prevents duplicates even if API logic fails
✅ **Explicit Intent:** forceNew requires explicit flag (not accidental)
✅ **Audit Trail:** All scenarios logged with distinct markers
✅ **Data Integrity:** Old assessments properly completed, not orphaned

## Performance Considerations

✅ **Index Optimization:** Partial unique index only covers in-progress assessments
✅ **Query Efficiency:** Uses idx_assessments_patient_in_progress for lookup
✅ **Minimal Overhead:** Single query to check for existing assessment
✅ **No Lock Contention:** Unique constraint fails fast on collision

## Contact

For questions or issues with E74.7 implementation, refer to:
- This document (E74.7-COMPLETE.md)
- RULES_VS_CHECKS_MATRIX.md (rules reference)
- Verification script: scripts/ci/verify-e74-7-idempotency.mjs

---

**Last Updated:** 2026-02-01  
**Status:** ✅ COMPLETE  
**Verification:** Run `npm run verify:e74-7`
