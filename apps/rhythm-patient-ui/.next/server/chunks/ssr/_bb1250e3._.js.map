{"version":3,"sources":["../../../../../../lib/contracts/registry.ts","../../../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../../../lib/audit/log.ts","../../../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../../lib/actions/onboarding.ts","../../../../../../lib/contracts/onboarding.ts"],"sourcesContent":["/**\n * Contract Registry - Canonical Identifiers\n * \n * This file serves as the single source of truth for all critical string identifiers\n * used throughout the application. All new identifiers MUST be added here to prevent\n * \"fantasy names\" and ensure consistency.\n * \n * **IMPORTANT**: This file is protected by CODEOWNERS. Any changes require review.\n * \n * Usage:\n * ```typescript\n * import { ASSESSMENT_STATUS, FUNNEL_SLUG, USER_ROLE } from '@/lib/contracts/registry'\n * \n * const status: AssessmentStatus = ASSESSMENT_STATUS.IN_PROGRESS\n * const funnel: FunnelSlug = FUNNEL_SLUG.STRESS_ASSESSMENT\n * ```\n */\n\n// ============================================================\n// Assessment Statuses\n// ============================================================\n\n/**\n * Valid statuses for assessments\n */\nexport const ASSESSMENT_STATUS = {\n  IN_PROGRESS: 'in_progress',\n  COMPLETED: 'completed',\n} as const\n\nexport type AssessmentStatus = typeof ASSESSMENT_STATUS[keyof typeof ASSESSMENT_STATUS]\n\n// ============================================================\n// Content Page Statuses\n// ============================================================\n\n/**\n * Valid statuses for content pages\n */\nexport const CONTENT_STATUS = {\n  DRAFT: 'draft',\n  PUBLISHED: 'published',\n  ARCHIVED: 'archived',\n} as const\n\nexport type ContentStatus = typeof CONTENT_STATUS[keyof typeof CONTENT_STATUS]\n\n// ============================================================\n// Pillar Keys (7-Pillar Model)\n// ============================================================\n\n/**\n * Valid pillar keys for funnel taxonomy (7-Pillar Wellness Model)\n */\nexport const PILLAR_KEY = {\n  NUTRITION: 'nutrition',\n  MOVEMENT: 'movement',\n  SLEEP: 'sleep',\n  MENTAL_HEALTH: 'mental-health',\n  SOCIAL: 'social',\n  MEANING: 'meaning',\n  PREVENTION: 'prevention',\n} as const\n\nexport type PillarKey = typeof PILLAR_KEY[keyof typeof PILLAR_KEY]\n\n// ============================================================\n// Funnel Slugs\n// ============================================================\n\n/**\n * Valid funnel slugs\n * The canonical slug is the primary identifier\n * Legacy aliases are maintained for backward compatibility\n */\nexport const FUNNEL_SLUG = {\n  STRESS_ASSESSMENT: 'stress-assessment',\n  CARDIOVASCULAR_AGE: 'cardiovascular-age',\n  SLEEP_QUALITY: 'sleep-quality',\n  HEART_HEALTH_NUTRITION: 'heart-health-nutrition',\n  // Legacy aliases - deprecated but maintained for compatibility\n  STRESS: 'stress',\n  STRESS_CHECK: 'stress-check',\n  STRESS_CHECK_V2: 'stress-check-v2',\n} as const\n\nexport type FunnelSlug = typeof FUNNEL_SLUG[keyof typeof FUNNEL_SLUG]\n\n/**\n * Maps legacy funnel slugs to their canonical equivalents\n * Uses lowercase keys for case-insensitive matching\n */\nexport const FUNNEL_SLUG_ALIASES: Record<string, string> = {\n  'stress': FUNNEL_SLUG.STRESS_ASSESSMENT,\n  'stress-check': FUNNEL_SLUG.STRESS_ASSESSMENT,\n  'stress-check-v2': FUNNEL_SLUG.STRESS_ASSESSMENT,\n}\n\n/**\n * Resolves a funnel slug to its canonical form\n * Normalizes input by trimming and converting to lowercase for deterministic matching\n * \n * @param slug - The funnel slug to resolve (case-insensitive, whitespace trimmed)\n * @returns The canonical slug or the normalized input if no mapping exists\n */\nexport function getCanonicalFunnelSlug(slug: string): string {\n  const normalized = slug.toLowerCase().trim()\n  return FUNNEL_SLUG_ALIASES[normalized] || normalized\n}\n\n/**\n * Checks if a funnel slug is known in the registry\n * A funnel is \"known\" if it exists in FUNNEL_SLUG values (canonical or legacy)\n * \n * @param slug - The funnel slug to check (case-insensitive, whitespace trimmed)\n * @returns true if the funnel slug is registered, false otherwise\n */\nexport function isKnownFunnelSlug(slug: string): boolean {\n  const canonical = getCanonicalFunnelSlug(slug)\n  const allSlugs = Object.values(FUNNEL_SLUG)\n  return allSlugs.includes(canonical as FunnelSlug)\n}\n\n// ============================================================\n// Node/Step Types\n// ============================================================\n\n/**\n * Valid node/step types for funnel steps\n * These correspond to the 'type' field in the funnel_steps table\n */\nexport const NODE_TYPE = {\n  QUESTION_STEP: 'question_step',\n  FORM: 'form',\n  INFO_STEP: 'info_step',\n  INFO: 'info',\n  CONTENT_PAGE: 'content_page',\n  SUMMARY: 'summary',\n  OTHER: 'other',\n} as const\n\nexport type NodeType = typeof NODE_TYPE[keyof typeof NODE_TYPE]\n\n// ============================================================\n// User Roles\n// ============================================================\n\n/**\n * Valid user roles\n * These are stored in auth.users.raw_app_meta_data.role\n */\nexport const USER_ROLE = {\n  PATIENT: 'patient',\n  CLINICIAN: 'clinician',\n  ADMIN: 'admin',\n  NURSE: 'nurse',\n} as const\n\nexport type UserRole = typeof USER_ROLE[keyof typeof USER_ROLE]\n\n// ============================================================\n// Question Types\n// ============================================================\n\n/**\n * Valid question types\n * These correspond to the 'question_type' field in the questions table\n */\nexport const QUESTION_TYPE = {\n  RADIO: 'radio',\n  CHECKBOX: 'checkbox',\n  TEXT: 'text',\n  TEXTAREA: 'textarea',\n  NUMBER: 'number',\n  SCALE: 'scale',\n  SLIDER: 'slider',\n} as const\n\nexport type QuestionType = typeof QUESTION_TYPE[keyof typeof QUESTION_TYPE]\n\n// ============================================================\n// Patient Demographics\n// ============================================================\n\n/**\n * Valid sex/gender options for patient profiles\n * These correspond to the 'sex' field in the patient_profiles table\n */\nexport const PATIENT_SEX = {\n  MALE: 'male',\n  FEMALE: 'female',\n  OTHER: 'other',\n  PREFER_NOT_TO_SAY: 'prefer_not_to_say',\n} as const\n\nexport type PatientSex = typeof PATIENT_SEX[keyof typeof PATIENT_SEX]\n\n// ============================================================\n// Feature Flag Names\n// ============================================================\n\n/**\n * Valid feature flag names (without NEXT_PUBLIC_FEATURE_ prefix)\n */\nexport const FEATURE_FLAG = {\n  AMY_ENABLED: 'AMY_ENABLED',\n  CLINICIAN_DASHBOARD_ENABLED: 'CLINICIAN_DASHBOARD_ENABLED',\n  CHARTS_ENABLED: 'CHARTS_ENABLED',\n} as const\n\nexport type FeatureFlag = typeof FEATURE_FLAG[keyof typeof FEATURE_FLAG]\n\n// ============================================================\n// Helper Functions\n// ============================================================\n\n/**\n * Type guard to check if a value is a valid assessment status\n */\nexport function isValidAssessmentStatus(value: unknown): value is AssessmentStatus {\n  return typeof value === 'string' && Object.values(ASSESSMENT_STATUS).includes(value as AssessmentStatus)\n}\n\n/**\n * Type guard to check if a value is a valid content status\n */\nexport function isValidContentStatus(value: unknown): value is ContentStatus {\n  return typeof value === 'string' && Object.values(CONTENT_STATUS).includes(value as ContentStatus)\n}\n\n/**\n * Type guard to check if a value is a valid user role\n */\nexport function isValidUserRole(value: unknown): value is UserRole {\n  return typeof value === 'string' && Object.values(USER_ROLE).includes(value as UserRole)\n}\n\n/**\n * Type guard to check if a value is a valid node type\n */\nexport function isValidNodeType(value: unknown): value is NodeType {\n  return typeof value === 'string' && Object.values(NODE_TYPE).includes(value as NodeType)\n}\n\n/**\n * Type guard to check if a value is a valid pillar key\n */\nexport function isValidPillarKey(value: unknown): value is PillarKey {\n  return typeof value === 'string' && Object.values(PILLAR_KEY).includes(value as PillarKey)\n}\n\n/**\n * Type guard to check if a value is a valid patient sex option\n */\nexport function isValidPatientSex(value: unknown): value is PatientSex {\n  return typeof value === 'string' && Object.values(PATIENT_SEX).includes(value as PatientSex)\n}\n\n// ============================================================\n// Audit Log Entity Types\n// ============================================================\n\n/**\n * Valid entity types for audit logging\n * These correspond to the 'entity_type' field in the audit_log table\n */\nexport const AUDIT_ENTITY_TYPE = {\n  ASSESSMENT: 'assessment',\n  REPORT: 'report',\n  TASK: 'task',\n  FUNNEL_VERSION: 'funnel_version',\n  FUNNEL_CATALOG: 'funnel_catalog',\n  CONFIG: 'config',\n  CONSENT: 'consent',\n  ORGANIZATION: 'organization',\n  USER_ORG_MEMBERSHIP: 'user_org_membership',\n  CLINICIAN_ASSIGNMENT: 'clinician_assignment',\n  DOCUMENT: 'document', // V05-I04.3: Document confirmation tracking\n  PROCESSING_JOB: 'processing_job', // V05-I05.1: Processing job orchestration\n  REVIEW_RECORD: 'review_record', // V05-I05.7: Medical review records\n  PRE_SCREENING_CALL: 'pre_screening_call', // V05-I08.2: Pre-screening call records\n  DEVICE_SHIPMENT: 'device_shipment', // V05-I08.3: Shipment tracking\n  SUPPORT_CASE: 'support_case', // V05-I08.4: Support case documentation\n  ACCOUNT: 'account', // V05-I10.2: Account lifecycle (deletion/retention)\n} as const\n\nexport type AuditEntityType = typeof AUDIT_ENTITY_TYPE[keyof typeof AUDIT_ENTITY_TYPE]\n\n// ============================================================\n// Audit Log Actions\n// ============================================================\n\n/**\n * Valid actions for audit logging\n * These correspond to the 'action' field in the audit_log table\n */\nexport const AUDIT_ACTION = {\n  CREATE: 'create',\n  UPDATE: 'update',\n  DELETE: 'delete',\n  APPROVE: 'approve',\n  REJECT: 'reject',\n  REQUEST_CHANGES: 'request_changes', // V05-I05.7: Review workflow\n  GENERATE: 'generate',\n  FLAG: 'flag',\n  ASSIGN: 'assign',\n  ACTIVATE: 'activate',\n  DEACTIVATE: 'deactivate',\n  ROLLOUT: 'rollout',\n  COMPLETE: 'complete',\n  ESCALATE: 'escalate', // V05-I08.4: Support case escalation\n  DELETION_REQUEST: 'deletion_request', // V05-I10.2: User requested account deletion\n  DELETION_CANCEL: 'deletion_cancel', // V05-I10.2: User cancelled deletion request\n  DELETION_EXECUTE: 'deletion_execute', // V05-I10.2: System executed account deletion\n  ANONYMIZE: 'anonymize', // V05-I10.2: Records anonymized instead of deleted\n} as const\n\nexport type AuditAction = typeof AUDIT_ACTION[keyof typeof AUDIT_ACTION]\n\n// ============================================================\n// Audit Log Sources\n// ============================================================\n\n/**\n * Valid sources for audit logging\n * These correspond to the 'source' field in the audit_log table\n */\nexport const AUDIT_SOURCE = {\n  API: 'api',\n  JOB: 'job',\n  ADMIN_UI: 'admin-ui',\n  SYSTEM: 'system',\n} as const\n\nexport type AuditSource = typeof AUDIT_SOURCE[keyof typeof AUDIT_SOURCE]\n\n// ============================================================\n// Audit Type Guards\n// ============================================================\n\n/**\n * Type guard to check if a value is a valid audit entity type\n */\nexport function isValidAuditEntityType(value: unknown): value is AuditEntityType {\n  return typeof value === 'string' && Object.values(AUDIT_ENTITY_TYPE).includes(value as AuditEntityType)\n}\n\n/**\n * Type guard to check if a value is a valid audit action\n */\nexport function isValidAuditAction(value: unknown): value is AuditAction {\n  return typeof value === 'string' && Object.values(AUDIT_ACTION).includes(value as AuditAction)\n}\n\n/**\n * Type guard to check if a value is a valid audit source\n */\nexport function isValidAuditSource(value: unknown): value is AuditSource {\n  return typeof value === 'string' && Object.values(AUDIT_SOURCE).includes(value as AuditSource)\n}\n\n// ============================================================\n// Program Tier Levels (TV05_01D)\n// ============================================================\n\n/**\n * Valid program tier levels based on Thomas' journey model\n * These map the 3-tier patient journey to platform capabilities\n */\nexport const PROGRAM_TIER = {\n  /**\n   * Tier 1 (Essential): Basic stress/resilience assessment\n   * Focus: Initial assessment, baseline data collection\n   */\n  TIER_1_ESSENTIAL: 'tier-1-essential',\n  \n  /**\n   * Tier 2.5 (Enhanced): Extended monitoring with nurse touchpoints\n   * Focus: Regular check-ins, progress tracking\n   */\n  TIER_2_5_ENHANCED: 'tier-2-5-enhanced',\n  \n  /**\n   * Tier 2 (Comprehensive): Full program with intensive support\n   * Focus: Comprehensive care, multiple pillars, frequent touchpoints\n   */\n  TIER_2_COMPREHENSIVE: 'tier-2-comprehensive',\n} as const\n\nexport type ProgramTier = typeof PROGRAM_TIER[keyof typeof PROGRAM_TIER]\n\n/**\n * Type guard to check if a value is a valid program tier\n */\nexport function isValidProgramTier(value: unknown): value is ProgramTier {\n  return typeof value === 'string' && Object.values(PROGRAM_TIER).includes(value as ProgramTier)\n}\n\n// ============================================================\n// Document Extraction Versions (V05-I04.2)\n// ============================================================\n\n/**\n * Valid extractor versions for AI document extraction\n * Format: vMAJOR.MINOR.PATCH\n * Update when extraction logic or prompts change\n */\nexport const EXTRACTOR_VERSION = {\n  /**\n   * v1.0.0: Initial extraction pipeline\n   * - Basic lab value extraction\n   * - Medication list extraction\n   * - Confidence scoring\n   */\n  V1_0_0: 'v1.0.0',\n} as const\n\nexport type ExtractorVersion = typeof EXTRACTOR_VERSION[keyof typeof EXTRACTOR_VERSION]\n\n/**\n * Current extractor version (latest)\n */\nexport const CURRENT_EXTRACTOR_VERSION = EXTRACTOR_VERSION.V1_0_0\n\n/**\n * Type guard to check if a value is a valid extractor version\n */\nexport function isValidExtractorVersion(value: unknown): value is ExtractorVersion {\n  return typeof value === 'string' && Object.values(EXTRACTOR_VERSION).includes(value as ExtractorVersion)\n}\n\n// ============================================================\n// Processing Stages & Status (V05-I05.1)\n// ============================================================\n\n/**\n * Valid processing stages for job orchestrator\n * Jobs progress deterministically through these stages\n */\nexport const PROCESSING_STAGE = {\n  PENDING: 'pending',\n  RISK: 'risk',\n  RANKING: 'ranking',\n  CONTENT: 'content',\n  VALIDATION: 'validation',\n  REVIEW: 'review',\n  PDF: 'pdf',\n  DELIVERY: 'delivery',\n  COMPLETED: 'completed',\n  FAILED: 'failed',\n} as const\n\nexport type ProcessingStage = typeof PROCESSING_STAGE[keyof typeof PROCESSING_STAGE]\n\n/**\n * Valid processing statuses for job orchestrator\n */\nexport const PROCESSING_STATUS = {\n  QUEUED: 'queued',\n  IN_PROGRESS: 'in_progress',\n  COMPLETED: 'completed',\n  FAILED: 'failed',\n} as const\n\nexport type ProcessingStatus = typeof PROCESSING_STATUS[keyof typeof PROCESSING_STATUS]\n\n/**\n * Type guard to check if a value is a valid processing stage\n */\nexport function isValidProcessingStage(value: unknown): value is ProcessingStage {\n  return typeof value === 'string' && Object.values(PROCESSING_STAGE).includes(value as ProcessingStage)\n}\n\n/**\n * Type guard to check if a value is a valid processing status\n */\nexport function isValidProcessingStatus(value: unknown): value is ProcessingStatus {\n  return typeof value === 'string' && Object.values(PROCESSING_STATUS).includes(value as ProcessingStatus)\n}\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","/**\n * Audit Logging Helper\n *\n * Provides type-safe audit logging functionality for decision-relevant events.\n * Ensures no PHI leakage and maintains comprehensive audit trails.\n *\n * @module lib/audit/log\n */\n\nimport { createClient } from '@supabase/supabase-js'\nimport type { Database, Json } from '@/lib/types/supabase'\nimport {\n  type AuditEntityType,\n  type AuditAction,\n  type AuditSource,\n  type UserRole,\n} from '@/lib/contracts/registry'\nimport { env } from '@/lib/env'\n\n// ============================================================\n// Types\n// ============================================================\n\n/**\n * Audit event metadata\n * Contains version information and correlation IDs\n * NO PHI should be stored here\n */\nexport type AuditMetadata = {\n  request_id?: string\n  algorithm_version?: string\n  prompt_version?: string\n  report_version?: string\n  correlation_id?: string\n  safety_score?: number\n  status_from?: string\n  status_to?: string\n  [key: string]: string | number | boolean | undefined\n}\n\n/**\n * Audit diff payload\n * Contains before/after snapshots of changes\n * Should contain IDs and status transitions, NOT raw clinical text\n */\nexport type AuditDiff = {\n  before?: Record<string, unknown>\n  after?: Record<string, unknown>\n  changes?: Record<string, { from: unknown; to: unknown }>\n}\n\n/**\n * Complete audit event structure\n */\nexport type AuditEvent = {\n  // Context\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  source: AuditSource\n\n  // Entity\n  entity_type: AuditEntityType\n  entity_id: string\n  action: AuditAction\n\n  // Details\n  diff?: AuditDiff\n  metadata?: AuditMetadata\n}\n\n/**\n * Result of logging an audit event\n */\nexport type AuditLogResult = {\n  success: boolean\n  audit_id?: string\n  error?: string\n}\n\n// ============================================================\n// Supabase Client (Service Role)\n// ============================================================\n\n/**\n * Creates a Supabase client with service role key for audit logging\n * Bypasses RLS to ensure audit logs are always written\n */\nfunction getAuditClient() {\n  const supabaseUrl = env.NEXT_PUBLIC_SUPABASE_URL || env.SUPABASE_URL\n  const supabaseServiceKey = env.SUPABASE_SERVICE_ROLE_KEY || env.SUPABASE_SERVICE_KEY\n\n  if (!supabaseUrl || !supabaseServiceKey) {\n    console.error('[audit/log] Missing Supabase credentials')\n    return null\n  }\n\n  return createClient<Database>(supabaseUrl, supabaseServiceKey, {\n    auth: { persistSession: false },\n  })\n}\n\n// ============================================================\n// PHI Protection & Redaction\n// ============================================================\n\n/**\n * List of allowed keys in metadata and diff objects\n * These are safe to store (IDs, versions, statuses, numeric values)\n */\nconst ALLOWED_METADATA_KEYS = [\n  'request_id',\n  'correlation_id',\n  'algorithm_version',\n  'prompt_version',\n  'report_version',\n  'version',\n  'safety_score',\n  'finding_count',\n  'status_from',\n  'status_to',\n  'assigned_to_role',\n  'reason',\n  'consent_type',\n  'granted',\n  'rollout_percent',\n  'rollout_percent_from',\n  'rollout_percent_to',\n  'is_active',\n  'assessment_id',\n  'report_id',\n  'task_id',\n  'funnel_id',\n  'version_id',\n  'consent_id',\n  'config_key',\n  'consent_version',\n  'profile_updated',\n  'review_id',\n  'job_id',\n  'decision_reason',\n  'has_notes',\n  // V05-I10.2: Account deletion/retention metadata\n  'deletion_reason',\n  'scheduled_for',\n  'retention_period_days',\n  'records_deleted',\n  'records_anonymized',\n  'executed_by',\n  'anonymization_reason',\n  // V05-I10.3: KPI/Observability tracking\n  'kpi_event',\n  'funnel_slug',\n  'drop_off_reason',\n  'current_step_id',\n  'step_order_index',\n  'duration_seconds',\n  'duration_before_drop_seconds',\n  'started_at',\n  'completed_at',\n  'time_to_report_seconds',\n  'report_created_at',\n  'error_type',\n] as const\n\n/**\n * List of keys that contain PHI and must be blocked\n */\nconst PHI_KEYS = [\n  'content',\n  'text',\n  'notes',\n  'answers',\n  'answer',\n  'response',\n  'extracted_data',\n  'clinical_notes',\n  'patient_notes',\n  'observation',\n  'diagnosis',\n  'medication',\n  'name',\n  'email',\n  'phone',\n  'address',\n  'ssn',\n  'dob',\n  'date_of_birth',\n] as const\n\n/**\n * Redacts PHI from a data object\n * Only allows specific safe keys and removes PHI-containing fields\n *\n * @param data - Object to redact\n * @param maxSize - Maximum allowed size in characters (default: 5000)\n * @returns Redacted object with only safe fields\n */\nexport function redactPHI(\n  data: Record<string, unknown> | undefined,\n  maxSize = 5000,\n): Record<string, unknown> {\n  if (!data || typeof data !== 'object') {\n    return {}\n  }\n\n  const redacted: Record<string, unknown> = {}\n  let totalSize = 0\n\n  for (const [key, value] of Object.entries(data)) {\n    // Block PHI keys explicitly\n    const lowerKey = key.toLowerCase()\n    if (PHI_KEYS.some((phiKey) => lowerKey.includes(phiKey))) {\n      redacted[key] = '[REDACTED]'\n      continue\n    }\n\n    // Check if key is in allowlist\n    const isAllowed = ALLOWED_METADATA_KEYS.includes(key as (typeof ALLOWED_METADATA_KEYS)[number])\n\n    // Allow numeric values, booleans, and safe strings\n    if (typeof value === 'number' || typeof value === 'boolean') {\n      redacted[key] = value\n      totalSize += String(value).length\n    } else if (typeof value === 'string') {\n      // Only allow strings from allowlist or UUID-like patterns\n      const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(value)\n      const isShortSafe = value.length <= 100 && !/[<>{}]/.test(value) // No HTML/JSON\n\n      if (isAllowed || isUUID || (isShortSafe && lowerKey.includes('id'))) {\n        redacted[key] = value\n        totalSize += value.length\n      } else {\n        redacted[key] = '[REDACTED]'\n      }\n    } else if (value === null || value === undefined) {\n      redacted[key] = value\n    } else if (typeof value === 'object' && !Array.isArray(value)) {\n      // Recursively redact nested objects\n      redacted[key] = redactPHI(value as Record<string, unknown>, maxSize - totalSize)\n      totalSize += JSON.stringify(redacted[key]).length\n    } else {\n      // Arrays and other types - redact to be safe\n      redacted[key] = '[REDACTED]'\n    }\n\n    // Enforce size limit\n    if (totalSize > maxSize) {\n      console.warn('[audit/log] Metadata/diff size exceeded limit, truncating')\n      break\n    }\n  }\n\n  return redacted\n}\n\n// ============================================================\n// Core Logging Function\n// ============================================================\n\n/**\n * Logs an audit event to the database\n *\n * This function:\n * - Validates event structure\n * - Ensures no PHI in diff/metadata\n * - Uses service role to bypass RLS\n * - Returns success/failure status\n *\n * @param event - The audit event to log\n * @returns Result indicating success or failure\n *\n * @example\n * ```typescript\n * await logAuditEvent({\n *   org_id: '123e4567-e89b-12d3-a456-426614174000',\n *   actor_user_id: user.id,\n *   actor_role: 'clinician',\n *   source: 'api',\n *   entity_type: 'report',\n *   entity_id: reportId,\n *   action: 'generate',\n *   metadata: {\n *     algorithm_version: '1.0',\n *     prompt_version: '2.0',\n *     report_version: '1.0',\n *   },\n * })\n * ```\n */\nexport async function logAuditEvent(event: AuditEvent): Promise<AuditLogResult> {\n  const startTime = Date.now()\n\n  try {\n    // Validate event\n    if (!event.entity_type) {\n      return { success: false, error: 'entity_type is required' }\n    }\n    if (!event.entity_id) {\n      return { success: false, error: 'entity_id is required' }\n    }\n    if (!event.action) {\n      return { success: false, error: 'action is required' }\n    }\n    if (!event.source) {\n      return { success: false, error: 'source is required' }\n    }\n\n    // Get Supabase client\n    const supabase = getAuditClient()\n    if (!supabase) {\n      console.error('[audit/log] Cannot create Supabase client')\n      return { success: false, error: 'Supabase client unavailable' }\n    }\n\n    // Redact PHI from diff and metadata\n    const safeMetadata = redactPHI(event.metadata || {})\n    const safeDiff: Record<string, unknown> = {}\n\n    if (event.diff?.before) {\n      safeDiff.before = redactPHI(event.diff.before as Record<string, unknown>)\n    }\n    if (event.diff?.after) {\n      safeDiff.after = redactPHI(event.diff.after as Record<string, unknown>)\n    }\n    if (event.diff?.changes) {\n      safeDiff.changes = redactPHI(event.diff.changes as Record<string, unknown>)\n    }\n\n    // Prepare audit log entry\n    const auditEntry: Database['public']['Tables']['audit_log']['Insert'] = {\n      org_id: event.org_id || null,\n      actor_user_id: event.actor_user_id || null,\n      actor_role: event.actor_role || null,\n      source: event.source,\n      entity_type: event.entity_type,\n      entity_id: event.entity_id,\n      action: event.action,\n      diff: (safeDiff as Json) || {},\n      metadata: (safeMetadata as Json) || {},\n    }\n\n    // Insert audit log\n    const { data, error } = await supabase\n      .from('audit_log')\n      .insert(auditEntry)\n      .select('id')\n      .single()\n\n    if (error) {\n      console.error('[audit/log] Failed to insert audit event', {\n        error,\n        entity_type: event.entity_type,\n        entity_id: event.entity_id,\n        action: event.action,\n      })\n      return { success: false, error: error.message }\n    }\n\n    const duration = Date.now() - startTime\n    console.log('[audit/log] Audit event logged successfully', {\n      audit_id: data.id,\n      entity_type: event.entity_type,\n      entity_id: event.entity_id,\n      action: event.action,\n      duration_ms: duration,\n    })\n\n    return { success: true, audit_id: data.id }\n  } catch (err) {\n    console.error('[audit/log] Unexpected error logging audit event', err)\n    return {\n      success: false,\n      error: err instanceof Error ? err.message : 'Unknown error',\n    }\n  }\n}\n\n// ============================================================\n// Helper Functions for Common Audit Scenarios\n// ============================================================\n\n/**\n * Logs a report generation event\n */\nexport async function logReportGenerated(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  report_id: string\n  assessment_id: string\n  algorithm_version?: string\n  prompt_version?: string\n  report_version?: string\n  safety_score?: number\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'report',\n    entity_id: params.report_id,\n    action: 'generate',\n    metadata: {\n      assessment_id: params.assessment_id,\n      algorithm_version: params.algorithm_version,\n      prompt_version: params.prompt_version,\n      report_version: params.report_version,\n      safety_score: params.safety_score,\n    },\n  })\n}\n\n/**\n * Logs a report flagged event (safety findings)\n */\nexport async function logReportFlagged(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  report_id: string\n  safety_score?: number\n  finding_count?: number\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'system',\n    entity_type: 'report',\n    entity_id: params.report_id,\n    action: 'flag',\n    metadata: {\n      safety_score: params.safety_score,\n      finding_count: params.finding_count,\n    },\n  })\n}\n\n/**\n * Logs a report approval/rejection event\n */\nexport async function logReportReviewed(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  report_id: string\n  action: 'approve' | 'reject'\n  reason?: string\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'report',\n    entity_id: params.report_id,\n    action: params.action,\n    metadata: {\n      reason: params.reason,\n    },\n  })\n}\n\n/**\n * Logs a task lifecycle event\n */\nexport async function logTaskEvent(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  task_id: string\n  action: AuditAction\n  status_from?: string\n  status_to?: string\n  assigned_to_role?: UserRole\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'task',\n    entity_id: params.task_id,\n    action: params.action,\n    metadata: {\n      status_from: params.status_from,\n      status_to: params.status_to,\n      assigned_to_role: params.assigned_to_role,\n    },\n  })\n}\n\n/**\n * Logs a funnel activation/deactivation event\n */\nexport async function logFunnelConfigChange(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  funnel_id: string\n  action: 'activate' | 'deactivate'\n  is_active: boolean\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'admin-ui',\n    entity_type: 'funnel_catalog',\n    entity_id: params.funnel_id,\n    action: params.action,\n    diff: {\n      after: { is_active: params.is_active },\n    },\n  })\n}\n\n/**\n * Logs a funnel version rollout change\n */\nexport async function logFunnelVersionRollout(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  version_id: string\n  rollout_percent_from?: number\n  rollout_percent_to: number\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'admin-ui',\n    entity_type: 'funnel_version',\n    entity_id: params.version_id,\n    action: 'rollout',\n    diff: {\n      before: { rollout_percent: params.rollout_percent_from },\n      after: { rollout_percent: params.rollout_percent_to },\n    },\n  })\n}\n\n/**\n * Logs a consent record change\n */\nexport async function logConsentChange(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  consent_id: string\n  action: AuditAction\n  consent_type?: string\n  granted?: boolean\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'consent',\n    entity_id: params.consent_id,\n    action: params.action,\n    metadata: {\n      consent_type: params.consent_type,\n      granted: params.granted,\n    },\n  })\n}\n\n/**\n * Logs a support case creation event\n */\nexport async function logSupportCaseCreated(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  support_case_id: string\n  category?: string\n  priority?: string\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'support_case',\n    entity_id: params.support_case_id,\n    action: 'create',\n    metadata: {\n      // PHI-safe: NO patient_id, only category/priority metadata\n      has_notes: false,\n    },\n  })\n}\n\n/**\n * Logs a support case escalation event\n * This creates both an audit log entry and updates the support case\n */\nexport async function logSupportCaseEscalated(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  support_case_id: string\n  task_id: string\n  assigned_to_role: UserRole\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'support_case',\n    entity_id: params.support_case_id,\n    action: 'escalate',\n    metadata: {\n      task_id: params.task_id,\n      assigned_to_role: params.assigned_to_role,\n    },\n  })\n}\n\n/**\n * Logs a support case status update event\n */\nexport async function logSupportCaseStatusChanged(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  support_case_id: string\n  status_from: string\n  status_to: string\n  has_notes?: boolean\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'support_case',\n    entity_id: params.support_case_id,\n    action: 'update',\n    metadata: {\n      status_from: params.status_from,\n      status_to: params.status_to,\n      has_notes: params.has_notes ?? false,\n    },\n  })\n}\n\n// ============================================================\n// Account Lifecycle Events (V05-I10.2)\n// ============================================================\n\n/**\n * Logs an account deletion request event\n * User has requested to delete their account (GDPR Article 17)\n */\nexport async function logAccountDeletionRequest(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  account_id: string\n  deletion_reason?: string\n  scheduled_for?: string\n  retention_period_days?: number\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'account',\n    entity_id: params.account_id,\n    action: 'deletion_request',\n    metadata: {\n      deletion_reason: params.deletion_reason,\n      scheduled_for: params.scheduled_for,\n      retention_period_days: params.retention_period_days,\n    },\n  })\n}\n\n/**\n * Logs an account deletion cancellation event\n * User cancelled their deletion request during retention period\n */\nexport async function logAccountDeletionCancel(params: {\n  org_id?: string\n  actor_user_id: string\n  actor_role: UserRole\n  account_id: string\n  cancellation_reason?: string\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'api',\n    entity_type: 'account',\n    entity_id: params.account_id,\n    action: 'deletion_cancel',\n    metadata: {\n      reason: params.cancellation_reason,\n    },\n  })\n}\n\n/**\n * Logs an account deletion execution event\n * System or admin executed the account deletion\n */\nexport async function logAccountDeletionExecute(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  account_id: string\n  records_deleted?: number\n  records_anonymized?: number\n  executed_by?: string\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: params.executed_by === 'system' ? 'system' : 'admin-ui',\n    entity_type: 'account',\n    entity_id: params.account_id,\n    action: 'deletion_execute',\n    metadata: {\n      records_deleted: params.records_deleted,\n      records_anonymized: params.records_anonymized,\n      executed_by: params.executed_by,\n    },\n  })\n}\n\n/**\n * Logs an account anonymization event\n * Records were anonymized instead of deleted (retention requirements)\n */\nexport async function logAccountAnonymize(params: {\n  org_id?: string\n  actor_user_id?: string\n  actor_role?: UserRole\n  account_id: string\n  records_anonymized: number\n  anonymization_reason?: string\n}): Promise<AuditLogResult> {\n  return logAuditEvent({\n    org_id: params.org_id,\n    actor_user_id: params.actor_user_id,\n    actor_role: params.actor_role,\n    source: 'system',\n    entity_type: 'account',\n    entity_id: params.account_id,\n    action: 'anonymize',\n    metadata: {\n      records_anonymized: params.records_anonymized,\n      reason: params.anonymization_reason,\n    },\n  })\n}\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","/**\n * Onboarding Server Actions\n * \n * Server-side handlers for patient onboarding flow.\n * Handles consent recording and baseline profile management with:\n * - Idempotent operations\n * - RLS enforcement\n * - Audit logging\n * \n * @module lib/actions/onboarding\n */\n\n'use server'\n\nimport { createServerSupabaseClient } from '@/lib/db/supabase.server'\nimport {\n  ConsentFormSchema,\n  BaselineProfileSchema,\n  type OnboardingStatus,\n  type ConsentRecord,\n  type PatientProfile,\n  CURRENT_CONSENT_VERSION,\n} from '@/lib/contracts/onboarding'\nimport { logAuditEvent } from '@/lib/audit'\nimport { env } from '@/lib/env'\n\n// PostgreSQL error codes\nconst PG_ERROR_UNIQUE_VIOLATION = '23505'\n\n// ============================================================\n// Types\n// ============================================================\n\ntype ActionResult<T> = {\n  success: boolean\n  data?: T\n  error?: string\n}\n\n// ============================================================\n// Helper: Get Authenticated Supabase Client\n// ============================================================\n\nasync function getAuthenticatedClient() {\n  const supabase = await createServerSupabaseClient()\n\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser()\n\n  if (authError || !user) {\n    return { supabase: null, user: null, error: 'Not authenticated' }\n  }\n\n  return { supabase, user, error: null }\n}\n\n// ============================================================\n// Consent Actions\n// ============================================================\n\n/**\n * Records user consent to terms and conditions\n * Idempotent: Returns success if consent already recorded for this version\n * \n * @param formData - Consent form data with agreedToTerms flag\n * @returns Result with consent record or error\n */\nexport async function recordConsent(formData: {\n  consentVersion: string\n  agreedToTerms: boolean\n}): Promise<ActionResult<ConsentRecord>> {\n  try {\n    // Validate input\n    const validationResult = ConsentFormSchema.safeParse(formData)\n    if (!validationResult.success) {\n      const firstError = validationResult.error.issues[0]\n      return {\n        success: false,\n        error: firstError?.message || 'Invalid consent data',\n      }\n    }\n\n    // Get authenticated client\n    const { supabase, user, error: authError } = await getAuthenticatedClient()\n    if (authError || !supabase || !user) {\n      return { success: false, error: authError || 'Authentication failed' }\n    }\n\n    // Check if consent already exists (idempotent check)\n    // Use limit(1) instead of maybeSingle() to avoid hard failures if duplicates exist.\n    const { data: existingConsents, error: existingConsentError } = await supabase\n      .from('user_consents')\n      .select('*')\n      .eq('user_id', user.id)\n      .eq('consent_version', formData.consentVersion)\n      .order('consented_at', { ascending: false })\n      .limit(1)\n\n    if (existingConsentError) {\n      console.error('[onboarding/recordConsent] Existing consent check error:', existingConsentError)\n      return {\n        success: false,\n        error: 'Failed to check existing consent',\n      }\n    }\n\n    const existingConsent = existingConsents?.[0]\n\n    if (existingConsent) {\n      // Already consented - idempotent success\n      return {\n        success: true,\n        data: existingConsent as ConsentRecord,\n      }\n    }\n\n    // Insert new consent record\n    const { data, error } = await supabase\n      .from('user_consents')\n      .insert({\n        user_id: user.id,\n        consent_version: formData.consentVersion,\n      })\n      .select()\n      .single()\n\n    if (error) {\n      // Idempotent under races: if another request inserted concurrently, treat as success.\n      if ((error as { code?: string } | null)?.code === PG_ERROR_UNIQUE_VIOLATION) {\n        const { data: retryData, error: retryError } = await supabase\n          .from('user_consents')\n          .select('*')\n          .eq('user_id', user.id)\n          .eq('consent_version', formData.consentVersion)\n          .order('consented_at', { ascending: false })\n          .limit(1)\n\n        if (retryError) {\n          console.error('[onboarding/recordConsent] Retry after conflict failed:', retryError)\n          return { success: false, error: 'Failed to record consent' }\n        }\n\n        const retryConsent = retryData?.[0]\n        if (retryConsent) {\n          return { success: true, data: retryConsent as ConsentRecord }\n        }\n      }\n\n      console.error('[onboarding/recordConsent] Database error:', error)\n      return { success: false, error: 'Failed to record consent' }\n    }\n\n    // Log audit event\n    await logAuditEvent({\n      source: 'api',\n      entity_type: 'consent',\n      entity_id: data.id,\n      action: 'create',\n      actor_user_id: user.id,\n      metadata: {\n        consent_version: formData.consentVersion,\n      },\n    })\n\n    return {\n      success: true,\n      data: data as ConsentRecord,\n    }\n  } catch (err) {\n    console.error('[onboarding/recordConsent] Unexpected error:', err)\n    return {\n      success: false,\n      error: err instanceof Error ? err.message : 'Unexpected error',\n    }\n  }\n}\n\n/**\n * Checks if user has consented to current version\n * \n * @returns Result with boolean indicating consent status\n */\nexport async function hasUserConsented(): Promise<ActionResult<boolean>> {\n  try {\n    const { supabase, user, error: authError } = await getAuthenticatedClient()\n    if (authError || !supabase || !user) {\n      return { success: false, error: authError || 'Authentication failed' }\n    }\n\n    const { data, error } = await supabase\n      .from('user_consents')\n      .select('id')\n      .eq('user_id', user.id)\n      .eq('consent_version', CURRENT_CONSENT_VERSION)\n      .order('consented_at', { ascending: false })\n      .limit(1)\n\n    if (error) {\n      console.error('[onboarding/hasUserConsented] Database error:', error)\n      return { success: false, error: 'Failed to check consent status' }\n    }\n\n    return {\n      success: true,\n      data: (data?.length ?? 0) > 0,\n    }\n  } catch (err) {\n    console.error('[onboarding/hasUserConsented] Unexpected error:', err)\n    return {\n      success: false,\n      error: err instanceof Error ? err.message : 'Unexpected error',\n    }\n  }\n}\n\n// ============================================================\n// Baseline Profile Actions\n// ============================================================\n\n/**\n * Saves or updates patient baseline profile\n * Idempotent: Upserts profile data\n * \n * @param profileData - Baseline profile data\n * @returns Result with patient profile or error\n */\nexport async function saveBaselineProfile(\n  profileData: Partial<{\n    full_name: string\n    birth_year: number | null\n    sex: string | null\n  }>,\n): Promise<ActionResult<PatientProfile>> {\n  try {\n    // Validate input\n    const validationResult = BaselineProfileSchema.safeParse(profileData)\n    if (!validationResult.success) {\n      const firstError = validationResult.error.issues[0]\n      return {\n        success: false,\n        error: firstError?.message || 'Invalid profile data',\n      }\n    }\n\n    // Get authenticated client\n    const { supabase, user, error: authError } = await getAuthenticatedClient()\n    if (authError || !supabase || !user) {\n      return { success: false, error: authError || 'Authentication failed' }\n    }\n\n    // Check if profile exists\n    const { data: existingProfiles, error: existingProfileError } = await supabase\n      .from('patient_profiles')\n      .select('*')\n      .eq('user_id', user.id)\n      .order('created_at', { ascending: false })\n      .limit(1)\n\n    if (existingProfileError) {\n      console.error('[onboarding/saveBaselineProfile] Existing profile check error:', existingProfileError)\n      return { success: false, error: 'Failed to check profile' }\n    }\n\n    const existingProfile = existingProfiles?.[0]\n\n    let result: PatientProfile | null = null\n    let isUpdate = false\n   \n    if (existingProfile) {\n      // Update existing profile and mark onboarding as completed (E6.4.2 AC1)\n      isUpdate = true\n      const { data, error } = await supabase\n        .from('patient_profiles')\n        .update({\n          full_name: validationResult.data.full_name,\n          birth_year: validationResult.data.birth_year,\n          sex: validationResult.data.sex,\n          onboarding_status: 'completed',\n        })\n        .eq('id', (existingProfile as { id: string }).id)\n        .select()\n        .single()\n\n      if (error) {\n        console.error('[onboarding/saveBaselineProfile] Update error:', error)\n        return { success: false, error: 'Failed to update profile' }\n      }\n      result = data as PatientProfile\n    } else {\n      // Insert new profile and mark onboarding as completed (E6.4.2 AC1)\n      const { data, error } = await supabase\n        .from('patient_profiles')\n        .insert({\n          user_id: user.id,\n          full_name: validationResult.data.full_name,\n          birth_year: validationResult.data.birth_year,\n          sex: validationResult.data.sex,\n          onboarding_status: 'completed',\n        })\n        .select()\n        .single()\n\n      if (error) {\n        // Idempotent under races: if a concurrent request inserted a profile, update the latest.\n        if ((error as { code?: string } | null)?.code === PG_ERROR_UNIQUE_VIOLATION) {\n          const { data: retryProfiles, error: retryExistingError } = await supabase\n            .from('patient_profiles')\n            .select('*')\n            .eq('user_id', user.id)\n            .order('created_at', { ascending: false })\n            .limit(1)\n\n          if (retryExistingError) {\n            console.error(\n              '[onboarding/saveBaselineProfile] Retry fetch after conflict failed:',\n              retryExistingError,\n            )\n            return { success: false, error: 'Failed to create profile' }\n          }\n\n          const retryExisting = retryProfiles?.[0]\n          if (!retryExisting) {\n            return { success: false, error: 'Failed to create profile' }\n          }\n\n          isUpdate = true\n          const { data: retryUpdateData, error: retryUpdateError } = await supabase\n            .from('patient_profiles')\n            .update({\n              full_name: validationResult.data.full_name,\n              birth_year: validationResult.data.birth_year,\n              sex: validationResult.data.sex,\n              onboarding_status: 'completed',\n            })\n            .eq('id', (retryExisting as { id: string }).id)\n            .select()\n            .single()\n\n          if (retryUpdateError) {\n            console.error(\n              '[onboarding/saveBaselineProfile] Retry update after conflict failed:',\n              retryUpdateError,\n            )\n            return { success: false, error: 'Failed to update profile' }\n          }\n\n          result = retryUpdateData\n        } else {\n          console.error('[onboarding/saveBaselineProfile] Insert error:', error)\n          return { success: false, error: 'Failed to create profile' }\n        }\n      }\n      if (!result) {\n        result = data as PatientProfile\n      }\n    }\n\n    if (!result) {\n      return { success: false, error: 'Failed to save profile' }\n    }\n\n    // Log audit event\n    await logAuditEvent({\n      source: 'api',\n      entity_type: 'consent', // Using 'consent' as profile entity type not in registry\n      entity_id: result.id,\n      action: isUpdate ? 'update' : 'create',\n      actor_user_id: user.id,\n      metadata: {\n        profile_updated: 'baseline',\n      },\n    })\n\n    return {\n      success: true,\n      data: result,\n    }\n  } catch (err) {\n    console.error('[onboarding/saveBaselineProfile] Unexpected error:', err)\n    return {\n      success: false,\n      error: err instanceof Error ? err.message : 'Unexpected error',\n    }\n  }\n}\n\n/**\n * Gets user's baseline profile\n * \n * @returns Result with patient profile or null if not found\n */\nexport async function getBaselineProfile(): Promise<ActionResult<PatientProfile | null>> {\n  try {\n    const { supabase, user, error: authError } = await getAuthenticatedClient()\n    if (authError || !supabase || !user) {\n      return { success: false, error: authError || 'Authentication failed' }\n    }\n\n    const { data, error } = await supabase\n      .from('patient_profiles')\n      .select('*')\n      .eq('user_id', user.id)\n      .order('created_at', { ascending: false })\n      .limit(1)\n\n    if (error) {\n      console.error('[onboarding/getBaselineProfile] Database error:', error)\n      return { success: false, error: 'Failed to fetch profile' }\n    }\n\n    return {\n      success: true,\n      data: (data?.[0] as PatientProfile | undefined) ?? null,\n    }\n  } catch (err) {\n    console.error('[onboarding/getBaselineProfile] Unexpected error:', err)\n    return {\n      success: false,\n      error: err instanceof Error ? err.message : 'Unexpected error',\n    }\n  }\n}\n\n// ============================================================\n// Onboarding Status\n// ============================================================\n\n/**\n * Gets overall onboarding status\n * Checks if user has completed consent and baseline profile\n * \n * @returns Onboarding completion status\n */\nexport async function getOnboardingStatus(): Promise<ActionResult<OnboardingStatus>> {\n  try {\n    const { supabase, user, error: authError } = await getAuthenticatedClient()\n    if (authError || !supabase || !user) {\n      return { success: false, error: authError || 'Authentication failed' }\n    }\n\n    // Check consent\n    const { data: consentData, error: consentError } = await supabase\n      .from('user_consents')\n      .select('id')\n      .eq('user_id', user.id)\n      .eq('consent_version', CURRENT_CONSENT_VERSION)\n      .order('consented_at', { ascending: false })\n      .limit(1)\n\n    if (consentError) {\n      console.error('[onboarding/getOnboardingStatus] Consent check error:', consentError)\n      return { success: false, error: 'Failed to check onboarding status' }\n    }\n\n    const hasConsent = (consentData?.length ?? 0) > 0\n\n    // Check profile (must have at least full_name) and get onboarding_status (E6.4.2)\n    const { data: profileData, error: profileError } = await supabase\n      .from('patient_profiles')\n      .select('id, full_name, onboarding_status')\n      .eq('user_id', user.id)\n      .order('created_at', { ascending: false })\n      .limit(1)\n\n    if (profileError) {\n      console.error('[onboarding/getOnboardingStatus] Profile check error:', profileError)\n      return { success: false, error: 'Failed to check onboarding status' }\n    }\n\n    const firstProfile = profileData?.[0]\n    const hasProfile = !!(firstProfile && (firstProfile as { full_name?: string | null }).full_name)\n    const onboardingStatus = (firstProfile as { onboarding_status?: string })?.onboarding_status\n\n    return {\n      success: true,\n      data: {\n        hasConsent,\n        hasProfile,\n        isComplete: hasConsent && hasProfile,\n        status: onboardingStatus as 'not_started' | 'in_progress' | 'completed' | undefined,\n      },\n    }\n  } catch (err) {\n    console.error('[onboarding/getOnboardingStatus] Unexpected error:', err)\n    return {\n      success: false,\n      error: err instanceof Error ? err.message : 'Unexpected error',\n    }\n  }\n}\n","/**\n * Onboarding Contracts\n * \n * Zod schemas and types for patient onboarding flow:\n * - Consent management\n * - Baseline profile collection\n * \n * @module lib/contracts/onboarding\n */\n\nimport { z } from 'zod'\nimport { PATIENT_SEX } from '@/lib/contracts/registry'\n\n// ============================================================\n// Consent Contracts\n// ============================================================\n\n/**\n * Current consent version\n * Must match the version stored in database\n */\nexport const CURRENT_CONSENT_VERSION = '1.0.0'\n\n/**\n * Consent form schema\n */\nexport const ConsentFormSchema = z.object({\n  consentVersion: z.string().min(1, 'Consent version is required'),\n  agreedToTerms: z.boolean().refine(val => val === true, {\n    message: 'You must agree to the terms to continue',\n  }),\n})\n\nexport type ConsentFormData = z.infer<typeof ConsentFormSchema>\n\n/**\n * Consent record from database\n */\nexport const ConsentRecordSchema = z.object({\n  id: z.string().uuid(),\n  user_id: z.string().uuid(),\n  consent_version: z.string(),\n  consented_at: z.string().datetime(),\n  ip_address: z.string().nullable(),\n  user_agent: z.string().nullable(),\n})\n\nexport type ConsentRecord = z.infer<typeof ConsentRecordSchema>\n\n// ============================================================\n// Baseline Profile Contracts\n// ============================================================\n\n/**\n * Baseline profile form schema\n * Minimal set of patient demographic data required before assessments\n */\nexport const BaselineProfileSchema = z.object({\n  full_name: z\n    .string()\n    .min(1, 'Name is required')\n    .max(200, 'Name must be less than 200 characters')\n    .trim(),\n  birth_year: z\n    .number()\n    .int('Birth year must be a whole number')\n    .min(1900, 'Birth year must be 1900 or later')\n    .max(new Date().getFullYear(), 'Birth year cannot be in the future')\n    .optional()\n    .nullable(),\n  sex: z\n    .enum(\n      [PATIENT_SEX.MALE, PATIENT_SEX.FEMALE, PATIENT_SEX.OTHER, PATIENT_SEX.PREFER_NOT_TO_SAY],\n      {\n        message: 'Please select a valid option',\n      },\n    )\n    .optional()\n    .nullable(),\n})\n\nexport type BaselineProfileData = z.infer<typeof BaselineProfileSchema>\n\n/**\n * Onboarding status enum values (E6.4.2)\n */\nexport const ONBOARDING_STATUS = {\n  NOT_STARTED: 'not_started',\n  IN_PROGRESS: 'in_progress',\n  COMPLETED: 'completed',\n} as const\n\nexport type OnboardingStatusValue = (typeof ONBOARDING_STATUS)[keyof typeof ONBOARDING_STATUS]\n\n/**\n * Patient profile record from database\n */\nexport const PatientProfileSchema = z.object({\n  id: z.string().uuid(),\n  user_id: z.string().uuid(),\n  created_at: z.string().datetime(),\n  full_name: z.string().nullable(),\n  birth_year: z.number().nullable(),\n  sex: z.string().nullable(),\n  onboarding_status: z.enum(['not_started', 'in_progress', 'completed']).optional(),\n})\n\nexport type PatientProfile = z.infer<typeof PatientProfileSchema>\n\n// ============================================================\n// Onboarding Status\n// ============================================================\n\n/**\n * Onboarding completion status\n */\nexport const OnboardingStatusSchema = z.object({\n  hasConsent: z.boolean(),\n  hasProfile: z.boolean(),\n  isComplete: z.boolean(),\n  status: z.enum(['not_started', 'in_progress', 'completed']).optional(),\n})\n\nexport type OnboardingStatus = z.infer<typeof OnboardingStatusSchema>\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[1,3]}