module.exports=[77598,a=>{"use strict";let b={STRESS_ASSESSMENT:"stress-assessment",CARDIOVASCULAR_AGE:"cardiovascular-age",SLEEP_QUALITY:"sleep-quality",HEART_HEALTH_NUTRITION:"heart-health-nutrition",STRESS:"stress",STRESS_CHECK:"stress-check",STRESS_CHECK_V2:"stress-check-v2"},c={stress:b.STRESS_ASSESSMENT,"stress-check":b.STRESS_ASSESSMENT,"stress-check-v2":b.STRESS_ASSESSMENT};function d(a){let b=a.toLowerCase().trim();return c[b]||b}function e(a){let c=d(a);return Object.values(b).includes(c)}a.s(["AUDIT_ACTION",0,{CREATE:"create",UPDATE:"update",DELETE:"delete",APPROVE:"approve",REJECT:"reject",REQUEST_CHANGES:"request_changes",GENERATE:"generate",FLAG:"flag",ASSIGN:"assign",ACTIVATE:"activate",DEACTIVATE:"deactivate",ROLLOUT:"rollout",COMPLETE:"complete",ESCALATE:"escalate",DELETION_REQUEST:"deletion_request",DELETION_CANCEL:"deletion_cancel",DELETION_EXECUTE:"deletion_execute",ANONYMIZE:"anonymize"},"AUDIT_ENTITY_TYPE",0,{ASSESSMENT:"assessment",REPORT:"report",TASK:"task",FUNNEL_VERSION:"funnel_version",FUNNEL_CATALOG:"funnel_catalog",CONFIG:"config",CONSENT:"consent",ORGANIZATION:"organization",USER_ORG_MEMBERSHIP:"user_org_membership",CLINICIAN_ASSIGNMENT:"clinician_assignment",DOCUMENT:"document",PROCESSING_JOB:"processing_job",REVIEW_RECORD:"review_record",PRE_SCREENING_CALL:"pre_screening_call",DEVICE_SHIPMENT:"device_shipment",SUPPORT_CASE:"support_case",ACCOUNT:"account"},"AUDIT_SOURCE",0,{API:"api",JOB:"job",ADMIN_UI:"admin-ui",SYSTEM:"system"},"FUNNEL_SLUG_ALIASES",0,c,"PATIENT_SEX",0,{MALE:"male",FEMALE:"female",OTHER:"other",PREFER_NOT_TO_SAY:"prefer_not_to_say"},"QUESTION_TYPE",0,{RADIO:"radio",CHECKBOX:"checkbox",TEXT:"text",TEXTAREA:"textarea",NUMBER:"number",SCALE:"scale",SLIDER:"slider"},"getCanonicalFunnelSlug",()=>d,"isKnownFunnelSlug",()=>e])},37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},28916,30382,a=>{"use strict";var b=a.i(45618),c=a.i(7779);let d=["request_id","correlation_id","algorithm_version","prompt_version","report_version","version","safety_score","finding_count","status_from","status_to","assigned_to_role","reason","consent_type","granted","rollout_percent","rollout_percent_from","rollout_percent_to","is_active","assessment_id","report_id","task_id","funnel_id","version_id","consent_id","config_key","consent_version","profile_updated","review_id","job_id","decision_reason","has_notes","deletion_reason","scheduled_for","retention_period_days","records_deleted","records_anonymized","executed_by","anonymization_reason","kpi_event","funnel_slug","drop_off_reason","current_step_id","step_order_index","duration_seconds","duration_before_drop_seconds","started_at","completed_at","time_to_report_seconds","report_created_at","error_type"],e=["content","text","notes","answers","answer","response","extracted_data","clinical_notes","patient_notes","observation","diagnosis","medication","name","email","phone","address","ssn","dob","date_of_birth"];function f(a,b=5e3){if(!a||"object"!=typeof a)return{};let c={},g=0;for(let[h,i]of Object.entries(a)){let a=h.toLowerCase();if(e.some(b=>a.includes(b))){c[h]="[REDACTED]";continue}let j=d.includes(h);if("number"==typeof i||"boolean"==typeof i)c[h]=i,g+=String(i).length;else if("string"==typeof i){let b=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(i),d=i.length<=100&&!/[<>{}]/.test(i);j||b||d&&a.includes("id")?(c[h]=i,g+=i.length):c[h]="[REDACTED]"}else null==i?c[h]=i:"object"!=typeof i||Array.isArray(i)?c[h]="[REDACTED]":(c[h]=f(i,b-g),g+=JSON.stringify(c[h]).length);if(g>b){console.warn("[audit/log] Metadata/diff size exceeded limit, truncating");break}}return c}async function g(a){Date.now();try{let d,e;if(!a.entity_type)return{success:!1,error:"entity_type is required"};if(!a.entity_id)return{success:!1,error:"entity_id is required"};if(!a.action)return{success:!1,error:"action is required"};if(!a.source)return{success:!1,error:"source is required"};let g=(d=c.env.NEXT_PUBLIC_SUPABASE_URL||c.env.SUPABASE_URL,e=c.env.SUPABASE_SERVICE_ROLE_KEY||c.env.SUPABASE_SERVICE_KEY,d&&e?(0,b.createClient)(d,e,{auth:{persistSession:!1}}):(console.error("[audit/log] Missing Supabase credentials"),null));if(!g)return console.error("[audit/log] Cannot create Supabase client"),{success:!1,error:"Supabase client unavailable"};let h=f(a.metadata||{}),i={};a.diff?.before&&(i.before=f(a.diff.before)),a.diff?.after&&(i.after=f(a.diff.after)),a.diff?.changes&&(i.changes=f(a.diff.changes));let j={org_id:a.org_id||null,actor_user_id:a.actor_user_id||null,actor_role:a.actor_role||null,source:a.source,entity_type:a.entity_type,entity_id:a.entity_id,action:a.action,diff:i||{},metadata:h||{}},{data:k,error:l}=await g.from("audit_log").insert(j).select("id").single();if(l)return console.error("[audit/log] Failed to insert audit event",{error:l,entity_type:a.entity_type,entity_id:a.entity_id,action:a.action}),{success:!1,error:l.message};return Date.now(),{success:!0,audit_id:k.id}}catch(a){return console.error("[audit/log] Unexpected error logging audit event",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}a.s(["logAuditEvent",()=>g],30382),a.s([],28916)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},9847,a=>{"use strict";var b=a.i(37936),c=a.i(91896),d=a.i(53112),e=a.i(77598);let f="1.0.0",g=d.z.object({consentVersion:d.z.string().min(1,"Consent version is required"),agreedToTerms:d.z.boolean().refine(a=>!0===a,{message:"You must agree to the terms to continue"})});d.z.object({id:d.z.string().uuid(),user_id:d.z.string().uuid(),consent_version:d.z.string(),consented_at:d.z.string().datetime(),ip_address:d.z.string().nullable(),user_agent:d.z.string().nullable()});let h=d.z.object({full_name:d.z.string().min(1,"Name is required").max(200,"Name must be less than 200 characters").trim(),birth_year:d.z.number().int("Birth year must be a whole number").min(1900,"Birth year must be 1900 or later").max(new Date().getFullYear(),"Birth year cannot be in the future").optional().nullable(),sex:d.z.enum([e.PATIENT_SEX.MALE,e.PATIENT_SEX.FEMALE,e.PATIENT_SEX.OTHER,e.PATIENT_SEX.PREFER_NOT_TO_SAY],{message:"Please select a valid option"}).optional().nullable()});d.z.object({id:d.z.string().uuid(),user_id:d.z.string().uuid(),created_at:d.z.string().datetime(),full_name:d.z.string().nullable(),birth_year:d.z.number().nullable(),sex:d.z.string().nullable(),onboarding_status:d.z.enum(["not_started","in_progress","completed"]).optional()}),d.z.object({hasConsent:d.z.boolean(),hasProfile:d.z.boolean(),isComplete:d.z.boolean(),status:d.z.enum(["not_started","in_progress","completed"]).optional()}),a.i(28916);var i=a.i(30382),j=a.i(13095);let k="23505";async function l(){let a=await (0,c.createServerSupabaseClient)(),{data:{user:b},error:d}=await a.auth.getUser();return d||!b?{supabase:null,user:null,error:"Not authenticated"}:{supabase:a,user:b,error:null}}async function m(a){try{let b=g.safeParse(a);if(!b.success){let a=b.error.issues[0];return{success:!1,error:a?.message||"Invalid consent data"}}let{supabase:c,user:d,error:e}=await l();if(e||!c||!d)return{success:!1,error:e||"Authentication failed"};let{data:f,error:h}=await c.from("user_consents").select("*").eq("user_id",d.id).eq("consent_version",a.consentVersion).order("consented_at",{ascending:!1}).limit(1);if(h)return console.error("[onboarding/recordConsent] Existing consent check error:",h),{success:!1,error:"Failed to check existing consent"};let j=f?.[0];if(j)return{success:!0,data:j};let{data:m,error:n}=await c.from("user_consents").insert({user_id:d.id,consent_version:a.consentVersion}).select().single();if(n){if(n?.code===k){let{data:b,error:e}=await c.from("user_consents").select("*").eq("user_id",d.id).eq("consent_version",a.consentVersion).order("consented_at",{ascending:!1}).limit(1);if(e)return console.error("[onboarding/recordConsent] Retry after conflict failed:",e),{success:!1,error:"Failed to record consent"};let f=b?.[0];if(f)return{success:!0,data:f}}return console.error("[onboarding/recordConsent] Database error:",n),{success:!1,error:"Failed to record consent"}}return await (0,i.logAuditEvent)({source:"api",entity_type:"consent",entity_id:m.id,action:"create",actor_user_id:d.id,metadata:{consent_version:a.consentVersion}}),{success:!0,data:m}}catch(a){return console.error("[onboarding/recordConsent] Unexpected error:",a),{success:!1,error:a instanceof Error?a.message:"Unexpected error"}}}async function n(){try{let{supabase:a,user:b,error:c}=await l();if(c||!a||!b)return{success:!1,error:c||"Authentication failed"};let{data:d,error:e}=await a.from("user_consents").select("id").eq("user_id",b.id).eq("consent_version",f).order("consented_at",{ascending:!1}).limit(1);if(e)return console.error("[onboarding/hasUserConsented] Database error:",e),{success:!1,error:"Failed to check consent status"};return{success:!0,data:(d?.length??0)>0}}catch(a){return console.error("[onboarding/hasUserConsented] Unexpected error:",a),{success:!1,error:a instanceof Error?a.message:"Unexpected error"}}}async function o(a){try{let b=h.safeParse(a);if(!b.success){let a=b.error.issues[0];return{success:!1,error:a?.message||"Invalid profile data"}}let{supabase:c,user:d,error:e}=await l();if(e||!c||!d)return{success:!1,error:e||"Authentication failed"};let{data:f,error:g}=await c.from("patient_profiles").select("*").eq("user_id",d.id).order("created_at",{ascending:!1}).limit(1);if(g)return console.error("[onboarding/saveBaselineProfile] Existing profile check error:",g),{success:!1,error:"Failed to check profile"};let j=f?.[0],m=null,n=!1;if(j){n=!0;let{data:a,error:d}=await c.from("patient_profiles").update({full_name:b.data.full_name,birth_year:b.data.birth_year,sex:b.data.sex,onboarding_status:"completed"}).eq("id",j.id).select().single();if(d)return console.error("[onboarding/saveBaselineProfile] Update error:",d),{success:!1,error:"Failed to update profile"};m=a}else{let{data:a,error:e}=await c.from("patient_profiles").insert({user_id:d.id,full_name:b.data.full_name,birth_year:b.data.birth_year,sex:b.data.sex,onboarding_status:"completed"}).select().single();if(e)if(e?.code!==k)return console.error("[onboarding/saveBaselineProfile] Insert error:",e),{success:!1,error:"Failed to create profile"};else{let{data:a,error:e}=await c.from("patient_profiles").select("*").eq("user_id",d.id).order("created_at",{ascending:!1}).limit(1);if(e)return console.error("[onboarding/saveBaselineProfile] Retry fetch after conflict failed:",e),{success:!1,error:"Failed to create profile"};let f=a?.[0];if(!f)return{success:!1,error:"Failed to create profile"};n=!0;let{data:g,error:h}=await c.from("patient_profiles").update({full_name:b.data.full_name,birth_year:b.data.birth_year,sex:b.data.sex,onboarding_status:"completed"}).eq("id",f.id).select().single();if(h)return console.error("[onboarding/saveBaselineProfile] Retry update after conflict failed:",h),{success:!1,error:"Failed to update profile"};m=g}m||(m=a)}if(!m)return{success:!1,error:"Failed to save profile"};return await (0,i.logAuditEvent)({source:"api",entity_type:"consent",entity_id:m.id,action:n?"update":"create",actor_user_id:d.id,metadata:{profile_updated:"baseline"}}),{success:!0,data:m}}catch(a){return console.error("[onboarding/saveBaselineProfile] Unexpected error:",a),{success:!1,error:a instanceof Error?a.message:"Unexpected error"}}}async function p(){try{let{supabase:a,user:b,error:c}=await l();if(c||!a||!b)return{success:!1,error:c||"Authentication failed"};let{data:d,error:e}=await a.from("patient_profiles").select("*").eq("user_id",b.id).order("created_at",{ascending:!1}).limit(1);if(e)return console.error("[onboarding/getBaselineProfile] Database error:",e),{success:!1,error:"Failed to fetch profile"};return{success:!0,data:d?.[0]??null}}catch(a){return console.error("[onboarding/getBaselineProfile] Unexpected error:",a),{success:!1,error:a instanceof Error?a.message:"Unexpected error"}}}async function q(){try{let{supabase:a,user:b,error:c}=await l();if(c||!a||!b)return{success:!1,error:c||"Authentication failed"};let{data:d,error:e}=await a.from("user_consents").select("id").eq("user_id",b.id).eq("consent_version",f).order("consented_at",{ascending:!1}).limit(1);if(e)return console.error("[onboarding/getOnboardingStatus] Consent check error:",e),{success:!1,error:"Failed to check onboarding status"};let g=(d?.length??0)>0,{data:h,error:i}=await a.from("patient_profiles").select("id, full_name, onboarding_status").eq("user_id",b.id).order("created_at",{ascending:!1}).limit(1);if(i)return console.error("[onboarding/getOnboardingStatus] Profile check error:",i),{success:!1,error:"Failed to check onboarding status"};let j=h?.[0],k=!!(j&&j.full_name),m=j?.onboarding_status;return{success:!0,data:{hasConsent:g,hasProfile:k,isComplete:g&&k,status:m}}}catch(a){return console.error("[onboarding/getOnboardingStatus] Unexpected error:",a),{success:!1,error:a instanceof Error?a.message:"Unexpected error"}}}(0,j.ensureServerEntryExports)([m,n,o,p,q]),(0,b.registerServerReference)(m,"403595fa6e7b7d1b348c37040bb72197646de953f1",null),(0,b.registerServerReference)(n,"009c913e0aa088dff01f2444bc7901c308af146f0a",null),(0,b.registerServerReference)(o,"402ef5f2d5a426118554d6877a28510036b982f22b",null),(0,b.registerServerReference)(p,"006275a56515d43b3044afdff8181f10627efcc3d4",null),(0,b.registerServerReference)(q,"00105aa55569901fed075937f94e047699b08eea27",null),a.s(["getBaselineProfile",()=>p,"getOnboardingStatus",()=>q,"hasUserConsented",()=>n,"recordConsent",()=>m,"saveBaselineProfile",()=>o],9847)}];

//# sourceMappingURL=_bb1250e3._.js.map