{"version":3,"sources":["../../../../../../lib/contracts/registry.ts","../../../../../../apps/rhythm-patient-ui/app/patient/funnel/%5Bslug%5D/result/client.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/rhythm-patient-ui/app/patient/funnel/%5Bslug%5D/result/page.tsx","../../../../../../lib/db/queries/reports.ts"],"sourcesContent":["/**\n * Contract Registry - Canonical Identifiers\n * \n * This file serves as the single source of truth for all critical string identifiers\n * used throughout the application. All new identifiers MUST be added here to prevent\n * \"fantasy names\" and ensure consistency.\n * \n * **IMPORTANT**: This file is protected by CODEOWNERS. Any changes require review.\n * \n * Usage:\n * ```typescript\n * import { ASSESSMENT_STATUS, FUNNEL_SLUG, USER_ROLE } from '@/lib/contracts/registry'\n * \n * const status: AssessmentStatus = ASSESSMENT_STATUS.IN_PROGRESS\n * const funnel: FunnelSlug = FUNNEL_SLUG.STRESS_ASSESSMENT\n * ```\n */\n\n// ============================================================\n// Assessment Statuses\n// ============================================================\n\n/**\n * Valid statuses for assessments\n */\nexport const ASSESSMENT_STATUS = {\n  IN_PROGRESS: 'in_progress',\n  COMPLETED: 'completed',\n} as const\n\nexport type AssessmentStatus = typeof ASSESSMENT_STATUS[keyof typeof ASSESSMENT_STATUS]\n\n// ============================================================\n// Content Page Statuses\n// ============================================================\n\n/**\n * Valid statuses for content pages\n */\nexport const CONTENT_STATUS = {\n  DRAFT: 'draft',\n  PUBLISHED: 'published',\n  ARCHIVED: 'archived',\n} as const\n\nexport type ContentStatus = typeof CONTENT_STATUS[keyof typeof CONTENT_STATUS]\n\n// ============================================================\n// Pillar Keys (7-Pillar Model)\n// ============================================================\n\n/**\n * Valid pillar keys for funnel taxonomy (7-Pillar Wellness Model)\n */\nexport const PILLAR_KEY = {\n  NUTRITION: 'nutrition',\n  MOVEMENT: 'movement',\n  SLEEP: 'sleep',\n  MENTAL_HEALTH: 'mental-health',\n  SOCIAL: 'social',\n  MEANING: 'meaning',\n  PREVENTION: 'prevention',\n} as const\n\nexport type PillarKey = typeof PILLAR_KEY[keyof typeof PILLAR_KEY]\n\n// ============================================================\n// Funnel Slugs\n// ============================================================\n\n/**\n * Valid funnel slugs\n * The canonical slug is the primary identifier\n * Legacy aliases are maintained for backward compatibility\n */\nexport const FUNNEL_SLUG = {\n  STRESS_ASSESSMENT: 'stress-assessment',\n  CARDIOVASCULAR_AGE: 'cardiovascular-age',\n  SLEEP_QUALITY: 'sleep-quality',\n  HEART_HEALTH_NUTRITION: 'heart-health-nutrition',\n  // Legacy aliases - deprecated but maintained for compatibility\n  STRESS: 'stress',\n  STRESS_CHECK: 'stress-check',\n  STRESS_CHECK_V2: 'stress-check-v2',\n} as const\n\nexport type FunnelSlug = typeof FUNNEL_SLUG[keyof typeof FUNNEL_SLUG]\n\n/**\n * Maps legacy funnel slugs to their canonical equivalents\n * Uses lowercase keys for case-insensitive matching\n */\nexport const FUNNEL_SLUG_ALIASES: Record<string, string> = {\n  'stress': FUNNEL_SLUG.STRESS_ASSESSMENT,\n  'stress-check': FUNNEL_SLUG.STRESS_ASSESSMENT,\n  'stress-check-v2': FUNNEL_SLUG.STRESS_ASSESSMENT,\n}\n\n/**\n * Resolves a funnel slug to its canonical form\n * Normalizes input by trimming and converting to lowercase for deterministic matching\n * \n * @param slug - The funnel slug to resolve (case-insensitive, whitespace trimmed)\n * @returns The canonical slug or the normalized input if no mapping exists\n */\nexport function getCanonicalFunnelSlug(slug: string): string {\n  const normalized = slug.toLowerCase().trim()\n  return FUNNEL_SLUG_ALIASES[normalized] || normalized\n}\n\n/**\n * Checks if a funnel slug is known in the registry\n * A funnel is \"known\" if it exists in FUNNEL_SLUG values (canonical or legacy)\n * \n * @param slug - The funnel slug to check (case-insensitive, whitespace trimmed)\n * @returns true if the funnel slug is registered, false otherwise\n */\nexport function isKnownFunnelSlug(slug: string): boolean {\n  const canonical = getCanonicalFunnelSlug(slug)\n  const allSlugs = Object.values(FUNNEL_SLUG)\n  return allSlugs.includes(canonical as FunnelSlug)\n}\n\n// ============================================================\n// Node/Step Types\n// ============================================================\n\n/**\n * Valid node/step types for funnel steps\n * These correspond to the 'type' field in the funnel_steps table\n */\nexport const NODE_TYPE = {\n  QUESTION_STEP: 'question_step',\n  FORM: 'form',\n  INFO_STEP: 'info_step',\n  INFO: 'info',\n  CONTENT_PAGE: 'content_page',\n  SUMMARY: 'summary',\n  OTHER: 'other',\n} as const\n\nexport type NodeType = typeof NODE_TYPE[keyof typeof NODE_TYPE]\n\n// ============================================================\n// User Roles\n// ============================================================\n\n/**\n * Valid user roles\n * These are stored in auth.users.raw_app_meta_data.role\n */\nexport const USER_ROLE = {\n  PATIENT: 'patient',\n  CLINICIAN: 'clinician',\n  ADMIN: 'admin',\n  NURSE: 'nurse',\n} as const\n\nexport type UserRole = typeof USER_ROLE[keyof typeof USER_ROLE]\n\n// ============================================================\n// Question Types\n// ============================================================\n\n/**\n * Valid question types\n * These correspond to the 'question_type' field in the questions table\n */\nexport const QUESTION_TYPE = {\n  RADIO: 'radio',\n  CHECKBOX: 'checkbox',\n  TEXT: 'text',\n  TEXTAREA: 'textarea',\n  NUMBER: 'number',\n  SCALE: 'scale',\n  SLIDER: 'slider',\n} as const\n\nexport type QuestionType = typeof QUESTION_TYPE[keyof typeof QUESTION_TYPE]\n\n// ============================================================\n// Patient Demographics\n// ============================================================\n\n/**\n * Valid sex/gender options for patient profiles\n * These correspond to the 'sex' field in the patient_profiles table\n */\nexport const PATIENT_SEX = {\n  MALE: 'male',\n  FEMALE: 'female',\n  OTHER: 'other',\n  PREFER_NOT_TO_SAY: 'prefer_not_to_say',\n} as const\n\nexport type PatientSex = typeof PATIENT_SEX[keyof typeof PATIENT_SEX]\n\n// ============================================================\n// Feature Flag Names\n// ============================================================\n\n/**\n * Valid feature flag names (without NEXT_PUBLIC_FEATURE_ prefix)\n */\nexport const FEATURE_FLAG = {\n  AMY_ENABLED: 'AMY_ENABLED',\n  CLINICIAN_DASHBOARD_ENABLED: 'CLINICIAN_DASHBOARD_ENABLED',\n  CHARTS_ENABLED: 'CHARTS_ENABLED',\n} as const\n\nexport type FeatureFlag = typeof FEATURE_FLAG[keyof typeof FEATURE_FLAG]\n\n// ============================================================\n// Helper Functions\n// ============================================================\n\n/**\n * Type guard to check if a value is a valid assessment status\n */\nexport function isValidAssessmentStatus(value: unknown): value is AssessmentStatus {\n  return typeof value === 'string' && Object.values(ASSESSMENT_STATUS).includes(value as AssessmentStatus)\n}\n\n/**\n * Type guard to check if a value is a valid content status\n */\nexport function isValidContentStatus(value: unknown): value is ContentStatus {\n  return typeof value === 'string' && Object.values(CONTENT_STATUS).includes(value as ContentStatus)\n}\n\n/**\n * Type guard to check if a value is a valid user role\n */\nexport function isValidUserRole(value: unknown): value is UserRole {\n  return typeof value === 'string' && Object.values(USER_ROLE).includes(value as UserRole)\n}\n\n/**\n * Type guard to check if a value is a valid node type\n */\nexport function isValidNodeType(value: unknown): value is NodeType {\n  return typeof value === 'string' && Object.values(NODE_TYPE).includes(value as NodeType)\n}\n\n/**\n * Type guard to check if a value is a valid pillar key\n */\nexport function isValidPillarKey(value: unknown): value is PillarKey {\n  return typeof value === 'string' && Object.values(PILLAR_KEY).includes(value as PillarKey)\n}\n\n/**\n * Type guard to check if a value is a valid patient sex option\n */\nexport function isValidPatientSex(value: unknown): value is PatientSex {\n  return typeof value === 'string' && Object.values(PATIENT_SEX).includes(value as PatientSex)\n}\n\n// ============================================================\n// Audit Log Entity Types\n// ============================================================\n\n/**\n * Valid entity types for audit logging\n * These correspond to the 'entity_type' field in the audit_log table\n */\nexport const AUDIT_ENTITY_TYPE = {\n  ASSESSMENT: 'assessment',\n  REPORT: 'report',\n  TASK: 'task',\n  FUNNEL_VERSION: 'funnel_version',\n  FUNNEL_CATALOG: 'funnel_catalog',\n  CONFIG: 'config',\n  CONSENT: 'consent',\n  ORGANIZATION: 'organization',\n  USER_ORG_MEMBERSHIP: 'user_org_membership',\n  CLINICIAN_ASSIGNMENT: 'clinician_assignment',\n  DOCUMENT: 'document', // V05-I04.3: Document confirmation tracking\n  PROCESSING_JOB: 'processing_job', // V05-I05.1: Processing job orchestration\n  REVIEW_RECORD: 'review_record', // V05-I05.7: Medical review records\n  PRE_SCREENING_CALL: 'pre_screening_call', // V05-I08.2: Pre-screening call records\n  DEVICE_SHIPMENT: 'device_shipment', // V05-I08.3: Shipment tracking\n  SUPPORT_CASE: 'support_case', // V05-I08.4: Support case documentation\n  ACCOUNT: 'account', // V05-I10.2: Account lifecycle (deletion/retention)\n} as const\n\nexport type AuditEntityType = typeof AUDIT_ENTITY_TYPE[keyof typeof AUDIT_ENTITY_TYPE]\n\n// ============================================================\n// Audit Log Actions\n// ============================================================\n\n/**\n * Valid actions for audit logging\n * These correspond to the 'action' field in the audit_log table\n */\nexport const AUDIT_ACTION = {\n  CREATE: 'create',\n  UPDATE: 'update',\n  DELETE: 'delete',\n  APPROVE: 'approve',\n  REJECT: 'reject',\n  REQUEST_CHANGES: 'request_changes', // V05-I05.7: Review workflow\n  GENERATE: 'generate',\n  FLAG: 'flag',\n  ASSIGN: 'assign',\n  ACTIVATE: 'activate',\n  DEACTIVATE: 'deactivate',\n  ROLLOUT: 'rollout',\n  COMPLETE: 'complete',\n  ESCALATE: 'escalate', // V05-I08.4: Support case escalation\n  DELETION_REQUEST: 'deletion_request', // V05-I10.2: User requested account deletion\n  DELETION_CANCEL: 'deletion_cancel', // V05-I10.2: User cancelled deletion request\n  DELETION_EXECUTE: 'deletion_execute', // V05-I10.2: System executed account deletion\n  ANONYMIZE: 'anonymize', // V05-I10.2: Records anonymized instead of deleted\n} as const\n\nexport type AuditAction = typeof AUDIT_ACTION[keyof typeof AUDIT_ACTION]\n\n// ============================================================\n// Audit Log Sources\n// ============================================================\n\n/**\n * Valid sources for audit logging\n * These correspond to the 'source' field in the audit_log table\n */\nexport const AUDIT_SOURCE = {\n  API: 'api',\n  JOB: 'job',\n  ADMIN_UI: 'admin-ui',\n  SYSTEM: 'system',\n} as const\n\nexport type AuditSource = typeof AUDIT_SOURCE[keyof typeof AUDIT_SOURCE]\n\n// ============================================================\n// Audit Type Guards\n// ============================================================\n\n/**\n * Type guard to check if a value is a valid audit entity type\n */\nexport function isValidAuditEntityType(value: unknown): value is AuditEntityType {\n  return typeof value === 'string' && Object.values(AUDIT_ENTITY_TYPE).includes(value as AuditEntityType)\n}\n\n/**\n * Type guard to check if a value is a valid audit action\n */\nexport function isValidAuditAction(value: unknown): value is AuditAction {\n  return typeof value === 'string' && Object.values(AUDIT_ACTION).includes(value as AuditAction)\n}\n\n/**\n * Type guard to check if a value is a valid audit source\n */\nexport function isValidAuditSource(value: unknown): value is AuditSource {\n  return typeof value === 'string' && Object.values(AUDIT_SOURCE).includes(value as AuditSource)\n}\n\n// ============================================================\n// Program Tier Levels (TV05_01D)\n// ============================================================\n\n/**\n * Valid program tier levels based on Thomas' journey model\n * These map the 3-tier patient journey to platform capabilities\n */\nexport const PROGRAM_TIER = {\n  /**\n   * Tier 1 (Essential): Basic stress/resilience assessment\n   * Focus: Initial assessment, baseline data collection\n   */\n  TIER_1_ESSENTIAL: 'tier-1-essential',\n  \n  /**\n   * Tier 2.5 (Enhanced): Extended monitoring with nurse touchpoints\n   * Focus: Regular check-ins, progress tracking\n   */\n  TIER_2_5_ENHANCED: 'tier-2-5-enhanced',\n  \n  /**\n   * Tier 2 (Comprehensive): Full program with intensive support\n   * Focus: Comprehensive care, multiple pillars, frequent touchpoints\n   */\n  TIER_2_COMPREHENSIVE: 'tier-2-comprehensive',\n} as const\n\nexport type ProgramTier = typeof PROGRAM_TIER[keyof typeof PROGRAM_TIER]\n\n/**\n * Type guard to check if a value is a valid program tier\n */\nexport function isValidProgramTier(value: unknown): value is ProgramTier {\n  return typeof value === 'string' && Object.values(PROGRAM_TIER).includes(value as ProgramTier)\n}\n\n// ============================================================\n// Document Extraction Versions (V05-I04.2)\n// ============================================================\n\n/**\n * Valid extractor versions for AI document extraction\n * Format: vMAJOR.MINOR.PATCH\n * Update when extraction logic or prompts change\n */\nexport const EXTRACTOR_VERSION = {\n  /**\n   * v1.0.0: Initial extraction pipeline\n   * - Basic lab value extraction\n   * - Medication list extraction\n   * - Confidence scoring\n   */\n  V1_0_0: 'v1.0.0',\n} as const\n\nexport type ExtractorVersion = typeof EXTRACTOR_VERSION[keyof typeof EXTRACTOR_VERSION]\n\n/**\n * Current extractor version (latest)\n */\nexport const CURRENT_EXTRACTOR_VERSION = EXTRACTOR_VERSION.V1_0_0\n\n/**\n * Type guard to check if a value is a valid extractor version\n */\nexport function isValidExtractorVersion(value: unknown): value is ExtractorVersion {\n  return typeof value === 'string' && Object.values(EXTRACTOR_VERSION).includes(value as ExtractorVersion)\n}\n\n// ============================================================\n// Processing Stages & Status (V05-I05.1)\n// ============================================================\n\n/**\n * Valid processing stages for job orchestrator\n * Jobs progress deterministically through these stages\n */\nexport const PROCESSING_STAGE = {\n  PENDING: 'pending',\n  RISK: 'risk',\n  RANKING: 'ranking',\n  CONTENT: 'content',\n  VALIDATION: 'validation',\n  REVIEW: 'review',\n  PDF: 'pdf',\n  DELIVERY: 'delivery',\n  COMPLETED: 'completed',\n  FAILED: 'failed',\n} as const\n\nexport type ProcessingStage = typeof PROCESSING_STAGE[keyof typeof PROCESSING_STAGE]\n\n/**\n * Valid processing statuses for job orchestrator\n */\nexport const PROCESSING_STATUS = {\n  QUEUED: 'queued',\n  IN_PROGRESS: 'in_progress',\n  COMPLETED: 'completed',\n  FAILED: 'failed',\n} as const\n\nexport type ProcessingStatus = typeof PROCESSING_STATUS[keyof typeof PROCESSING_STATUS]\n\n/**\n * Type guard to check if a value is a valid processing stage\n */\nexport function isValidProcessingStage(value: unknown): value is ProcessingStage {\n  return typeof value === 'string' && Object.values(PROCESSING_STAGE).includes(value as ProcessingStage)\n}\n\n/**\n * Type guard to check if a value is a valid processing status\n */\nexport function isValidProcessingStatus(value: unknown): value is ProcessingStatus {\n  return typeof value === 'string' && Object.values(PROCESSING_STATUS).includes(value as ProcessingStatus)\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/apps/rhythm-patient-ui/app/patient/funnel/[slug]/result/client.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/rhythm-patient-ui/app/patient/funnel/[slug]/result/client.tsx\",\n    \"default\",\n);\n","import { redirect } from 'next/navigation'\nimport { createServerSupabaseClient } from '@/lib/db/supabase.server'\nimport { enforceDashboardFirst } from '@/lib/utils/dashboardFirstPolicy'\nimport { FUNNEL_SLUG_ALIASES, getCanonicalFunnelSlug } from '@/lib/contracts/registry'\nimport {\n  getReportsForAssessment,\n  getKeyOutcomesForAssessment,\n} from '@/lib/db/queries/reports'\nimport ResultClient from './client'\n\nfunction getFunnelSlugCandidates(slug: string): string[] {\n  const normalized = slug.toLowerCase().trim()\n  const canonical = getCanonicalFunnelSlug(normalized)\n  const legacySlugsForCanonical = Object.entries(FUNNEL_SLUG_ALIASES)\n    .filter(([, canonicalSlug]) => canonicalSlug === canonical)\n    .map(([legacySlug]) => legacySlug)\n\n  return Array.from(new Set([normalized, canonical, ...legacySlugsForCanonical]))\n}\n\ntype PageProps = {\n  params: Promise<{ slug: string }>\n  searchParams: Promise<{ assessmentId?: string }>\n}\n\nexport default async function FunnelResultPage({ params, searchParams }: PageProps) {\n  const { slug } = await params\n  const search = await searchParams\n  const assessmentId = search.assessmentId\n\n  // Validate assessmentId parameter\n  if (!assessmentId) {\n    redirect(`/patient/funnel/${slug}?error=missing_assessment_id`)\n  }\n\n  // Create Supabase server client (canonical)\n  const supabase = await createServerSupabaseClient()\n\n  // E6.5.1 AC3: Check authentication FIRST (401-first, no DB calls before auth)\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) {\n    redirect('/')\n  }\n\n  // E6.5.1 AC2: Enforce dashboard-first policy\n  const pathname = `/patient/funnel/${slug}/result`\n  const redirectUrl = await enforceDashboardFirst(pathname)\n  \n  if (redirectUrl) {\n    redirect(redirectUrl)\n  }\n\n  // Verify assessment ownership\n  const { data: patientProfile } = await supabase\n    .from('patient_profiles')\n    .select('id')\n    .eq('user_id', user.id)\n    .single()\n\n  if (!patientProfile) {\n    redirect('/')\n  }\n\n  const funnelCandidates = getFunnelSlugCandidates(slug)\n\n  const { data: assessment } = await supabase\n    .from('assessments')\n    .select('id, patient_id, funnel, status, completed_at')\n    .eq('id', assessmentId)\n    .in('funnel', funnelCandidates)\n    .single()\n\n  if (!assessment || assessment.patient_id !== patientProfile.id) {\n    redirect(`/patient/funnel/${slug}?error=invalid_assessment`)\n  }\n\n  // If assessment is not completed, still render result page with fallback UI\n\n  // Fetch reports and key outcomes for this assessment\n  const { data: reports } = await getReportsForAssessment(assessmentId)\n  const { data: keyOutcomes } = await getKeyOutcomesForAssessment(assessmentId)\n\n  // Render result client with reports data\n  return (\n    <ResultClient\n      slug={slug}\n      assessmentId={assessmentId}\n      reports={reports || []}\n      keyOutcomes={keyOutcomes}\n    />\n  )\n}\n","/**\n * Server-side queries for reports data\n * V05-I03.4: Result Screen Report Library\n */\n\nimport 'server-only'\nimport { createServerSupabaseClient } from '../supabase.server'\n\nexport type ReportWithAssessment = {\n  id: string\n  assessment_id: string\n  score_numeric: number | null\n  sleep_score: number | null\n  risk_level: 'low' | 'moderate' | 'high' | null\n  report_text_short: string | null\n  created_at: string\n  updated_at: string\n  assessment: {\n    id: string\n    funnel: string\n    completed_at: string | null\n  } | null\n}\n\nexport type KeyOutcomes = {\n  score_numeric: number | null\n  sleep_score: number | null\n  risk_level: 'low' | 'moderate' | 'high' | null\n  total_reports: number\n}\n\n/**\n * Fetch all reports for a specific assessment\n * Uses RLS - only returns reports user has access to\n * Deterministic ordering: created_at DESC, then id DESC for tie-breaking\n */\nexport async function getReportsForAssessment(\n  assessmentId: string,\n): Promise<{ data: ReportWithAssessment[] | null; error: Error | null }> {\n  try {\n    const supabase = await createServerSupabaseClient()\n\n    const { data, error } = await supabase\n      .from('reports')\n      .select(\n        `\n        id,\n        assessment_id,\n        score_numeric,\n        sleep_score,\n        risk_level,\n        report_text_short,\n        created_at,\n        updated_at,\n        assessment:assessments!assessment_id (\n          id,\n          funnel,\n          completed_at\n        )\n      `,\n      )\n      .eq('assessment_id', assessmentId)\n      .order('created_at', { ascending: false })\n      .order('id', { ascending: false })\n\n    if (error) {\n      console.error('Error fetching reports for assessment:', { assessmentId, errorMessage: error.message })\n      return { data: null, error: new Error(error.message) }\n    }\n\n    return { data: data as ReportWithAssessment[], error: null }\n  } catch (err) {\n    console.error('Unexpected error fetching reports:', { assessmentId })\n    return { data: null, error: err instanceof Error ? err : new Error('Unknown error') }\n  }\n}\n\n/**\n * Fetch all reports for current user across all assessments\n * Uses RLS - automatically filtered to current user\n */\nexport async function getReportsForCurrentUser(): Promise<{\n  data: ReportWithAssessment[] | null\n  error: Error | null\n}> {\n  try {\n    const supabase = await createServerSupabaseClient()\n\n    // First get current user\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser()\n\n    if (authError || !user) {\n      return { data: null, error: new Error('Not authenticated') }\n    }\n\n    // Get patient profile\n    const { data: profile, error: profileError } = await supabase\n      .from('patient_profiles')\n      .select('id')\n      .eq('user_id', user.id)\n      .single()\n\n    if (profileError || !profile) {\n      return { data: null, error: new Error('Patient profile not found') }\n    }\n\n    // Get all assessments for this patient\n    const { data: assessments, error: assessmentsError } = await supabase\n      .from('assessments')\n      .select('id')\n      .eq('patient_id', profile.id)\n\n    if (assessmentsError) {\n      return { data: null, error: new Error(assessmentsError.message) }\n    }\n\n    if (!assessments || assessments.length === 0) {\n      return { data: [], error: null }\n    }\n\n    const assessmentIds = assessments.map((a) => a.id)\n\n    // Fetch all reports for these assessments\n    // Deterministic ordering: created_at DESC, then id DESC for tie-breaking\n    const { data, error } = await supabase\n      .from('reports')\n      .select(\n        `\n        id,\n        assessment_id,\n        score_numeric,\n        sleep_score,\n        risk_level,\n        report_text_short,\n        created_at,\n        updated_at,\n        assessment:assessments!assessment_id (\n          id,\n          funnel,\n          completed_at\n        )\n      `,\n      )\n      .in('assessment_id', assessmentIds)\n      .order('created_at', { ascending: false })\n      .order('id', { ascending: false })\n\n    if (error) {\n      console.error('Error fetching reports for current user:', { userId: user.id, errorMessage: error.message })\n      return { data: null, error: new Error(error.message) }\n    }\n\n    return { data: data as ReportWithAssessment[], error: null }\n  } catch (err) {\n    console.error('Unexpected error fetching user reports')\n    return { data: null, error: err instanceof Error ? err : new Error('Unknown error') }\n  }\n}\n\n/**\n * Get key outcomes summary for an assessment\n * Returns aggregated data from the most recent report (deterministic: latest by created_at, then id)\n * All fields come from existing reports table columns - no fantasy fields\n */\nexport async function getKeyOutcomesForAssessment(\n  assessmentId: string,\n): Promise<{ data: KeyOutcomes | null; error: Error | null }> {\n  try {\n    const { data: reports, error } = await getReportsForAssessment(assessmentId)\n\n    if (error || !reports || reports.length === 0) {\n      return {\n        data: { score_numeric: null, sleep_score: null, risk_level: null, total_reports: 0 },\n        error: error,\n      }\n    }\n\n    // Use most recent report for key outcomes (deterministically ordered by created_at DESC, id DESC)\n    const latestReport = reports[0]\n\n    return {\n      data: {\n        score_numeric: latestReport.score_numeric,\n        sleep_score: latestReport.sleep_score,\n        risk_level: latestReport.risk_level,\n        total_reports: reports.length,\n      },\n      error: null,\n    }\n  } catch (err) {\n    console.error('Unexpected error getting key outcomes:', { assessmentId })\n    return { data: null, error: err instanceof Error ? err : new Error('Unknown error') }\n  }\n}\n"],"names":[],"mappings":"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","ignoreList":[1]}