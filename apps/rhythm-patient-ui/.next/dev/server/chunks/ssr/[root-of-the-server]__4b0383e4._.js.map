{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 38, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/lib/env.ts"],"sourcesContent":["/**\n * Environment Variables Schema and Validation\n * \n * This file provides type-safe access to environment variables using Zod validation.\n * All environment variables MUST be accessed through this module to ensure:\n * 1. Type safety\n * 2. Runtime validation\n * 3. Clear documentation of required vs. optional variables\n * 4. Fail-fast behavior for missing required variables\n * \n * **IMPORTANT**: This file is protected by CODEOWNERS. Any changes require review.\n * \n * Usage:\n * ```typescript\n * import { env } from '@/lib/env'\n * \n * const supabaseUrl = env.NEXT_PUBLIC_SUPABASE_URL\n * const apiKey = env.ANTHROPIC_API_KEY // Can be undefined\n * ```\n */\n\nimport { z } from 'zod'\n\n// ============================================================\n// Environment Schema Definition\n// ============================================================\n\n// IMPORTANT:\n// - NEXT_PUBLIC_* vars can be read in both server + client bundles.\n// - Server-only secrets (e.g. SUPABASE_SERVICE_ROLE_KEY) must never be\n//   required/validated in the browser, otherwise production will crash.\nconst isServerRuntime = typeof window === 'undefined'\nconst isBuildTime = process.env.NEXT_PHASE === 'phase-production-build'\nconst isProdRuntime = process.env.NODE_ENV === 'production'\nconst requireServerSecrets = isServerRuntime && isProdRuntime && !isBuildTime\n\nfunction sanitizeEnvString(value: unknown) {\n  if (typeof value !== 'string') return value\n\n  let v = value.trim()\n\n  // Common deployment UI pitfall: values pasted with wrapping quotes/backticks.\n  // Remove exactly one wrapping pair to avoid breaking legitimate inner quotes.\n  const first = v[0]\n  const last = v[v.length - 1]\n  const isWrapped =\n    (first === '\"' && last === '\"') ||\n    (first === \"'\" && last === \"'\") ||\n    (first === '`' && last === '`')\n\n  if (isWrapped && v.length >= 2) {\n    v = v.slice(1, -1).trim()\n  }\n\n  return v\n}\n\nconst baseEnvSchema = z.object({\n  // Client-safe vars (may be inlined at build time by Next.js)\n  NEXT_PUBLIC_SUPABASE_URL: z.preprocess(sanitizeEnvString, z.string().url().optional()),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.preprocess(sanitizeEnvString, z.string().optional()),\n\n  // OPTIONAL: Review Queue Sampling\n  REVIEW_SAMPLING_PERCENTAGE: z.string().optional(),\n  REVIEW_SAMPLING_SALT: z.string().optional(),\n\n  // OPTIONAL: Feature Flags\n  NEXT_PUBLIC_FEATURE_AMY_ENABLED: z.string().optional(),\n  NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED: z.string().optional(),\n  NEXT_PUBLIC_FEATURE_CHARTS_ENABLED: z.string().optional(),\n\n  // OPTIONAL: E6.4.1 Pilot Feature Flags\n  NEXT_PUBLIC_PILOT_ENABLED: z.string().optional(),\n  NEXT_PUBLIC_PILOT_ENV: z.string().optional(),\n\n  // Node Environment\n  NODE_ENV: z.enum(['development', 'production', 'test']).optional(),\n  NEXT_PHASE: z.string().optional(),\n\n  // Hosting provider (optional)\n  VERCEL_ENV: z.string().optional(),\n\n  // OPTIONAL: Usage Telemetry Toggle\n  USAGE_TELEMETRY_ENABLED: z.string().optional(),\n})\n\nconst serverOnlyEnvSchema = baseEnvSchema.extend({\n  // OPTIONAL: Dev/Admin tooling feature flags\n  DEV_ENDPOINT_CATALOG: z.string().optional(),\n\n  // OPTIONAL: UI split routing (Package 2)\n  STUDIO_BASE_URL: z.preprocess(sanitizeEnvString, z.string().url().optional()),\n  PATIENT_BASE_URL: z.preprocess(sanitizeEnvString, z.string().url().optional()),\n  ENGINE_BASE_URL: z.preprocess(sanitizeEnvString, z.string().url().optional()),\n\n  // OPTIONAL: E6.4.1 Pilot Allowlists (server-only)\n  PILOT_ORG_ALLOWLIST: z.string().optional(),\n  PILOT_USER_ALLOWLIST: z.string().optional(),\n\n  // REQUIRED (server runtime only): Supabase Admin\n  SUPABASE_SERVICE_ROLE_KEY: requireServerSecrets\n    ? z.preprocess(\n        sanitizeEnvString,\n        z.string().min(1, 'SUPABASE_SERVICE_ROLE_KEY is required'),\n      )\n    : z.preprocess(sanitizeEnvString, z.string().optional()),\n\n  // OPTIONAL: Anthropic AI Configuration\n  ANTHROPIC_API_KEY: z.string().optional(),\n  ANTHROPIC_API_TOKEN: z.string().optional(), // Legacy support\n  ANTHROPIC_MODEL: z.string().optional(),\n\n  // OPTIONAL: Legacy/Alternative Variable Names\n  SUPABASE_URL: z.preprocess(sanitizeEnvString, z.string().url().optional()), // Alternative to NEXT_PUBLIC_SUPABASE_URL\n  SUPABASE_SERVICE_KEY: z.preprocess(sanitizeEnvString, z.string().optional()), // Alternative to SUPABASE_SERVICE_ROLE_KEY\n})\n\nconst patientEnvSchema = baseEnvSchema.extend({\n  NEXT_PUBLIC_SUPABASE_URL: z.preprocess(\n    sanitizeEnvString,\n    z.string().url('NEXT_PUBLIC_SUPABASE_URL is required'),\n  ),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.preprocess(\n    sanitizeEnvString,\n    z.string().min(1, 'NEXT_PUBLIC_SUPABASE_ANON_KEY is required'),\n  ),\n  ENGINE_BASE_URL: z.preprocess(sanitizeEnvString, z.string().url('ENGINE_BASE_URL is required')),\n})\n\nconst studioEnvSchema = baseEnvSchema.extend({\n  NEXT_PUBLIC_SUPABASE_URL: z.preprocess(\n    sanitizeEnvString,\n    z.string().url('NEXT_PUBLIC_SUPABASE_URL is required'),\n  ),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.preprocess(\n    sanitizeEnvString,\n    z.string().min(1, 'NEXT_PUBLIC_SUPABASE_ANON_KEY is required'),\n  ),\n})\n\nconst engineEnvSchema = serverOnlyEnvSchema.extend({\n  NEXT_PUBLIC_SUPABASE_URL: z.preprocess(\n    sanitizeEnvString,\n    z.string().url('NEXT_PUBLIC_SUPABASE_URL is required'),\n  ),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.preprocess(\n    sanitizeEnvString,\n    z.string().min(1, 'NEXT_PUBLIC_SUPABASE_ANON_KEY is required'),\n  ),\n})\n\nexport type PatientEnv = z.infer<typeof patientEnvSchema>\nexport type StudioEnv = z.infer<typeof studioEnvSchema>\nexport type BaseEnv = Partial<Env>\nexport type EngineEnv = z.infer<typeof engineEnvSchema>\n\nfunction getRawClientEnv() {\n  return {\n    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    REVIEW_SAMPLING_PERCENTAGE: process.env.REVIEW_SAMPLING_PERCENTAGE,\n    REVIEW_SAMPLING_SALT: process.env.REVIEW_SAMPLING_SALT,\n    NEXT_PUBLIC_FEATURE_AMY_ENABLED: process.env.NEXT_PUBLIC_FEATURE_AMY_ENABLED,\n    NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED:\n      process.env.NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED,\n    NEXT_PUBLIC_FEATURE_CHARTS_ENABLED: process.env.NEXT_PUBLIC_FEATURE_CHARTS_ENABLED,\n    NEXT_PUBLIC_PILOT_ENABLED: process.env.NEXT_PUBLIC_PILOT_ENABLED,\n    NEXT_PUBLIC_PILOT_ENV: process.env.NEXT_PUBLIC_PILOT_ENV,\n    NODE_ENV: process.env.NODE_ENV,\n    NEXT_PHASE: process.env.NEXT_PHASE,\n    VERCEL_ENV: process.env.VERCEL_ENV,\n    USAGE_TELEMETRY_ENABLED: process.env.USAGE_TELEMETRY_ENABLED,\n  }\n}\n\nfunction getRawServerEnv() {\n  return {\n    DEV_ENDPOINT_CATALOG: process.env.DEV_ENDPOINT_CATALOG,\n    STUDIO_BASE_URL: process.env.STUDIO_BASE_URL,\n    PATIENT_BASE_URL: process.env.PATIENT_BASE_URL,\n    ENGINE_BASE_URL: process.env.ENGINE_BASE_URL,\n    PILOT_ORG_ALLOWLIST: process.env.PILOT_ORG_ALLOWLIST,\n    PILOT_USER_ALLOWLIST: process.env.PILOT_USER_ALLOWLIST,\n    SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY,\n    ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY,\n    ANTHROPIC_API_TOKEN: process.env.ANTHROPIC_API_TOKEN,\n    ANTHROPIC_MODEL: process.env.ANTHROPIC_MODEL,\n    SUPABASE_URL: process.env.SUPABASE_URL,\n    SUPABASE_SERVICE_KEY: process.env.SUPABASE_SERVICE_KEY,\n  }\n}\n\n// ============================================================\n// Validated Environment Variables\n// ============================================================\n\n/**\n * Type of the validated environment object\n * Note: Required fields are guaranteed to be strings (never undefined)\n */\nexport type Env = {\n  NEXT_PUBLIC_SUPABASE_URL: string\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: string\n  SUPABASE_SERVICE_ROLE_KEY: string\n  ANTHROPIC_API_KEY?: string\n  ANTHROPIC_API_TOKEN?: string\n  ANTHROPIC_MODEL?: string\n  REVIEW_SAMPLING_PERCENTAGE?: string\n  REVIEW_SAMPLING_SALT?: string\n  NEXT_PUBLIC_FEATURE_AMY_ENABLED?: string\n  NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED?: string\n  NEXT_PUBLIC_FEATURE_CHARTS_ENABLED?: string\n  NEXT_PUBLIC_PILOT_ENABLED?: string\n  NEXT_PUBLIC_PILOT_ENV?: string\n  PILOT_ORG_ALLOWLIST?: string\n  PILOT_USER_ALLOWLIST?: string\n  SUPABASE_URL?: string\n  SUPABASE_SERVICE_KEY?: string\n  NODE_ENV?: 'development' | 'production' | 'test'\n  NEXT_PHASE?: string\n  VERCEL_ENV?: string\n  USAGE_TELEMETRY_ENABLED?: string\n\n  // Dev/admin tooling\n  DEV_ENDPOINT_CATALOG?: string\n  STUDIO_BASE_URL?: string\n  PATIENT_BASE_URL?: string\n  ENGINE_BASE_URL?: string\n}\n\n/**\n * Get default environment values for development/build time\n */\nfunction getDefaultEnv(): Env {\n  return {\n    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL || '',\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '',\n    SUPABASE_SERVICE_ROLE_KEY:\n      process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SERVICE_KEY || '',\n    ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY || process.env.ANTHROPIC_API_TOKEN,\n    ANTHROPIC_API_TOKEN: process.env.ANTHROPIC_API_TOKEN,\n    ANTHROPIC_MODEL: process.env.ANTHROPIC_MODEL,\n    REVIEW_SAMPLING_PERCENTAGE: process.env.REVIEW_SAMPLING_PERCENTAGE,\n    REVIEW_SAMPLING_SALT: process.env.REVIEW_SAMPLING_SALT,\n    NEXT_PUBLIC_FEATURE_AMY_ENABLED: process.env.NEXT_PUBLIC_FEATURE_AMY_ENABLED,\n    NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED: process.env.NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED,\n    NEXT_PUBLIC_FEATURE_CHARTS_ENABLED: process.env.NEXT_PUBLIC_FEATURE_CHARTS_ENABLED,\n    NEXT_PUBLIC_PILOT_ENABLED: process.env.NEXT_PUBLIC_PILOT_ENABLED,\n    NEXT_PUBLIC_PILOT_ENV: process.env.NEXT_PUBLIC_PILOT_ENV,\n    PILOT_ORG_ALLOWLIST: process.env.PILOT_ORG_ALLOWLIST,\n    PILOT_USER_ALLOWLIST: process.env.PILOT_USER_ALLOWLIST,\n    SUPABASE_URL: process.env.SUPABASE_URL,\n    SUPABASE_SERVICE_KEY: process.env.SUPABASE_SERVICE_KEY,\n    NODE_ENV: process.env.NODE_ENV as 'development' | 'production' | 'test' | undefined,\n    NEXT_PHASE: process.env.NEXT_PHASE,\n    VERCEL_ENV: process.env.VERCEL_ENV,\n    USAGE_TELEMETRY_ENABLED: process.env.USAGE_TELEMETRY_ENABLED,\n    DEV_ENDPOINT_CATALOG: process.env.DEV_ENDPOINT_CATALOG,\n    STUDIO_BASE_URL: process.env.STUDIO_BASE_URL,\n    PATIENT_BASE_URL: process.env.PATIENT_BASE_URL,\n    ENGINE_BASE_URL: process.env.ENGINE_BASE_URL,\n  }\n}\n\nfunction getMissingEnvKeys(issues: z.ZodIssue[]): string[] {\n  const keys = new Set<string>()\n  issues.forEach((issue) => {\n    const pathKey = issue.path[0]\n    if (typeof pathKey === 'string') {\n      keys.add(pathKey)\n    }\n  })\n  return Array.from(keys)\n}\n\ntype ParseOptions = {\n  strict?: boolean\n  scope?: string\n}\n\nfunction parseScopedEnv<T extends z.ZodTypeAny>(schema: T, options: ParseOptions = {}): z.infer<T> {\n  const rawEnv = isServerRuntime\n    ? { ...getRawClientEnv(), ...getRawServerEnv() }\n    : getRawClientEnv()\n\n  try {\n    const parsed = schema.parse(rawEnv) as Env\n    return {\n      NEXT_PUBLIC_SUPABASE_URL: parsed.NEXT_PUBLIC_SUPABASE_URL || parsed.SUPABASE_URL || '',\n      NEXT_PUBLIC_SUPABASE_ANON_KEY: parsed.NEXT_PUBLIC_SUPABASE_ANON_KEY || '',\n      SUPABASE_SERVICE_ROLE_KEY: parsed.SUPABASE_SERVICE_ROLE_KEY || parsed.SUPABASE_SERVICE_KEY || '',\n      ANTHROPIC_API_KEY: parsed.ANTHROPIC_API_KEY || parsed.ANTHROPIC_API_TOKEN,\n      ANTHROPIC_API_TOKEN: parsed.ANTHROPIC_API_TOKEN,\n      ANTHROPIC_MODEL: parsed.ANTHROPIC_MODEL,\n      REVIEW_SAMPLING_PERCENTAGE: parsed.REVIEW_SAMPLING_PERCENTAGE,\n      REVIEW_SAMPLING_SALT: parsed.REVIEW_SAMPLING_SALT,\n      NEXT_PUBLIC_FEATURE_AMY_ENABLED: parsed.NEXT_PUBLIC_FEATURE_AMY_ENABLED,\n      NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED:\n        parsed.NEXT_PUBLIC_FEATURE_CLINICIAN_DASHBOARD_ENABLED,\n      NEXT_PUBLIC_FEATURE_CHARTS_ENABLED: parsed.NEXT_PUBLIC_FEATURE_CHARTS_ENABLED,\n      NEXT_PUBLIC_PILOT_ENABLED: parsed.NEXT_PUBLIC_PILOT_ENABLED,\n      NEXT_PUBLIC_PILOT_ENV: parsed.NEXT_PUBLIC_PILOT_ENV,\n      PILOT_ORG_ALLOWLIST: parsed.PILOT_ORG_ALLOWLIST,\n      PILOT_USER_ALLOWLIST: parsed.PILOT_USER_ALLOWLIST,\n      SUPABASE_URL: parsed.SUPABASE_URL,\n      SUPABASE_SERVICE_KEY: parsed.SUPABASE_SERVICE_KEY,\n      NODE_ENV: parsed.NODE_ENV,\n      NEXT_PHASE: parsed.NEXT_PHASE,\n      VERCEL_ENV: parsed.VERCEL_ENV,\n      USAGE_TELEMETRY_ENABLED: parsed.USAGE_TELEMETRY_ENABLED,\n      DEV_ENDPOINT_CATALOG: parsed.DEV_ENDPOINT_CATALOG,\n      STUDIO_BASE_URL: parsed.STUDIO_BASE_URL,\n      PATIENT_BASE_URL: parsed.PATIENT_BASE_URL,\n      ENGINE_BASE_URL: parsed.ENGINE_BASE_URL,\n    } as z.infer<T>\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      const missingKeys = getMissingEnvKeys(error.issues)\n      const message = missingKeys.length\n        ? `Missing env: ${missingKeys.join(', ')}`\n        : 'Invalid environment variables'\n\n      console.error('❌ Environment variable validation failed:')\n      console.error(error.issues.map((e) => `  - ${e.path.join('.')}: ${e.message}`).join('\\n'))\n\n      // During build, allow with defaults\n      if (isBuildTime) {\n        console.warn('⚠️  Build time: Continuing with default values')\n        return getDefaultEnv() as z.infer<T>\n      }\n\n      if (options.strict && isServerRuntime) {\n        throw new Error(message)\n      }\n\n      // In development or non-strict mode, warn but allow build to continue with default values\n      console.warn(\n        `⚠️  Continuing with default values for ${options.scope ?? 'base'} environment`,\n      )\n      return getDefaultEnv() as z.infer<T>\n    }\n    throw error\n  }\n}\n\n/**\n * Parse and validate environment variables\n * This will not throw in base mode to avoid import-time crashes\n */\nfunction parseEnv(): BaseEnv {\n  const schema = isServerRuntime ? serverOnlyEnvSchema : baseEnvSchema\n  return parseScopedEnv(schema, { strict: false, scope: 'base' }) as BaseEnv\n}\n\n/**\n * Validated and type-safe environment variables\n * Access all environment variables through this object\n */\nlet cachedEnv: BaseEnv | null = null\n\nexport function getEnv(): BaseEnv {\n  if (!cachedEnv) {\n    cachedEnv = parseEnv()\n  }\n  return cachedEnv\n}\n\nexport function getPatientEnv(): PatientEnv {\n  return parseScopedEnv(patientEnvSchema, { strict: true, scope: 'patient' })\n}\n\nexport function getStudioEnv(): StudioEnv {\n  return parseScopedEnv(studioEnvSchema, { strict: true, scope: 'studio' })\n}\n\nexport function getEngineEnv(): EngineEnv {\n  return parseScopedEnv(engineEnvSchema, { strict: true, scope: 'engine' })\n}\n\nexport const env = new Proxy({} as BaseEnv, {\n  get(_target, prop) {\n    return getEnv()[prop as keyof Env]\n  },\n  set(_target, prop, value) {\n    const current = getEnv()\n    ;(current as Record<string, unknown>)[prop as string] = value\n    return true\n  },\n})\n\n/**\n * Server-runtime feature flags.\n *\n * Note: Jest runs API route unit tests in a jsdom environment (window defined),\n * but API routes are still server code. Do NOT rely on `env` for server-only\n * flags in those tests.\n */\nexport function isDevEndpointCatalogEnabled(): boolean {\n  return process.env.DEV_ENDPOINT_CATALOG === '1'\n}\n\n/**\n * Helper function to check if we're in production\n */\nexport function isProduction(): boolean {\n  return env.NODE_ENV === 'production'\n}\n\n/**\n * Helper function to check if we're in development\n */\nexport function isDevelopment(): boolean {\n  return env.NODE_ENV === 'development' || !env.NODE_ENV\n}\n\n/**\n * Helper function to check if we're in test mode\n */\nexport function isTest(): boolean {\n  return env.NODE_ENV === 'test'\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 355, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/lib/db/supabase.server.ts"],"sourcesContent":["/**\n * Server Supabase Client (SSR with User Session)\n * \n * This is the DEFAULT client for server-side code.\n * - Uses anon key + cookie-based authentication\n * - RLS policies are ACTIVE (user context preserved)\n * - Server-only (never bundled to browser)\n * \n * Use this for:\n * - API routes\n * - Server components\n * - Server actions\n * - Any server code that needs user-scoped access\n * \n * @module lib/db/supabase.server\n */\n\nimport { createServerClient as createSsrServerClient } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\nimport type { NextRequest, NextResponse } from 'next/server'\nimport { env } from '@/lib/env'\nimport type { Database } from '@/lib/types/supabase'\n\n/**\n * Creates a server-side Supabase client with user session\n * \n * This client:\n * - Uses cookie-based authentication (preserves user context)\n * - Enforces RLS policies based on authenticated user\n * - Automatically handles session refresh\n * - Server-only (safe to use service operations)\n * \n * @returns Promise<SupabaseClient> with user context\n * @throws Error if Supabase URL or anon key is not configured\n * \n * @example\n * ```typescript\n * // In an API route\n * import { createServerSupabaseClient } from '@/lib/db/supabase.server'\n * \n * export async function GET() {\n *   const supabase = await createServerSupabaseClient()\n *   const { data: { user } } = await supabase.auth.getUser()\n *   \n *   if (!user) {\n *     return new Response('Unauthorized', { status: 401 })\n *   }\n *   \n *   // RLS will automatically filter based on user\n *   const { data } = await supabase.from('user_data').select('*')\n *   return Response.json({ data })\n * }\n * ```\n */\nexport async function createServerSupabaseClient() {\n  const url = env.NEXT_PUBLIC_SUPABASE_URL\n  const anonKey = env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!url || !anonKey) {\n    throw new Error(\n      'Supabase configuration missing. Ensure NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are set.'\n    )\n  }\n\n  const cookieStore = await cookies()\n\n  return createSsrServerClient<Database>(url, anonKey, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) =>\n            cookieStore.set(name, value, {\n              ...options,\n              path: options?.path ?? '/',\n            })\n          )\n        } catch {\n          // The `setAll` method was called from a Server Component.\n          // This can be ignored if you have middleware refreshing sessions.\n        }\n      },\n    },\n  })\n}\n\n/**\n * Creates a server-side Supabase client for Route Handlers with cookie sync.\n *\n * This helper collects cookie mutations so they can be applied to a NextResponse.\n * Use applyCookies(response) before returning.\n */\nexport function createRouteSupabaseClient(req: NextRequest) {\n  const url = env.NEXT_PUBLIC_SUPABASE_URL\n  const anonKey = env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!url || !anonKey) {\n    throw new Error(\n      'Supabase configuration missing. Ensure NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are set.'\n    )\n  }\n\n  const pendingCookies: Array<{\n    name: string\n    value: string\n    options?: Parameters<NextResponse['cookies']['set']>[2]\n  }> = []\n\n  const supabase = createSsrServerClient<Database>(url, anonKey, {\n    cookies: {\n      getAll() {\n        return req.cookies.getAll()\n      },\n      setAll(cookiesToSet) {\n        cookiesToSet.forEach(({ name, value, options }) => {\n          pendingCookies.push({ name, value, options })\n        })\n      },\n    },\n  })\n\n  const applyCookies = (response: NextResponse) => {\n    pendingCookies.forEach(({ name, value, options }) => {\n      response.cookies.set(name, value, options)\n    })\n    return response\n  }\n\n  return { supabase, applyCookies }\n}\n\n/**\n * Gets the currently authenticated user\n * \n * @returns Promise<User | null> - The authenticated user or null if not logged in\n * \n * @example\n * ```typescript\n * import { getCurrentUser } from '@/lib/db/supabase.server'\n * \n * export async function GET() {\n *   const user = await getCurrentUser()\n *   if (!user) {\n *     return new Response('Unauthorized', { status: 401 })\n *   }\n *   // ...\n * }\n * ```\n */\nexport async function getCurrentUser() {\n  const supabase = await createServerSupabaseClient()\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n  return user\n}\n\n/**\n * Checks if the current user has clinician role\n * \n * @returns Promise<boolean> - true if user is a clinician or admin\n * \n * @example\n * ```typescript\n * import { hasClinicianRole } from '@/lib/db/supabase.server'\n * \n * export async function GET() {\n *   if (!(await hasClinicianRole())) {\n *     return new Response('Forbidden', { status: 403 })\n *   }\n *   // ...\n * }\n * ```\n */\nexport async function hasClinicianRole(): Promise<boolean> {\n  const user = await getCurrentUser()\n  if (!user) return false\n\n  // Check in app_metadata and user_metadata\n  const role = user.app_metadata?.role || user.user_metadata?.role\n  return role === 'clinician' || role === 'admin'\n}\n\n/**\n * Checks if the current user has admin or clinician role\n * Alias for hasClinicianRole (in this system, clinicians have admin access)\n * \n * @returns Promise<boolean> - true if user is a clinician or admin\n */\nexport async function hasAdminOrClinicianRole(): Promise<boolean> {\n  return hasClinicianRole()\n}\n\n/**\n * Gets user role from app_metadata or user_metadata\n * \n * @returns Promise<string | null> - User role or null if not found\n */\nexport async function getUserRole(): Promise<string | null> {\n  const user = await getCurrentUser()\n  if (!user) return null\n  return user.app_metadata?.role || user.user_metadata?.role || null\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;;;;;;;;;;;;CAeC,GAED;AAAA;AACA;AAEA;;;;AAkCO,eAAe;IACpB,MAAM,MAAM,iHAAG,CAAC,wBAAwB;IACxC,MAAM,UAAU,iHAAG,CAAC,6BAA6B;IAEjD,IAAI,CAAC,OAAO,CAAC,SAAS;QACpB,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,OAAO,IAAA,+LAAqB,EAAW,KAAK,SAAS;QACnD,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;4BAC3B,GAAG,OAAO;4BACV,MAAM,SAAS,QAAQ;wBACzB;gBAEJ,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,kEAAkE;gBACpE;YACF;QACF;IACF;AACF;AAQO,SAAS,0BAA0B,GAAgB;IACxD,MAAM,MAAM,iHAAG,CAAC,wBAAwB;IACxC,MAAM,UAAU,iHAAG,CAAC,6BAA6B;IAEjD,IAAI,CAAC,OAAO,CAAC,SAAS;QACpB,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,iBAID,EAAE;IAEP,MAAM,WAAW,IAAA,+LAAqB,EAAW,KAAK,SAAS;QAC7D,SAAS;YACP;gBACE,OAAO,IAAI,OAAO,CAAC,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;oBAC5C,eAAe,IAAI,CAAC;wBAAE;wBAAM;wBAAO;oBAAQ;gBAC7C;YACF;QACF;IACF;IAEA,MAAM,eAAe,CAAC;QACpB,eAAe,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;YAC9C,SAAS,OAAO,CAAC,GAAG,CAAC,MAAM,OAAO;QACpC;QACA,OAAO;IACT;IAEA,OAAO;QAAE;QAAU;IAAa;AAClC;AAoBO,eAAe;IACpB,MAAM,WAAW,MAAM;IACvB,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAC/B,OAAO;AACT;AAmBO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM,OAAO;IAElB,0CAA0C;IAC1C,MAAM,OAAO,KAAK,YAAY,EAAE,QAAQ,KAAK,aAAa,EAAE;IAC5D,OAAO,SAAS,eAAe,SAAS;AAC1C;AAQO,eAAe;IACpB,OAAO;AACT;AAOO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO,KAAK,YAAY,EAAE,QAAQ,KAAK,aAAa,EAAE,QAAQ;AAChE"}},
    {"offset": {"line": 475, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/lib/config/funnelAllowlist.ts"],"sourcesContent":["/**\n * Funnel Reachability Allowlist\n *\n * Defines which funnel slugs are patient-reachable (can be accessed directly).\n * Funnels not in this allowlist are \"ADMIN-ONLY\" and cannot be started by patients.\n *\n * Note: `is_active` in the database means the funnel definition is active,\n * NOT that patients can start it. This allowlist controls patient reachability.\n *\n * @module lib/config/funnelAllowlist\n */\n\n/**\n * Patient-reachable funnel slugs\n *\n * Add slugs here to make them accessible to patients.\n * Remove or don't include slugs to restrict them to admin-only.\n */\nexport const PATIENT_REACHABLE_FUNNELS: readonly string[] = [\n  'stress-assessment',\n  'cardiovascular-age',\n  // Add more slugs as they become patient-ready:\n  // 'sleep-quality',\n] as const\n\n/**\n * Check if a funnel slug is patient-reachable\n *\n * @param slug - The funnel slug to check\n * @returns true if patients can access/start this funnel\n */\nexport function isFunnelPatientReachable(slug: string): boolean {\n  return PATIENT_REACHABLE_FUNNELS.includes(slug)\n}\n\n/**\n * Default funnel slug for new patient assessments\n * Used by NextStep resolver when patient hasn't started any funnel\n */\nexport const DEFAULT_PATIENT_FUNNEL = 'stress-assessment' as const\n"],"names":[],"mappings":"AAAA;;;;;;;;;;CAUC,GAED;;;;;CAKC;;;;;;;;AACM,MAAM,4BAA+C;IAC1D;IACA;CAGD;AAQM,SAAS,yBAAyB,IAAY;IACnD,OAAO,0BAA0B,QAAQ,CAAC;AAC5C;AAMO,MAAM,yBAAyB"}},
    {"offset": {"line": 510, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/lib/utils/dashboardFirstPolicy.ts"],"sourcesContent":["/**\n * Dashboard-First Policy Enforcement (E6.5.1)\n * \n * Ensures patients always land on the dashboard before accessing other routes.\n * Prevents direct deep-linking into funnels, results, or other patient pages.\n * \n * Policy:\n * - After login/onboarding, users must visit /patient/dashboard first\n * - Direct access to /patient/funnel/*, /patient/funnels, /patient/history, etc.\n *   redirects to dashboard if dashboard hasn't been visited in this session\n * - Dashboard sets a session marker allowing subsequent navigation\n * \n * @module lib/utils/dashboardFirstPolicy\n */\n\nimport { cookies } from 'next/headers'\nimport { env } from '@/lib/env'\nimport { isFunnelPatientReachable } from '@/lib/config/funnelAllowlist'\n\n/**\n * Cookie name for tracking dashboard visit\n */\nconst DASHBOARD_VISITED_COOKIE = 'dashboard_visited'\n\n/**\n * Cookie max age (1 hour - session-like behavior)\n */\nconst COOKIE_MAX_AGE = 60 * 60 // 1 hour\n\n/**\n * Routes that require dashboard-first entry\n * These routes will redirect to dashboard if not visited yet\n */\nconst PROTECTED_ROUTES = [\n  '/patient/funnel',\n  '/patient/funnels',\n  '/patient/history',\n  '/patient/assessment',\n  '/patient/support',\n  '/patient/escalation',\n  '/patient/documents',\n]\n\n/**\n * Routes that are exempt from dashboard-first policy\n * These can be accessed directly\n */\nconst EXEMPT_ROUTES = [\n  '/patient/dashboard',\n  '/patient/onboarding',\n]\n\n/**\n * Special case: patient root route (redirects to dashboard anyway)\n */\nconst PATIENT_ROOT = '/patient'\n\n/**\n * Funnel route prefix for slug extraction\n */\nconst FUNNEL_ROUTE_PREFIX = '/patient/funnel/'\n\n/**\n * Extracts the funnel slug from a pathname\n * @param pathname - e.g., '/patient/funnel/stress-assessment'\n * @returns The slug or null if not a funnel route\n */\nexport function extractFunnelSlug(pathname: string): string | null {\n  if (!pathname.startsWith(FUNNEL_ROUTE_PREFIX)) {\n    return null\n  }\n  // Extract slug: '/patient/funnel/stress-assessment' → 'stress-assessment'\n  // Handle nested routes: '/patient/funnel/stress-assessment/result' → 'stress-assessment'\n  const remainder = pathname.slice(FUNNEL_ROUTE_PREFIX.length)\n  const slugEnd = remainder.indexOf('/')\n  return slugEnd === -1 ? remainder : remainder.slice(0, slugEnd)\n}\n\n/**\n * Check if a pathname is a funnel route\n */\nexport function isFunnelRoute(pathname: string): boolean {\n  return pathname.startsWith(FUNNEL_ROUTE_PREFIX)\n}\n\n/**\n * Checks if the user has visited the dashboard in this session\n * \n * @returns Promise<boolean> - true if dashboard has been visited\n */\nexport async function hasDashboardVisit(): Promise<boolean> {\n  const cookieStore = await cookies()\n  const visited = cookieStore.get(DASHBOARD_VISITED_COOKIE)\n  return visited?.value === 'true'\n}\n\n/**\n * Marks the dashboard as visited for this session\n * Sets a cookie that expires after COOKIE_MAX_AGE\n */\nexport async function markDashboardVisited(): Promise<void> {\n  const cookieStore = await cookies()\n  const isProduction = env.NODE_ENV === 'production'\n  \n  cookieStore.set(DASHBOARD_VISITED_COOKIE, 'true', {\n    maxAge: COOKIE_MAX_AGE,\n    httpOnly: true,\n    sameSite: 'lax',\n    path: '/patient',\n    secure: isProduction,\n  })\n}\n\n/**\n * Clears the dashboard visit marker\n * Useful for testing or logout scenarios\n */\nexport async function clearDashboardVisit(): Promise<void> {\n  const cookieStore = await cookies()\n  cookieStore.delete(DASHBOARD_VISITED_COOKIE)\n}\n\n/**\n * Helper: Checks if a pathname matches a route exactly or is a subdirectory\n * \n * @param pathname - Current pathname (e.g., '/patient/dashboard')\n * @param route - Route to check against (e.g., '/patient/onboarding')\n * @returns boolean - true if exact match or subdirectory\n * \n * @example\n * matchesRoute('/patient/dashboard', '/patient/dashboard') // true (exact)\n * matchesRoute('/patient/onboarding/consent', '/patient/onboarding') // true (subdir)\n * matchesRoute('/patient/funnels', '/patient/funnel') // false (different)\n */\nfunction matchesRoute(pathname: string, route: string): boolean {\n  return pathname === route || pathname.startsWith(route + '/')\n}\n\n/**\n * Checks if a route requires dashboard-first enforcement\n * \n * @param pathname - The pathname to check (e.g., '/patient/funnels')\n * @returns boolean - true if route requires dashboard-first\n */\nexport function requiresDashboardFirst(pathname: string): boolean {\n  // Special case: patient root is handled by its own redirect logic\n  if (pathname === PATIENT_ROOT) {\n    return false\n  }\n\n  // Check if it's an exempt route (exact match or subdirectory)\n  const isExempt = EXEMPT_ROUTES.some((route) => matchesRoute(pathname, route))\n  \n  if (isExempt) {\n    return false\n  }\n\n  // Special case: patient-reachable funnels are exempt from dashboard-first\n  // This allows direct access to allowlisted funnels like stress-assessment\n  if (isFunnelRoute(pathname)) {\n    const slug = extractFunnelSlug(pathname)\n    if (slug && isFunnelPatientReachable(slug)) {\n      return false\n    }\n  }\n\n  // Check if it's a protected route (prefix match)\n  return PROTECTED_ROUTES.some((route) => pathname.startsWith(route))\n}\n\n/**\n * Enforces dashboard-first policy for protected routes\n * \n * @param pathname - Current pathname\n * @returns Promise<string | null> - Redirect URL if dashboard visit required, null otherwise\n * \n * @example\n * ```typescript\n * // In a page component\n * const redirectUrl = await enforceDashboardFirst(pathname)\n * if (redirectUrl) {\n *   redirect(redirectUrl)\n * }\n * ```\n */\nexport async function enforceDashboardFirst(pathname: string): Promise<string | null> {\n  // Check if this route requires dashboard-first\n  if (!requiresDashboardFirst(pathname)) {\n    return null\n  }\n\n  // Check if dashboard has been visited\n  const hasVisited = await hasDashboardVisit()\n  \n  if (!hasVisited) {\n    // Redirect to dashboard with return URL\n    const returnUrl = encodeURIComponent(pathname)\n    return `/patient/dashboard?return=${returnUrl}`\n  }\n\n  return null\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;;;;;;;;;;CAaC,GAED;AACA;AACA;;;;AAEA;;CAEC,GACD,MAAM,2BAA2B;AAEjC;;CAEC,GACD,MAAM,iBAAiB,KAAK,GAAG,SAAS;;AAExC;;;CAGC,GACD,MAAM,mBAAmB;IACvB;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED;;;CAGC,GACD,MAAM,gBAAgB;IACpB;IACA;CACD;AAED;;CAEC,GACD,MAAM,eAAe;AAErB;;CAEC,GACD,MAAM,sBAAsB;AAOrB,SAAS,kBAAkB,QAAgB;IAChD,IAAI,CAAC,SAAS,UAAU,CAAC,sBAAsB;QAC7C,OAAO;IACT;IACA,0EAA0E;IAC1E,yFAAyF;IACzF,MAAM,YAAY,SAAS,KAAK,CAAC,oBAAoB,MAAM;IAC3D,MAAM,UAAU,UAAU,OAAO,CAAC;IAClC,OAAO,YAAY,CAAC,IAAI,YAAY,UAAU,KAAK,CAAC,GAAG;AACzD;AAKO,SAAS,cAAc,QAAgB;IAC5C,OAAO,SAAS,UAAU,CAAC;AAC7B;AAOO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,MAAM,UAAU,YAAY,GAAG,CAAC;IAChC,OAAO,SAAS,UAAU;AAC5B;AAMO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,MAAM,eAAe,iHAAG,CAAC,QAAQ,KAAK;IAEtC,YAAY,GAAG,CAAC,0BAA0B,QAAQ;QAChD,QAAQ;QACR,UAAU;QACV,UAAU;QACV,MAAM;QACN,QAAQ;IACV;AACF;AAMO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,YAAY,MAAM,CAAC;AACrB;AAEA;;;;;;;;;;;CAWC,GACD,SAAS,aAAa,QAAgB,EAAE,KAAa;IACnD,OAAO,aAAa,SAAS,SAAS,UAAU,CAAC,QAAQ;AAC3D;AAQO,SAAS,uBAAuB,QAAgB;IACrD,kEAAkE;IAClE,IAAI,aAAa,cAAc;QAC7B,OAAO;IACT;IAEA,8DAA8D;IAC9D,MAAM,WAAW,cAAc,IAAI,CAAC,CAAC,QAAU,aAAa,UAAU;IAEtE,IAAI,UAAU;QACZ,OAAO;IACT;IAEA,0EAA0E;IAC1E,0EAA0E;IAC1E,IAAI,cAAc,WAAW;QAC3B,MAAM,OAAO,kBAAkB;QAC/B,IAAI,QAAQ,IAAA,4JAAwB,EAAC,OAAO;YAC1C,OAAO;QACT;IACF;IAEA,iDAAiD;IACjD,OAAO,iBAAiB,IAAI,CAAC,CAAC,QAAU,SAAS,UAAU,CAAC;AAC9D;AAiBO,eAAe,sBAAsB,QAAgB;IAC1D,+CAA+C;IAC/C,IAAI,CAAC,uBAAuB,WAAW;QACrC,OAAO;IACT;IAEA,sCAAsC;IACtC,MAAM,aAAa,MAAM;IAEzB,IAAI,CAAC,YAAY;QACf,wCAAwC;QACxC,MAAM,YAAY,mBAAmB;QACrC,OAAO,CAAC,0BAA0B,EAAE,WAAW;IACjD;IAEA,OAAO;AACT"}},
    {"offset": {"line": 663, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/apps/rhythm-patient-ui/app/patient/dashboard/client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/apps/rhythm-patient-ui/app/patient/dashboard/client.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/rhythm-patient-ui/app/patient/dashboard/client.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;;AAAA,uEAAuE;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAA2T,GACxV,yFACA","ignoreList":[0]}},
    {"offset": {"line": 677, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/apps/rhythm-patient-ui/app/patient/dashboard/client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/apps/rhythm-patient-ui/app/patient/dashboard/client.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/rhythm-patient-ui/app/patient/dashboard/client.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;;AAAA,uEAAuE;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAAuS,GACpU,qEACA","ignoreList":[0]}},
    {"offset": {"line": 691, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 699, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/rhythmologicum-connect/rhythmologicum-connect/apps/rhythm-patient-ui/app/patient/dashboard/page.tsx"],"sourcesContent":["import { redirect } from 'next/navigation'\nimport { createServerSupabaseClient } from '@/lib/db/supabase.server'\nimport { markDashboardVisited } from '@/lib/utils/dashboardFirstPolicy'\nimport DashboardClient from './client'\n\nexport const dynamic = 'force-dynamic'\n\n/**\n * Patient Dashboard Page (E6.4.2, E6.5.1)\n * \n * Landing page after onboarding completion.\n * Shows next steps for patient (start/continue assessments).\n * \n * E6.5.1: Dashboard-first entry point - marks dashboard as visited\n * V061-I04: Crash-proof hardening - all operations guarded with try-catch\n * \n * Route: /patient/dashboard\n */\nexport default async function PatientDashboardPage() {\n  // V061-I04: Deterministic logging - no PHI, only step markers\n  console.log('[PATIENT_DASHBOARD] STEP=pageRender start=true')\n  \n  // STEP 1: Create Supabase server client\n  // V061-I04: Already has try-catch with deterministic redirect\n  let supabase\n  try {\n    supabase = await createServerSupabaseClient()\n    console.log('[PATIENT_DASHBOARD] STEP=createSupabaseClient success=true')\n  } catch (err) {\n    // Fail-closed: configuration error → redirect to login with error marker\n    console.error('[PATIENT_DASHBOARD] STEP=createSupabaseClient success=false', {\n      errorType: err instanceof Error ? err.name : 'unknown',\n      errorMessage: err instanceof Error ? err.message : String(err),\n    })\n    redirect('/?error=configuration_error')\n  }\n\n  // STEP 2: Check authentication (AC3: 401-first, no DB calls before auth)\n  // V061-I04: Already has try-catch with deterministic redirect\n  let user\n  try {\n    const { data, error } = await supabase.auth.getUser()\n    user = data?.user\n    console.log('[PATIENT_DASHBOARD] STEP=getUser success=true', {\n      hasUser: !!user,\n      hasError: !!error,\n    })\n    if (error) {\n      console.error('[PATIENT_DASHBOARD] STEP=getUser authError', {\n        errorMessage: error.message,\n      })\n    }\n  } catch (err) {\n    // Auth service error → redirect to login\n    console.error('[PATIENT_DASHBOARD] STEP=getUser success=false', {\n      errorType: err instanceof Error ? err.name : 'unknown',\n      errorMessage: err instanceof Error ? err.message : String(err),\n    })\n    redirect('/?error=auth_error')\n  }\n\n  if (!user) {\n    console.log('[PATIENT_DASHBOARD] STEP=redirect reason=noUser')\n    redirect('/')\n  }\n\n  // STEP 3: E6.5.1 AC1: Mark dashboard as visited for this session\n  // This allows subsequent navigation to funnels/results\n  // V061-I04: Already has try-catch - cookie error is non-fatal\n  try {\n    await markDashboardVisited()\n    console.log('[PATIENT_DASHBOARD] STEP=markDashboardVisited success=true')\n  } catch (err) {\n    // Cookie error is non-fatal: log but continue\n    console.error('[PATIENT_DASHBOARD] STEP=markDashboardVisited success=false', {\n      errorType: err instanceof Error ? err.name : 'unknown',\n      errorMessage: err instanceof Error ? err.message : String(err),\n    })\n    // Continue rendering - dashboard visit tracking is not critical\n  }\n\n  // STEP 4: Render client component\n  // V061-I04: Client component handles its own errors via useDashboardData hook\n  console.log('[PATIENT_DASHBOARD] STEP=render success=true')\n  return <DashboardClient />\n}\n"],"names":[],"mappings":";;;;;;;AAAA;AAAA;AACA;AACA;AACA;;;;;;AAEO,MAAM,UAAU;AAaR,eAAe;IAC5B,8DAA8D;IAC9D,QAAQ,GAAG,CAAC;IAEZ,wCAAwC;IACxC,8DAA8D;IAC9D,IAAI;IACJ,IAAI;QACF,WAAW,MAAM,IAAA,6JAA0B;QAC3C,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,KAAK;QACZ,yEAAyE;QACzE,QAAQ,KAAK,CAAC,+DAA+D;YAC3E,WAAW,eAAe,QAAQ,IAAI,IAAI,GAAG;YAC7C,cAAc,eAAe,QAAQ,IAAI,OAAO,GAAG,OAAO;QAC5D;QACA,IAAA,iMAAQ,EAAC;IACX;IAEA,yEAAyE;IACzE,8DAA8D;IAC9D,IAAI;IACJ,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QACnD,OAAO,MAAM;QACb,QAAQ,GAAG,CAAC,iDAAiD;YAC3D,SAAS,CAAC,CAAC;YACX,UAAU,CAAC,CAAC;QACd;QACA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,8CAA8C;gBAC1D,cAAc,MAAM,OAAO;YAC7B;QACF;IACF,EAAE,OAAO,KAAK;QACZ,yCAAyC;QACzC,QAAQ,KAAK,CAAC,kDAAkD;YAC9D,WAAW,eAAe,QAAQ,IAAI,IAAI,GAAG;YAC7C,cAAc,eAAe,QAAQ,IAAI,OAAO,GAAG,OAAO;QAC5D;QACA,IAAA,iMAAQ,EAAC;IACX;IAEA,IAAI,CAAC,MAAM;QACT,QAAQ,GAAG,CAAC;QACZ,IAAA,iMAAQ,EAAC;IACX;IAEA,iEAAiE;IACjE,uDAAuD;IACvD,8DAA8D;IAC9D,IAAI;QACF,MAAM,IAAA,4JAAoB;QAC1B,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,KAAK;QACZ,8CAA8C;QAC9C,QAAQ,KAAK,CAAC,+DAA+D;YAC3E,WAAW,eAAe,QAAQ,IAAI,IAAI,GAAG;YAC7C,cAAc,eAAe,QAAQ,IAAI,OAAO,GAAG,OAAO;QAC5D;IACA,gEAAgE;IAClE;IAEA,kCAAkC;IAClC,8EAA8E;IAC9E,QAAQ,GAAG,CAAC;IACZ,qBAAO,8OAAC,oLAAe;;;;;AACzB"}}]
}