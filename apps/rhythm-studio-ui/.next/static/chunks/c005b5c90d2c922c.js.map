{"version":3,"sources":["turbopack:///[project]/apps/rhythm-studio-ui/app/clinician/funnels/page.tsx","turbopack:///[project]/lib/config/funnelAllowlist.ts"],"sourcesContent":["'use client'\n\nimport { useEffect, useState } from 'react'\nimport Link from 'next/link'\nimport { Button, Card, Badge, LoadingSpinner, ErrorState, PageHeader } from '@/lib/ui'\nimport { spacing } from '@/lib/design-tokens'\nimport { isFunnelPatientReachable } from '@/lib/config/funnelAllowlist'\n\nexport const dynamic = 'force-dynamic'\n\ntype Funnel = {\n  id: string\n  slug: string\n  title: string\n  description: string | null\n  is_active: boolean\n  created_at: string\n  updated_at: string\n  default_version?: string | null\n}\n\ntype PillarGroup = {\n  pillar: {\n    id: string\n    key: string\n    title: string\n    description: string | null\n    sort_order: number\n  }\n  funnels: Funnel[]\n}\n\nexport default function FunnelListPage() {\n  const [funnels, setFunnels] = useState<Funnel[]>([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n\n  useEffect(() => {\n    loadFunnels()\n  }, [])\n\n  const loadFunnels = async () => {\n    try {\n      setLoading(true)\n      setError(null)\n\n      const response = await fetch('/api/admin/funnels')\n\n      type FunnelsApiEnvelope = {\n        success?: boolean\n        data?: {\n          pillars?: PillarGroup[]\n          uncategorized_funnels?: Funnel[]\n        }\n        error?: { message?: string; requestId?: string }\n      }\n\n      let data: unknown = null\n      try {\n        data = await response.json()\n      } catch {\n        // ignore\n      }\n\n      const envelope: FunnelsApiEnvelope | null =\n        data && typeof data === 'object' ? (data as FunnelsApiEnvelope) : null\n\n      const headerRequestId = response.headers.get('x-request-id')\n      const bodyRequestId = envelope?.error?.requestId\n      const requestId = bodyRequestId || headerRequestId\n\n      if (!response.ok || !envelope?.success) {\n        const message = envelope?.error?.message || 'Failed to load funnels'\n        const requestIdSuffix = requestId ? ` (requestId: ${requestId})` : ''\n        throw new Error(`${message}${requestIdSuffix}`)\n      }\n\n      const pillars: PillarGroup[] = envelope.data?.pillars || []\n      const uncategorized: Funnel[] = envelope.data?.uncategorized_funnels || []\n\n      const flattened: Funnel[] = [\n        ...pillars.flatMap((p) => p.funnels || []),\n        ...(uncategorized || []),\n      ]\n\n      setFunnels(flattened)\n    } catch (err) {\n      console.error('Error loading funnels:', err)\n      setError(err instanceof Error ? err.message : 'Fehler beim Laden der Funnels')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <LoadingSpinner size=\"lg\" text=\"Lade Funnels…\" centered />\n      </div>\n    )\n  }\n\n  if (error) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <ErrorState\n          title=\"Fehler beim Laden\"\n          message={error}\n          onRetry={loadFunnels}\n          centered\n        />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"w-full\">\n      {/* Page Header */}\n      <PageHeader\n        title=\"Funnel Verwaltung\"\n        description=\"Übersicht und Verwaltung aller Funnel-Definitionen\"\n      />\n\n      {/* Back to Dashboard */}\n      <div style={{ marginBottom: spacing.lg }}>\n        <Link\n          href=\"/clinician\"\n          className=\"inline-flex items-center text-sm text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300 font-medium\"\n        >\n          ← Zurück zum Dashboard\n        </Link>\n      </div>\n\n      {/* Funnel List */}\n      {funnels.length === 0 ? (\n        <Card padding=\"lg\">\n          <p className=\"text-slate-600 dark:text-slate-300 text-center\">Keine Funnels gefunden.</p>\n        </Card>\n      ) : (\n        <div className=\"space-y-4\">\n          {funnels.map((funnel) => (\n            <Card key={funnel.id} padding=\"lg\" interactive>\n              <div className=\"flex items-start justify-between gap-4\">\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-3 mb-2\">\n                    <h3 className=\"text-lg font-semibold text-slate-900 dark:text-slate-50 truncate\">\n                      {funnel.title}\n                    </h3>\n                    <Badge variant={funnel.is_active ? 'success' : 'secondary'} size=\"sm\">\n                      {funnel.is_active ? 'Aktiv' : 'Inaktiv'}\n                    </Badge>\n                    {!isFunnelPatientReachable(funnel.slug) && (\n                      <span title=\"Nur für Clinicians sichtbar, Patienten können diesen Funnel nicht starten\">\n                        <Badge variant=\"warning\" size=\"sm\">\n                          ADMIN-ONLY\n                        </Badge>\n                      </span>\n                    )}\n                  </div>\n\n                  {funnel.description && (\n                    <p className=\"text-sm text-slate-500 dark:text-slate-400 mb-2\">{funnel.description}</p>\n                  )}\n\n                  <div className=\"flex items-center gap-4 text-xs text-slate-400 dark:text-slate-500\">\n                    <span>ID: {funnel.slug}</span>\n                    <span>•</span>\n                    <span>\n                      Erstellt: {new Date(funnel.created_at).toLocaleDateString('de-DE')}\n                    </span>\n                  </div>\n                </div>\n\n                <Link href={`/clinician/funnels/${funnel.slug}`}>\n                  <Button variant=\"primary\" size=\"sm\">\n                    Details\n                  </Button>\n                </Link>\n              </div>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n}\n","/**\n * Funnel Reachability Allowlist\n *\n * Defines which funnel slugs are patient-reachable (can be accessed directly).\n * Funnels not in this allowlist are \"ADMIN-ONLY\" and cannot be started by patients.\n *\n * Note: `is_active` in the database means the funnel definition is active,\n * NOT that patients can start it. This allowlist controls patient reachability.\n *\n * @module lib/config/funnelAllowlist\n */\n\n/**\n * Patient-reachable funnel slugs\n *\n * Add slugs here to make them accessible to patients.\n * Remove or don't include slugs to restrict them to admin-only.\n */\nexport const PATIENT_REACHABLE_FUNNELS: readonly string[] = [\n  'stress-assessment',\n  'cardiovascular-age',\n  // Add more slugs as they become patient-ready:\n  // 'sleep-quality',\n] as const\n\n/**\n * Check if a funnel slug is patient-reachable\n *\n * @param slug - The funnel slug to check\n * @returns true if patients can access/start this funnel\n */\nexport function isFunnelPatientReachable(slug: string): boolean {\n  return PATIENT_REACHABLE_FUNNELS.includes(slug)\n}\n\n/**\n * Default funnel slug for new patient assessments\n * Used by NextStep resolver when patient hasn't started any funnel\n */\nexport const DEFAULT_PATIENT_FUNNEL = 'stress-assessment' as const\n"],"names":[],"mappings":"wJAEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,KAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OCaO,IAAM,EAA+C,CAC1D,oBACA,qBAGD,CDSc,SAAS,IACtB,GAAM,CAAC,EAAS,EAAW,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAW,EAAE,EAC7C,CAAC,EAAS,EAAW,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,GAAC,GACjC,CAAC,EAAO,EAAS,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAgB,MAElD,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACR,GACF,EAAG,EAAE,EAEL,IAAM,EAAc,UAClB,GAAI,CACF,GAAW,GACX,EAAS,MAET,IAAM,EAAW,MAAM,MAAM,sBAWzB,EAAgB,KACpB,GAAI,CACF,EAAO,MAAM,EAAS,IAAI,EAC5B,CAAE,KAAM,CAER,CAEA,IAAM,EACJ,GAAwB,UAAhB,OAAO,EAAqB,EAA8B,KAE9D,EAAkB,EAAS,OAAO,CAAC,GAAG,CAAC,gBAEvC,EADgB,AACJ,GADc,OAAO,WACJ,EAEnC,GAAI,CAAC,EAAS,EAAE,EAAI,CAAC,GAAU,QAAS,CACtC,IAAM,EAAU,GAAU,OAAO,SAAW,yBACtC,EAAkB,EAAY,CAAC,aAAa,EAAE,EAAU,CAAC,CAAC,CAAG,EACnE,OAAM,AAAI,MAAM,CAAA,EAAG,EAAA,EAAU,EAAA,CAAiB,CAChD,CAEA,IAAM,EAAyB,EAAS,IAAI,EAAE,SAAW,EAAE,CACrD,EAA0B,EAAS,IAAI,EAAE,uBAAyB,EAAE,CAEpE,EAAsB,IACvB,EAAQ,OAAO,CAAC,AAAC,GAAM,EAAE,OAAO,EAAI,EAAE,KACrC,GAAiB,EAAE,CACxB,CAED,EAAW,EACb,CAAE,MAAO,EAAK,CACZ,QAAQ,KAAK,CAAC,yBAA0B,GACxC,EAAS,aAAe,MAAQ,EAAI,OAAO,CAAG,gCAChD,QAAU,CACR,GAAW,EACb,CACF,SAEA,AAAI,EAEA,CAAA,EAAA,EAAA,EAFS,CAET,EAAC,MAAA,CAAI,UAAU,kDACb,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,cAAc,CAAA,CAAC,KAAK,KAAK,KAAK,gBAAgB,QAAQ,CAAA,CAAA,MAKzD,EAEA,CAAA,EAAA,EAFO,AAEP,GAAA,EAAC,MAAA,CAAI,UAAU,kDACb,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,UAAU,CAAA,CACT,MAAM,oBACN,QAAS,EACT,QAAS,EACT,QAAQ,CAAA,CAAA,MAOd,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,mBAEb,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,UAAU,CAAA,CACT,MAAM,oBACN,YAAY,uDAId,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,MAAO,CAAE,aAAc,EAAA,OAAO,CAAC,EAAE,AAAC,WACrC,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAI,CAAA,CACH,KAAK,aACL,UAAU,kIACX,6BAMiB,IAAnB,EAAQ,MAAM,CACb,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAC,QAAQ,cACZ,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,0DAAiD,8BAGhE,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,qBACZ,EAAQ,GAAG,CAAC,AAAC,gBACZ,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAiB,QAAQ,KAAK,WAAW,CAAA,CAAA,WAC5C,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,mDACb,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,2BACb,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,yCACb,CAAA,EAAA,EAAA,GAAA,EAAC,KAAA,CAAG,UAAU,4EACX,EAAO,KAAK,GAEf,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,KAAK,CAAA,CAAC,QAAS,EAAO,SAAS,CAAG,UAAY,YAAa,KAAK,cAC9D,EAAO,SAAS,CAAG,QAAU,aCtHX,ADwHpB,CAAC,CAAyB,EAAO,ACxHD,IDwHK,ECvHjD,EAA0B,QAAQ,CAAC,IDwHtB,CAAA,EAAA,EAAA,GAAA,EAAC,OAAA,CAAK,MAAM,qFACV,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,KAAK,CAAA,CAAC,QAAQ,UAAU,KAAK,cAAK,qBAOxC,EAAO,WAAW,EACjB,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,2DAAmD,EAAO,WAAW,GAGpF,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,+EACb,CAAA,EAAA,EAAA,IAAA,EAAC,OAAA,WAAK,OAAK,EAAO,IAAI,IACtB,CAAA,EAAA,EAAA,GAAA,EAAC,OAAA,UAAK,MACN,CAAA,EAAA,EAAA,IAAA,EAAC,OAAA,WAAK,aACO,IAAI,KAAK,EAAO,UAAU,EAAE,kBAAkB,CAAC,kBAKhE,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAI,CAAA,CAAC,KAAM,CAAC,mBAAmB,EAAE,EAAO,IAAI,CAAA,CAAE,UAC7C,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,MAAM,CAAA,CAAC,QAAQ,UAAU,KAAK,cAAK,kBAjC/B,EAAO,EAAE,QA4ChC,kCAjLuB"}