{"version":3,"sources":["../../../../../lib/api/pilotEligibility.ts"],"sourcesContent":["import { User } from '@supabase/supabase-js'\nimport { createServerSupabaseClient } from '@/lib/db/supabase.server'\nimport { env } from '@/lib/env'\n\n/**\n * E6.4.1: Pilot Eligibility Checking\n * \n * Provides utilities to check if a user is eligible for v0.6 pilot features.\n * Implements fail-closed access control with allowlists for organizations and users.\n */\n\n/**\n * Environment-based pilot configuration\n * Functions read from env dynamically to support testing\n */\n\n/**\n * Get pilot organization allowlist\n */\nfunction getPilotOrgAllowlist(): string[] {\n  const allowlistEnv = env.PILOT_ORG_ALLOWLIST || ''\n  return allowlistEnv.split(',').filter(Boolean)\n}\n\n/**\n * Get pilot user allowlist\n */\nfunction getPilotUserAllowlist(): string[] {\n  const allowlistEnv = env.PILOT_USER_ALLOWLIST || ''\n  return allowlistEnv.split(',').filter(Boolean)\n}\n\n/**\n * Check if pilot features are enabled globally\n */\nexport function isPilotEnabled(): boolean {\n  return env.NEXT_PUBLIC_PILOT_ENABLED === 'true'\n}\n\n/**\n * Check if user is in pilot user allowlist\n */\nexport function isUserInAllowlist(user: User): boolean {\n  if (!isPilotEnabled()) return false\n  \n  const allowlist = getPilotUserAllowlist()\n  \n  // Check by email\n  if (user.email && allowlist.includes(user.email)) {\n    return true\n  }\n  \n  // Check by user ID\n  if (allowlist.includes(user.id)) {\n    return true\n  }\n  \n  return false\n}\n\n/**\n * Check if organization is in pilot organization allowlist\n */\nexport function isOrgInAllowlist(orgId: string): boolean {\n  if (!isPilotEnabled()) return false\n  const allowlist = getPilotOrgAllowlist()\n  return allowlist.includes(orgId)\n}\n\n/**\n * Check if user is eligible for pilot based on database flags\n * This checks user_profiles.pilot_enabled or similar DB flags\n */\nexport async function checkUserPilotFlag(userId: string): Promise<boolean> {\n  try {\n    const supabase = await createServerSupabaseClient()\n    \n    // Check if user has pilot_enabled flag in user_profiles\n    const { data, error } = await supabase\n      .from('user_profiles')\n      .select('metadata')\n      .eq('user_id', userId)\n      .single()\n    \n    if (error || !data) {\n      return false\n    }\n    \n    // Check for pilot_enabled in metadata JSONB field\n    const metadata = data.metadata as Record<string, unknown> | null\n    return metadata?.pilot_enabled === true\n  } catch (error) {\n    console.error('Error checking user pilot flag:', error)\n    return false\n  }\n}\n\n/**\n * Check if user's organization has pilot enabled\n */\nexport async function checkOrgPilotFlag(userId: string): Promise<boolean> {\n  try {\n    const supabase = await createServerSupabaseClient()\n    \n    // Get user's organization memberships\n    const { data: memberships, error: memberError } = await supabase\n      .from('user_org_membership')\n      .select('organization_id, is_active')\n      .eq('user_id', userId)\n      .eq('is_active', true)\n    \n    if (memberError || !memberships || memberships.length === 0) {\n      return false\n    }\n    \n    // Check if any of the user's organizations has pilot enabled\n    const orgIds = memberships.map((m) => m.organization_id)\n    \n    const { data: orgs, error: orgError } = await supabase\n      .from('organizations')\n      .select('id, settings')\n      .in('id', orgIds)\n    \n    if (orgError || !orgs) {\n      return false\n    }\n    \n    // Check if any organization has pilot_enabled in settings\n    return orgs.some((org) => {\n      const settings = org.settings as Record<string, unknown> | null\n      return settings?.pilot_enabled === true\n    })\n  } catch (error) {\n    console.error('Error checking org pilot flag:', error)\n    return false\n  }\n}\n\n/**\n * Comprehensive eligibility check for pilot features\n * Returns true if user is eligible for pilot access\n * \n * Checks in order:\n * 1. Global pilot enabled flag\n * 2. User allowlist (email or ID)\n * 3. User DB flag (metadata.pilot_enabled)\n * 4. Organization allowlist\n * 5. Organization DB flag (settings.pilot_enabled)\n */\nexport async function isPilotEligible(user: User): Promise<boolean> {\n  // If pilot is globally disabled, no one is eligible\n  if (!isPilotEnabled()) {\n    return false\n  }\n  \n  // Check user allowlist first (fastest check)\n  if (isUserInAllowlist(user)) {\n    return true\n  }\n  \n  // Check user DB flag\n  const userPilotFlag = await checkUserPilotFlag(user.id)\n  if (userPilotFlag) {\n    return true\n  }\n  \n  // Check organization allowlist and DB flags\n  const orgPilotFlag = await checkOrgPilotFlag(user.id)\n  if (orgPilotFlag) {\n    return true\n  }\n  \n  // Fail-closed: deny if none of the checks passed\n  return false\n}\n\n/**\n * Check if specific environment is allowed for pilot\n * Optional additional gate for staging-only pilots\n */\nexport function isPilotEnvironment(): boolean {\n  const pilotEnv = env.NEXT_PUBLIC_PILOT_ENV || 'production'\n  const nodeEnv = env.NODE_ENV\n  \n  if (pilotEnv === 'all') return true\n  if (pilotEnv === 'staging' && nodeEnv !== 'production') return true\n  if (pilotEnv === 'production') return true\n  return false\n}\n\n/**\n * Full eligibility check including environment gate\n */\nexport async function isPilotEligibleFull(user: User): Promise<boolean> {\n  if (!isPilotEnvironment()) {\n    return false\n  }\n  \n  return isPilotEligible(user)\n}\n"],"names":[],"mappings":"uCACA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAiCO,SAAS,IACd,MAAyC,SAAlC,EAAA,GAAG,CAAC,yBAAyB,AACtC,CAKO,SAAS,EAAkB,CAAU,EAC1C,GAAI,CAAC,IAAkB,MAAO,GAE9B,IAAM,EAhBC,CADc,EAAA,GAAG,CAAC,GAiBP,iBAjB2B,EAAI,EAAA,EAC7B,KAAK,CAAC,KAAK,MAAM,CAAC,kBAmBlC,EAAK,KAAK,EAAI,EAAU,QAAQ,CAAC,EAAK,KAAK,GAAG,AAK9C,EAAU,QAAQ,CAAC,EAAK,EAAE,EAKhC,CALmC,AAU5B,SAAS,EAAiB,CAAa,QAC5C,CAAI,CAAC,KA3CE,AA6CA,CA9Cc,EAAA,GAAG,CAAC,MA4CF,OAAO,MA5Cc,EAAI,EAAA,EAC5B,KAAK,CAAC,KAAK,MAAM,CAAC,SA6CrB,QAAQ,CAAC,EAC5B,CAMO,eAAe,EAAmB,CAAc,EACrD,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,0BAAA,AAA0B,IAG3C,MAAE,CAAI,CAAE,OAAK,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,iBACL,MAAM,CAAC,YACP,EAAE,CAAC,UAAW,GACd,MAAM,GAET,GAAI,GAAS,CAAC,EACZ,IADkB,EACX,GAIT,IAAM,EAAW,EAAK,QAAQ,CAC9B,OAAO,GAAU,iBAAkB,CACrC,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,kCAAmC,IAC1C,CACT,CACF,CAKO,eAAe,EAAkB,CAAc,EACpD,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,0BAAA,AAA0B,IAG3C,CAAE,KAAM,CAAW,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EACrD,IAAI,CAAC,uBACL,MAAM,CAAC,8BACP,EAAE,CAAC,UAAW,GACd,EAAE,CAAC,aAAa,GAEnB,GAAI,GAAe,CAAC,GAAsC,GAAG,CAA1B,EAAY,MAAM,CACnD,OAAO,EAIT,IAAM,EAAS,EAAY,GAAG,CAAC,AAAC,GAAM,EAAE,eAAe,EAEjD,CAAE,KAAM,CAAI,CAAE,MAAO,CAAQ,CAAE,CAAG,MAAM,EAC3C,IAAI,CAAC,iBACL,MAAM,CAAC,gBACP,EAAE,CAAC,KAAM,GAEZ,GAAI,GAAY,CAAC,EACf,IADqB,EACd,GAIT,OAAO,EAAK,IAAI,CAAC,AAAC,IAChB,IAAM,EAAW,EAAI,QAAQ,CAC7B,OAAO,GAAU,iBAAkB,CACrC,EACF,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,iCAAkC,IACzC,CACT,CACF,CAaO,eAAe,EAAgB,CAAU,QAE9C,CAAI,CAAC,QAKD,EAAkB,IAKA,GALO,CALN,EAUK,EAAmB,EAAK,EAAE,GAMjC,MAAM,EAAkB,EAAK,EAAE,EAOtD,CAMO,SAAS,IACd,IAAM,EAAW,EAAA,GAAG,CAAC,qBAAqB,EAAI,aACxC,EAAU,EAAA,GAAG,CAAC,QAAQ,OAEX,OAAO,CAApB,GACa,GADc,SAC3B,GAAsC,cAAc,CAA1B,GACb,GAD8C,WAChC,CAA3B,CAEN,CAKO,IAPiC,WAOlB,EAAoB,CAAU,QAClD,CAAI,CAAC,KAIE,EAAgB,EACzB,aAL6B"}