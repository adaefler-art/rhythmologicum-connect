module.exports=[44214,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(59756),a=e.i(61916),o=e.i(74677),s=e.i(69741),l=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),c=e.i(66012),f=e.i(70101),_=e.i(74838),R=e.i(10372),h=e.i(93695);e.i(52474);var g=e.i(5232),E=e.i(89171),I=e.i(55509),w=e.i(19551),m=e.i(98426),S=e.i(78145),v=e.i(12892),A=e.i(54707);let q=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;function y(e){return q.test(e.trim())}async function T(e,{params:t}){let r=(0,S.getRequestId)(e);try{let e,n,{id:i}=await t;if((0,S.isBlank)(v.env.NEXT_PUBLIC_SUPABASE_URL)||(0,S.isBlank)(v.env.NEXT_PUBLIC_SUPABASE_ANON_KEY))return(0,S.withRequestId)((0,I.configurationErrorResponse)("Supabase is not configured. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY."),r);let a=await (0,w.createServerSupabaseClient)(),{data:{user:o}}=await a.auth.getUser();if(!o)return(0,S.withRequestId)((0,I.unauthorizedResponse)(),r);let s=o.app_metadata?.role||o.user_metadata?.role;if("clinician"!==s&&"admin"!==s)return(0,S.withRequestId)((0,I.forbiddenResponse)(),r);let l=y(i);if(l?{data:e,error:n}=await a.from("funnels_catalog").select("id, slug, title, description, pillar_id, est_duration_min, outcomes, is_active, default_version_id, created_at, updated_at").eq("id",i).single():{data:e,error:n}=await a.from("funnels_catalog").select("id, slug, title, description, pillar_id, est_duration_min, outcomes, is_active, default_version_id, created_at, updated_at").eq("slug",i).single(),n){let e=(0,S.sanitizeSupabaseError)(n);if("PGRST116"===e.code)return(0,S.withRequestId)((0,I.notFoundResponse)("Funnel",`Funnel not found with ${l?"UUID":"slug"}: "${i}"`),r);let t=(0,S.classifySupabaseError)(e);if("SCHEMA_NOT_READY"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_catalog",userId:o.id,error:e}),(0,S.withRequestId)((0,I.schemaNotReadyResponse)(),r);if("AUTH_OR_RLS"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_catalog",userId:o.id,error:e}),(0,S.withRequestId)((0,I.forbiddenResponse)(),r);if("TRANSIENT"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_catalog",userId:o.id,error:e}),(0,S.withRequestId)((0,I.databaseErrorResponse)(),r);if("CONFIGURATION_ERROR"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_catalog",userId:o.id,error:e}),(0,S.withRequestId)((0,I.configurationErrorResponse)("Server-Konfigurationsfehler (Supabase). Bitte prüfen Sie URL/Keys (gleiches Projekt, keine Anführungszeichen, keine Leerzeichen/Zeilenumbrüche) und deployen Sie erneut."),r);return(0,S.logError)({requestId:r,operation:"fetch_funnel_catalog",userId:o.id,error:e}),(0,S.withRequestId)((0,I.internalErrorResponse)("Failed to fetch funnel."),r)}if(!e)return(0,S.withRequestId)((0,I.notFoundResponse)("Funnel",`Funnel not found with ${l?"UUID":"slug"}: "${i}"`),r);let u=null;if(e.pillar_id){let{data:t}=await a.from("pillars").select("id, key, title, description").eq("id",e.pillar_id).single();u=t}let{data:d,error:p}=await a.from("funnel_versions").select("id, funnel_id, version, is_default, rollout_percent, questionnaire_config, content_manifest, algorithm_bundle_version, prompt_version, created_at, updated_at").eq("funnel_id",e.id).order("version",{ascending:!1}).order("id",{ascending:!0});if(p){let e=(0,S.sanitizeSupabaseError)(p),t=(0,S.classifySupabaseError)(e);if("SCHEMA_NOT_READY"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_versions",userId:o.id,error:e}),(0,S.withRequestId)((0,I.schemaNotReadyResponse)(),r);if("AUTH_OR_RLS"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_versions",userId:o.id,error:e}),(0,S.withRequestId)((0,I.forbiddenResponse)(),r);if("TRANSIENT"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_versions",userId:o.id,error:e}),(0,S.withRequestId)((0,I.databaseErrorResponse)(),r);if("CONFIGURATION_ERROR"===t.kind)return(0,S.logError)({requestId:r,operation:"fetch_funnel_versions",userId:o.id,error:e}),(0,S.withRequestId)((0,I.configurationErrorResponse)("Server-Konfigurationsfehler (Supabase). Bitte prüfen Sie URL/Keys (gleiches Projekt, keine Anführungszeichen, keine Leerzeichen/Zeilenumbrüche) und deployen Sie erneut."),r);return(0,S.logError)({requestId:r,operation:"fetch_funnel_versions",userId:o.id,error:e}),(0,S.withRequestId)((0,I.internalErrorResponse)("Failed to fetch funnel versions."),r)}let c=(d||[]).find(e=>e.is_default)||null,f=[];if(c?.questionnaire_config)try{let t="string"==typeof c.questionnaire_config?JSON.parse(c.questionnaire_config):c.questionnaire_config;if(t.steps&&Array.isArray(t.steps))for(let n=0;n<t.steps.length;n++){let i=t.steps[n],a=[],s=Array.isArray(i.questions)?i.questions:[];for(let e=0;e<s.length;e++){let t=s[e],i="string"==typeof t.type?t.type:"";if(!("string"==typeof i&&Object.values(A.QUESTION_TYPE).includes(i)))return(0,S.logError)({requestId:r,operation:"adapter_validate_question_type",userId:o.id,error:{code:"INVALID_QUESTION_TYPE",message:`Invalid question type "${i}" in manifest (question: ${t.id||e})`,hint:`Valid types: ${Object.values(A.QUESTION_TYPE).join(", ")}`}}),(0,S.withRequestId)(E.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:`Manifest contains invalid question type: "${i}". Valid types: ${Object.values(A.QUESTION_TYPE).join(", ")}`,requestId:r}},{status:422}),r);a.push({id:t.id||`q-${n}-${e}`,key:t.key||"",label:t.label||"",help_text:t.helpText||null,question_type:i,funnel_step_question_id:`fsq-${t.id}`,is_required:t.required||!1,order_index:e})}f.push({id:i.id||`step-${n}`,funnel_id:e.id,order_index:n,title:i.title||"",description:i.description||null,type:"question_step",content_page_id:null,content_page:null,questions:a})}}catch(e){(0,S.logError)({requestId:r,operation:"adapter_parse_manifest",userId:o.id,error:e}),console.warn("Failed to parse questionnaire_config for adapter:",e)}return(0,S.withRequestId)((0,I.successResponse)({funnel:{...e,outcomes:Array.isArray(e.outcomes)?e.outcomes:[],pillar:u},versions:d||[],default_version:c,steps:f}),r)}catch(e){return console.error({requestId:r,operation:"GET /api/admin/funnels/[id]",error:(0,S.sanitizeSupabaseError)(e)}),(0,S.withRequestId)((0,I.internalErrorResponse)(),r)}}async function N(e,{params:t}){let r=(0,S.getRequestId)(e);try{let n,i,a,{id:o}=await t;if((0,S.isBlank)(v.env.NEXT_PUBLIC_SUPABASE_URL)||(0,S.isBlank)(v.env.NEXT_PUBLIC_SUPABASE_ANON_KEY))return(0,S.withRequestId)((0,I.configurationErrorResponse)("Supabase is not configured. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY."),r);let s=await (0,w.createServerSupabaseClient)(),{data:{user:l}}=await s.auth.getUser();if(!l)return(0,S.withRequestId)((0,I.unauthorizedResponse)(),r);let u=l.app_metadata?.role||l.user_metadata?.role;if("clinician"!==u&&"admin"!==u)return(0,S.withRequestId)((0,I.forbiddenResponse)(),r);let d=await e.json(),p={updated_at:new Date().toISOString()};if("boolean"==typeof d.is_active&&(p.is_active=d.is_active),"string"==typeof d.title){let e=d.title.trim();if(0===e.length)return(0,S.withRequestId)((0,I.validationErrorResponse)("Title cannot be empty"),r);if(e.length>255)return(0,S.withRequestId)((0,I.validationErrorResponse)("Title too long (max 255 characters)"),r);p.title=e}if("string"==typeof d.description){let e=d.description.trim();if(e.length>2e3)return(0,S.withRequestId)((0,I.validationErrorResponse)("Description too long (max 2000 characters)"),r);p.description=e||null}let c=!1;try{n=(0,m.createAdminSupabaseClient)(),c=!0}catch(e){(0,S.logError)({requestId:r,operation:"create_admin_client_for_write",userId:l.id,error:e}),n=s}let f=y(o);if(f?{data:i,error:a}=await n.from("funnels_catalog").update(p).eq("id",o).select().single():{data:i,error:a}=await n.from("funnels_catalog").update(p).eq("slug",o).select().single(),a&&c){let e=(0,S.classifySupabaseError)(a);("CONFIGURATION_ERROR"===e.kind||"AUTH_OR_RLS"===e.kind)&&((0,S.logError)({requestId:r,operation:"update_funnel_admin_fallback",userId:l.id,error:a}),c=!1,n=s,f?{data:i,error:a}=await n.from("funnels_catalog").update(p).eq("id",o).select().single():{data:i,error:a}=await n.from("funnels_catalog").update(p).eq("slug",o).select().single())}if(a){let e=(0,S.sanitizeSupabaseError)(a),t=(0,S.classifySupabaseError)(e);if("SCHEMA_NOT_READY"===t.kind)return(0,S.logError)({requestId:r,operation:"update_funnel_catalog",userId:l.id,error:e}),(0,S.withRequestId)((0,I.schemaNotReadyResponse)(),r);if("AUTH_OR_RLS"===t.kind)return(0,S.logError)({requestId:r,operation:"update_funnel_catalog",userId:l.id,error:e}),(0,S.withRequestId)((0,I.forbiddenResponse)(),r);if("TRANSIENT"===t.kind)return(0,S.logError)({requestId:r,operation:"update_funnel_catalog",userId:l.id,error:e}),(0,S.withRequestId)((0,I.databaseErrorResponse)(),r);if("CONFIGURATION_ERROR"===t.kind)return(0,S.logError)({requestId:r,operation:"update_funnel_catalog",userId:l.id,error:e}),(0,S.withRequestId)((0,I.configurationErrorResponse)("Server-Konfigurationsfehler (Supabase). Bitte prüfen Sie URL/Keys (gleiches Projekt, keine Anführungszeichen, keine Leerzeichen/Zeilenumbrüche) und deployen Sie erneut."),r);if("PGRST116"===e.code)return(0,S.withRequestId)((0,I.notFoundResponse)("Funnel",`Funnel not found with ${f?"UUID":"slug"}: "${o}"`),r);return(0,S.logError)({requestId:r,operation:"update_funnel_catalog",userId:l.id,error:e}),(0,S.withRequestId)((0,I.internalErrorResponse)("Failed to update funnel."),r)}return(0,S.withRequestId)((0,I.successResponse)({funnel:i}),r)}catch(e){return console.error({requestId:r,operation:"PATCH /api/admin/funnels/[id]",error:(0,S.sanitizeSupabaseError)(e)}),(0,S.withRequestId)((0,I.internalErrorResponse)(),r)}}e.s(["GET",()=>T,"PATCH",()=>N],93642),e.s([],16232),e.i(16232),e.i(93642),e.s(["GET",()=>T,"PATCH",()=>N],92031);var b=e.i(92031);let U=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/funnels/[id]/route",pathname:"/api/admin/funnels/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/rhythm-studio-ui/app/api/admin/funnels/[id]/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:C,workUnitAsyncStorage:O,serverHooks:P}=U;function k(){return(0,n.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:O})}async function x(e,t,n){U.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/admin/funnels/[id]/route";E=E.replace(/\/index$/,"")||"/";let I=await U.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:m,nextConfig:S,parsedUrl:v,isDraftMode:A,prerenderManifest:q,routerServerContext:y,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,resolvedPathname:b,clientReferenceManifest:C,serverActionsManifest:O}=I,P=(0,s.normalizeAppPath)(E),k=!!(q.dynamicRoutes[P]||q.routes[b]),x=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,v,!1):t.end("This page could not be found"),null);if(k&&!A){let e=!!q.routes[b],t=q.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await x();throw new h.NoFallbackError}}let L=null;!k||U.isDev||A||(L="/index"===(L=b)?"/":L);let B=!0===U.isDev||!k,H=k&&!B;O&&C&&(0,o.setManifestsSingleton)({page:E,clientReferenceManifest:C,serverActionsManifest:O});let F=e.method||"GET",$=(0,a.getTracer)(),D=$.getActiveScopeSpan(),K={params:m,prerenderManifest:q,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,i)=>U.onRequestError(e,t,n,i,y)},sharedContext:{buildId:w}},j=new l.NodeNextRequest(e),M=new l.NodeNextResponse(t),z=u.NextRequestAdapter.fromNodeNextRequest(j,(0,u.signalFromNodeResponse)(t));try{let o=async e=>U.handle(z,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${E}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var a,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&T&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!k)return await (0,c.sendResponse)(j,M,a,K.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[R.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},!1,y),t}},d=await U.handleResponse({req:e,nextConfig:S,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:q,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!k)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&k||h.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,_.getCacheControlHeader)(d.cacheControl)),await (0,c.sendResponse)(j,M,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};D?await l(D):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${E}`,kind:a.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},!1,y),k)throw t;return await (0,c.sendResponse)(j,M,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>k,"routeModule",()=>U,"serverHooks",()=>P,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>O],44214)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_4e361e2e.js.map