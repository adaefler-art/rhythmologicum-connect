module.exports=[51557,e=>{"use strict";var t=e.i(47909),n=e.i(74017),r=e.i(96250),a=e.i(59756),i=e.i(61916),o=e.i(74677),s=e.i(69741),l=e.i(16795),u=e.i(87718),d=e.i(95169),c=e.i(47587),p=e.i(66012),E=e.i(70101),f=e.i(74838),m=e.i(10372),_=e.i(93695);e.i(52474);var h=e.i(5232),g=e.i(89171),R=e.i(55509),T=e.i(19551),I=e.i(98426),v=e.i(78145),S=e.i(12892),N=e.i(69719),A=e.i(54707);let U=["http:","https:","mailto:","tel:"];function z(e,t=!1){if(!e||"string"!=typeof e||e.length>2048)return!1;let n=e.trim().toLowerCase();if(0===n.length)return!1;for(let e of["javascript:","vbscript:","file:","about:"])if(n.startsWith(e))return!1;if(n.startsWith("data:"))return t;if(n.startsWith("/")||n.startsWith("./")||n.startsWith("../"))return!0;try{let t=new URL(e);return U.includes(t.protocol)}catch{return!n.includes(":")}}let O=N.z.preprocess(e=>null===e?void 0:e,N.z.string().optional()).optional(),w=N.z.string().refine(e=>!e||""===e.trim()||z(e,!1),{message:"URL must use http:, https:, mailto:, tel:, or be a relative path. Dangerous protocols (javascript:, data:, vbscript:, file:) are not allowed."}),P=N.z.object({required:N.z.boolean().optional(),min:N.z.number().optional(),max:N.z.number().optional(),pattern:N.z.string().optional(),message:N.z.string().optional()}),y=N.z.object({value:N.z.string(),label:N.z.string(),helpText:O}),b=N.z.object({id:N.z.string(),key:N.z.string(),type:N.z.preprocess(function(e){if("string"!=typeof e)return e;let t=e.toLowerCase().trim();return Object.values(A.QUESTION_TYPE).includes(t)?t:({single_choice:A.QUESTION_TYPE.RADIO,"single-choice":A.QUESTION_TYPE.RADIO,select_one:A.QUESTION_TYPE.RADIO,"select-one":A.QUESTION_TYPE.RADIO,multiple_choice:A.QUESTION_TYPE.RADIO,multi_choice:A.QUESTION_TYPE.CHECKBOX,"multi-choice":A.QUESTION_TYPE.CHECKBOX,select_many:A.QUESTION_TYPE.CHECKBOX,"select-many":A.QUESTION_TYPE.CHECKBOX,multiple_select:A.QUESTION_TYPE.CHECKBOX,"multiple-select":A.QUESTION_TYPE.CHECKBOX,short_text:A.QUESTION_TYPE.TEXT,"short-text":A.QUESTION_TYPE.TEXT,string:A.QUESTION_TYPE.TEXT,long_text:A.QUESTION_TYPE.TEXTAREA,"long-text":A.QUESTION_TYPE.TEXTAREA,paragraph:A.QUESTION_TYPE.TEXTAREA,integer:A.QUESTION_TYPE.NUMBER,float:A.QUESTION_TYPE.NUMBER,decimal:A.QUESTION_TYPE.NUMBER,likert:A.QUESTION_TYPE.SCALE,likert_scale:A.QUESTION_TYPE.SCALE,"likert-scale":A.QUESTION_TYPE.SCALE,rating:A.QUESTION_TYPE.SCALE,range:A.QUESTION_TYPE.SLIDER})[t]??t},N.z.enum([A.QUESTION_TYPE.RADIO,A.QUESTION_TYPE.CHECKBOX,A.QUESTION_TYPE.TEXT,A.QUESTION_TYPE.TEXTAREA,A.QUESTION_TYPE.NUMBER,A.QUESTION_TYPE.SCALE,A.QUESTION_TYPE.SLIDER])),label:N.z.string(),helpText:O,required:N.z.boolean().default(!1),options:N.z.array(y).optional(),validation:P.optional(),minValue:N.z.number().optional(),maxValue:N.z.number().optional()}),C=N.z.object({type:N.z.enum(["show","hide","skip"]),conditions:N.z.array(N.z.object({questionId:N.z.string(),operator:N.z.enum(["eq","neq","gt","gte","lt","lte","in","notIn"]),value:N.z.union([N.z.string(),N.z.number(),N.z.boolean(),N.z.array(N.z.string())])})),logic:N.z.enum(["and","or"]).default("and")}),x=N.z.object({id:N.z.string(),title:N.z.string(),description:N.z.string().optional(),questions:N.z.array(b),conditionalLogic:C.optional()}),q=N.z.object({version:N.z.string().default("1.0"),steps:N.z.array(x),conditionalLogic:N.z.array(C).optional(),metadata:N.z.record(N.z.string(),N.z.any()).optional()}),Y=N.z.object({key:N.z.string().min(1).max(200),type:N.z.enum(["hero","text","image","video","markdown","cta","divider"]),contentRef:N.z.string().max(2048).optional(),content:N.z.record(N.z.string(),N.z.any()).optional(),orderIndex:N.z.number().int().nonnegative().optional()}).strict().refine(e=>!e.content||(!("href"in e.content)||"string"!=typeof e.content.href||!!z(e.content.href,!1))&&(!("url"in e.content)||"string"!=typeof e.content.url||!!z(e.content.url,!1))&&(!("backgroundImage"in e.content)||"string"!=typeof e.content.backgroundImage||!e.content.backgroundImage||!!z(e.content.backgroundImage,!1)),{message:"Content URLs must use safe protocols (http:, https:, mailto:, tel:, or relative paths). Dangerous protocols (javascript:, data:, vbscript:, file:) are not allowed."}),L=N.z.object({slug:N.z.string().min(1).max(200).regex(/^[a-z0-9-]+$/,"Slug must be lowercase alphanumeric with hyphens"),title:N.z.string().min(1).max(500),description:N.z.string().max(2e3).optional(),sections:N.z.array(Y).max(100),metadata:N.z.record(N.z.string(),N.z.any()).optional()}).strict(),B=N.z.object({version:N.z.string().max(20).default("1.0"),pages:N.z.array(L).max(50),assets:N.z.array(N.z.object({key:N.z.string().min(1).max(200),type:N.z.enum(["image","video","audio","document"]),url:w.min(1).max(2048),metadata:N.z.record(N.z.string(),N.z.any()).optional()}).strict()).max(200).optional(),metadata:N.z.record(N.z.string(),N.z.any()).optional()}).strict();N.z.object({questionnaire_config:q,content_manifest:B,algorithm_bundle_version:N.z.string(),prompt_version:N.z.string()});var D=e.i(11448),Q=e.i(15874),k=e.i(54799);let j=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;function H(e){return j.test(e.trim())}async function X(e,{params:t}){let n=(0,v.getRequestId)(e);try{let{id:e}=await t;if(!H(e))return(0,v.withRequestId)((0,R.validationErrorResponse)("Invalid funnel version id format"),n);if((0,v.isBlank)(S.env.NEXT_PUBLIC_SUPABASE_URL)||(0,v.isBlank)(S.env.NEXT_PUBLIC_SUPABASE_ANON_KEY))return(0,v.withRequestId)((0,R.configurationErrorResponse)("Supabase is not configured. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY."),n);let r=await (0,T.createServerSupabaseClient)(),{data:{user:a}}=await r.auth.getUser();if(!a)return(0,v.withRequestId)((0,R.unauthorizedResponse)(),n);let i=a.app_metadata?.role||a.user_metadata?.role;if("clinician"!==i&&"admin"!==i)return(0,v.withRequestId)((0,R.forbiddenResponse)(),n);let{data:o,error:s}=await r.from("funnel_versions").select("id, funnel_id, version, content_manifest").eq("id",e).single();if(s){let t=(0,v.sanitizeSupabaseError)(s);if("PGRST116"===t.code)return(0,v.withRequestId)((0,R.notFoundResponse)("Funnel version"),n);let r=(0,v.classifySupabaseError)(t);if((0,v.logError)({requestId:n,operation:"fetch_funnel_version_manifest",error:t,versionId:e}),"SCHEMA_NOT_READY"===r.kind)return(0,v.withRequestId)((0,R.schemaNotReadyResponse)(),n);return(0,v.withRequestId)((0,R.databaseErrorResponse)("Failed to fetch funnel version"),n)}if(!o)return(0,v.withRequestId)((0,R.notFoundResponse)("Funnel version"),n);try{let e=B.parse(o.content_manifest);return(0,v.withRequestId)((0,R.successResponse)({versionId:o.id,funnelId:o.funnel_id,version:o.version,manifest:e}),n)}catch(t){if(t instanceof Q.ZodError)return(0,v.logError)({requestId:n,operation:"validate_manifest_get",error:t,versionId:e}),(0,v.withRequestId)((0,R.errorResponse)(D.ErrorCode.VALIDATION_FAILED,"Invalid manifest structure",422,{issues:t.issues}),n);throw t}}catch(e){return(0,v.logError)({requestId:n,operation:"get_funnel_version_manifest",error:e}),(0,v.withRequestId)((0,R.internalErrorResponse)(),n)}}async function M(e,{params:t}){let n=(0,v.getRequestId)(e);try{var r;let a,i,o,{id:s}=await t;if(!H(s))return(0,v.withRequestId)((0,R.validationErrorResponse)("Invalid funnel version id format"),n);if((0,v.isBlank)(S.env.NEXT_PUBLIC_SUPABASE_URL)||(0,v.isBlank)(S.env.NEXT_PUBLIC_SUPABASE_ANON_KEY))return(0,v.withRequestId)((0,R.configurationErrorResponse)("Supabase is not configured. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY."),n);let l=await (0,T.createServerSupabaseClient)(),{data:{user:u}}=await l.auth.getUser();if(!u)return(0,v.withRequestId)((0,R.unauthorizedResponse)(),n);let d=u.app_metadata?.role||u.user_metadata?.role;if("clinician"!==d&&"admin"!==d)return(0,v.withRequestId)((0,R.forbiddenResponse)(),n);let c=e.headers.get("content-length");if(c&&parseInt(c,10)>0xa00000)return(0,v.withRequestId)(g.NextResponse.json({success:!1,error:{code:"PAYLOAD_TOO_LARGE",message:"Request body exceeds maximum size of 10 MB"}},{status:413}),n);try{a=await e.json()}catch{return(0,v.withRequestId)((0,R.validationErrorResponse)("Invalid JSON in request body"),n)}if(!a||"object"!=typeof a||!("manifest"in a))return(0,v.withRequestId)((0,R.validationErrorResponse)('Request body must contain "manifest" field'),n);try{i=B.parse(a.manifest)}catch(e){if(e instanceof Q.ZodError)return(0,v.logError)({requestId:n,operation:"validate_manifest_put",error:e,versionId:s}),(0,v.withRequestId)((0,R.errorResponse)(D.ErrorCode.VALIDATION_FAILED,"Invalid manifest structure",422,{issues:e.issues}),n);throw e}let p=(0,I.createAdminSupabaseClient)(),{data:E,error:f}=await p.from("funnel_versions").update({content_manifest:i,updated_at:new Date().toISOString()}).eq("id",s).select("id, funnel_id, version, content_manifest").single();if(f||!E){let e=(0,v.sanitizeSupabaseError)(f);if("PGRST116"===e.code)return(0,v.withRequestId)((0,R.notFoundResponse)("Funnel version"),n);let t=(0,v.classifySupabaseError)(e);if((0,v.logError)({requestId:n,operation:"update_funnel_version_manifest",error:e,versionId:s}),"SCHEMA_NOT_READY"===t.kind)return(0,v.withRequestId)((0,R.schemaNotReadyResponse)(),n);return(0,v.withRequestId)((0,R.databaseErrorResponse)("Failed to update manifest"),n)}let m=(r=i,o=JSON.stringify(r,Object.keys(r).sort()),(0,k.createHash)("sha256").update(o).digest("hex").substring(0,16)),{error:_}=await p.from("audit_log").insert({entity_type:A.AUDIT_ENTITY_TYPE.FUNNEL_VERSION,entity_id:s,action:A.AUDIT_ACTION.UPDATE,actor_id:u.id,source:A.AUDIT_SOURCE.ADMIN_UI,metadata:{field:"content_manifest",manifest_hash:m,page_count:i.pages.length,section_count:i.pages.reduce((e,t)=>e+t.sections.length,0)}});return _&&(0,v.logError)({requestId:n,operation:"audit_manifest_update",error:_,versionId:s}),(0,v.withRequestId)((0,R.successResponse)({versionId:E.id,funnelId:E.funnel_id,version:E.version,manifest:E.content_manifest}),n)}catch(e){return(0,v.logError)({requestId:n,operation:"put_funnel_version_manifest",error:e}),(0,v.withRequestId)((0,R.internalErrorResponse)(),n)}}e.s(["GET",()=>X,"PUT",()=>M],82581),e.s([],72855),e.i(72855),e.i(82581),e.s(["GET",()=>X,"PUT",()=>M],31888);var F=e.i(31888);let K=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/funnel-versions/[id]/manifest/route",pathname:"/api/admin/funnel-versions/[id]/manifest",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/rhythm-studio-ui/app/api/admin/funnel-versions/[id]/manifest/route.ts",nextConfigOutput:"",userland:F}),{workAsyncStorage:$,workUnitAsyncStorage:G,serverHooks:V}=K;function W(){return(0,r.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:G})}async function Z(e,t,r){K.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/admin/funnel-versions/[id]/manifest/route";g=g.replace(/\/index$/,"")||"/";let R=await K.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:T,params:I,nextConfig:v,parsedUrl:S,isDraftMode:N,prerenderManifest:A,routerServerContext:U,isOnDemandRevalidate:z,revalidateOnlyGenerated:O,resolvedPathname:w,clientReferenceManifest:P,serverActionsManifest:y}=R,b=(0,s.normalizeAppPath)(g),C=!!(A.dynamicRoutes[b]||A.routes[w]),x=async()=>((null==U?void 0:U.render404)?await U.render404(e,t,S,!1):t.end("This page could not be found"),null);if(C&&!N){let e=!!A.routes[w],t=A.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await x();throw new _.NoFallbackError}}let q=null;!C||K.isDev||N||(q="/index"===(q=w)?"/":q);let Y=!0===K.isDev||!C,L=C&&!Y;y&&P&&(0,o.setManifestsSingleton)({page:g,clientReferenceManifest:P,serverActionsManifest:y});let B=e.method||"GET",D=(0,i.getTracer)(),Q=D.getActiveScopeSpan(),k={params:I,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:Y,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,a)=>K.onRequestError(e,t,r,a,U)},sharedContext:{buildId:T}},j=new l.NodeNextRequest(e),H=new l.NodeNextResponse(t),X=u.NextRequestAdapter.fromNodeNextRequest(j,(0,u.signalFromNodeResponse)(t));try{let o=async e=>K.handle(X,k).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=D.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${B} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${g}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let u=async({previousCacheEntry:n})=>{try{if(!s&&z&&O&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=k.renderOpts.fetchMetrics;let l=k.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=k.renderOpts.collectedTags;if(!C)return await (0,p.sendResponse)(j,H,i,k.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==k.renderOpts.collectedRevalidate&&!(k.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&k.renderOpts.collectedRevalidate,r=void 0===k.renderOpts.collectedExpire||k.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:k.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await K.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:z})},!1,U),t}},d=await K.handleResponse({req:e,nextConfig:v,cacheKey:q,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:z,revalidateOnlyGenerated:O,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!C)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",z?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,E.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&C||_.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(j,H,new Response(d.value.body,{headers:_,status:d.value.status||200})),null};Q?await l(Q):await D.withPropagatedContext(e.headers,()=>D.trace(d.BaseServerSpan.handleRequest,{spanName:`${B} ${g}`,kind:i.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await K.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:z})},!1,U),C)throw t;return await (0,p.sendResponse)(j,H,new Response(null,{status:500})),null}}e.s(["handler",()=>Z,"patchFetch",()=>W,"routeModule",()=>K,"serverHooks",()=>V,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>G],51557)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e6a023ee.js.map