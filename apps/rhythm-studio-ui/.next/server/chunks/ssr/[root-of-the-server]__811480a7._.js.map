{"version":3,"sources":["../../../../../../lib/logging/logger.ts","../../../../../../apps/rhythm-studio-ui/app/global-error.tsx"],"sourcesContent":["/**\n * B8: Structured Logging Utility\n * \n * Provides consistent, structured logging across the application.\n * Supports multiple log levels and JSON formatting for better monitoring.\n * \n * TODO: Integrate with production error tracking service (Sentry recommended)\n * See: docs/MONITORING_INTEGRATION.md for integration guide\n */\n\nexport enum LogLevel {\n  INFO = 'info',\n  WARN = 'warn',\n  ERROR = 'error',\n}\n\nexport type LogContext = {\n  userId?: string\n  assessmentId?: string\n  stepId?: string\n  questionId?: string\n  endpoint?: string\n  requestId?: string // E6.2.8: Add correlation ID support\n  [key: string]: unknown\n}\n\ntype LogEntry = {\n  timestamp: string\n  level: LogLevel\n  message: string\n  context?: LogContext\n  error?: {\n    message: string\n    stack?: string\n    name?: string\n    digest?: string\n    cause?: string\n    [key: string]: unknown\n  }\n}\n\nconst SENSITIVE_ERROR_KEYS = new Set([\n  'authorization',\n  'cookie',\n  'set-cookie',\n  'token',\n  'accessToken',\n  'refreshToken',\n  'password',\n  'secret',\n  'body',\n  'request',\n  'headers',\n])\n\nfunction safeStringifyCause(cause: unknown): string | undefined {\n  if (cause === undefined || cause === null) return undefined\n  if (cause instanceof Error) return cause.message\n  if (typeof cause === 'string') return cause\n  try {\n    return JSON.stringify(cause, (key, value) => {\n      if (SENSITIVE_ERROR_KEYS.has(key)) return '[REDACTED]'\n      return value\n    })\n  } catch {\n    return undefined\n  }\n}\n\n/**\n * Core logging function with structured output\n * \n * TODO: Integrate with Sentry for production error tracking\n * See: docs/MONITORING_INTEGRATION.md\n */\nfunction log(level: LogLevel, message: string, context?: LogContext, error?: unknown): void {\n  const entry: LogEntry = {\n    timestamp: new Date().toISOString(),\n    level,\n    message,\n  }\n\n  if (context) {\n    entry.context = context\n  }\n\n  if (error) {\n    const normalizedError =\n      error instanceof Error\n        ? {\n            message: error.message,\n            stack: error.stack,\n            name: error.name,\n            digest: typeof (error as { digest?: unknown }).digest === 'string'\n              ? (error as { digest?: string }).digest\n              : undefined,\n            cause: safeStringifyCause((error as { cause?: unknown }).cause),\n          }\n        : {\n            message: typeof error === 'string' ? error : JSON.stringify(error),\n          }\n\n    entry.error = normalizedError\n  }\n\n  // Output as JSON for structured logging\n  const logOutput = JSON.stringify(entry)\n\n  // Route to appropriate console method\n  switch (level) {\n    case LogLevel.ERROR:\n      console.error(logOutput)\n      break\n    case LogLevel.WARN:\n      console.warn(logOutput)\n      break\n    case LogLevel.INFO:\n    default:\n      console.log(logOutput)\n      break\n  }\n}\n\n/**\n * Log info-level message\n */\nexport function logInfo(message: string, context?: LogContext): void {\n  log(LogLevel.INFO, message, context)\n}\n\n/**\n * Log warning-level message\n */\nexport function logWarn(message: string, context?: LogContext): void {\n  log(LogLevel.WARN, message, context)\n}\n\n/**\n * Log error-level message\n */\nexport function logError(message: string, context?: LogContext, error?: unknown): void {\n  log(LogLevel.ERROR, message, context, error)\n}\n\n/**\n * Specialized logging functions for common scenarios\n */\n\nexport function logUnauthorized(context: LogContext): void {\n  logWarn('Unauthorized access attempt', {\n    ...context,\n    type: 'unauthorized',\n  })\n}\n\nexport function logForbidden(context: LogContext, reason: string): void {\n  logWarn(`Forbidden access attempt: ${reason}`, {\n    ...context,\n    type: 'forbidden',\n    reason,\n  })\n}\n\nexport function logStepSkipping(context: LogContext, attemptedStepId: string): void {\n  logWarn('Step-skipping attempt detected', {\n    ...context,\n    type: 'step_skipping',\n    attemptedStepId,\n  })\n}\n\nexport function logValidationFailure(\n  context: LogContext,\n  missingQuestions: Array<{ questionKey: string }>,\n): void {\n  logInfo('Validation failed', {\n    ...context,\n    type: 'validation_failure',\n    missingCount: missingQuestions.length,\n    missingQuestions: missingQuestions.map((q) => q.questionKey),\n  })\n}\n\nexport function logDatabaseError(context: LogContext, error: unknown): void {\n  logError('Database error', context, error)\n}\n\n/**\n * Log expected \"not found\" scenarios (PGRST116 etc.) - warn level, not error\n */\nexport function logNotFound(resource: string, context: LogContext): void {\n  logWarn(`${resource} not found`, {\n    ...context,\n    type: 'not_found',\n    resource,\n  })\n}\n\nexport function logApiRequest(endpoint: string, method: string, context?: LogContext): void {\n  logInfo(`API Request: ${method} ${endpoint}`, {\n    ...context,\n    endpoint,\n    method,\n    type: 'api_request',\n  })\n}\n\n/**\n * Log assessment lifecycle events\n */\n\nexport function logAssessmentStarted(context: LogContext): void {\n  logInfo('Assessment started', {\n    ...context,\n    type: 'assessment_started',\n  })\n}\n\nexport function logAssessmentCompleted(context: LogContext): void {\n  logInfo('Assessment completed', {\n    ...context,\n    type: 'assessment_completed',\n  })\n}\n\n/**\n * V061-I02: Log access to incomplete assessment result\n */\nexport function logIncompleteAssessmentAccess(context: LogContext, status: string): void {\n  logWarn('Access to incomplete assessment result', {\n    ...context,\n    type: 'incomplete_assessment_access',\n    status,\n  })\n}\n\nexport function logAssessmentError(context: LogContext, error: unknown): void {\n  logError('Assessment error', context, error)\n}\n\n/**\n * Log major flow errors for monitoring\n */\n\nexport function logClinicianFlowError(context: LogContext, error: unknown): void {\n  logError('Clinician flow error', { ...context, area: 'clinician' }, error)\n}\n\nexport function logPatientFlowError(context: LogContext, error: unknown): void {\n  logError('Patient flow error', { ...context, area: 'patient' }, error)\n}\n","'use client'\n\nimport { ErrorState } from '@/lib/ui'\nimport { useEffect } from 'react'\nimport { logError } from '@/lib/logging/logger'\n\n/**\n * Global error boundary\n * \n * This component is displayed when an error occurs at the root level.\n * Part of V0.4-E6 Technical Cleanup & Stability Layer.\n */\nexport default function GlobalError({\n  error,\n  reset,\n}: {\n  error: Error & { digest?: string }\n  reset: () => void\n}) {\n  useEffect(() => {\n    // Log the error\n    logError('Global application error', { type: 'ui_error', area: 'global' }, error)\n  }, [error])\n\n  const message = error?.message?.startsWith('Missing env:')\n    ? error.message\n    : 'Beim Laden der Anwendung ist ein Fehler aufgetreten. Bitte laden Sie die Seite neu.'\n\n  return (\n    <html lang=\"de\">\n      <body>\n        <div className=\"w-full min-h-screen flex items-center justify-center bg-white px-4\">\n          <ErrorState\n            title=\"Ein Fehler ist aufgetreten\"\n            message={message}\n            onRetry={reset}\n            centered\n          />\n        </div>\n      </body>\n    </html>\n  )\n}\n"],"names":[],"mappings":"qkCAyCA,IAAM,EAAuB,IAAI,IAAI,CACnC,gBACA,SACA,aACA,QACA,cACA,eACA,WACA,SACA,OACA,UACA,UACD,EAuFM,SAAS,EAAS,CAAe,CAAE,CAAoB,CAAE,CAAe,MAjElE,EAkEX,GAlE0B,EAAE,GAC5B,IAD2C,AACrC,EADuC,AACrB,CACtB,MAF+D,EAAE,EAEtD,GAFqE,CAEjE,OAAO,WAAW,SACjC,EACA,QA8DkB,CA7DpB,CAEI,IACF,GAAM,EADK,KACE,CA0Dc,CA1DX,CAAA,CA0DoB,IAvCpC,EAAM,KAAK,CAdT,EAcY,WAdK,MACb,CACE,QAAS,EAAM,OAAO,CACtB,MAAO,EAAM,KAAK,CAClB,KAAM,EAAM,IAAI,CAChB,OAA0D,UAAlD,OAAQ,EAA+B,MAAM,CAChD,EAA8B,MAAM,MACrC,EACJ,MAAO,AAzCnB,SAAS,AAAmB,CAAc,EACxC,SAAI,GACJ,GAAI,IADU,SACO,IADM,EACC,OAAO,CADE,CACI,KADE,EACK,CAChD,GAAqB,CAF6B,SAE9C,OAAO,EAAoB,OAAO,EACtC,GAAI,CACF,OAAO,KAAK,SAAS,CAAC,EAAO,CAAC,EAAK,IACjC,AAAI,EAAqB,GAAG,CAAC,GAAa,GAAP,UAC5B,EAEX,CAAE,KAAM,CACN,MACF,CADS,CAEX,EA6BuC,EAA8B,KAAK,CAChE,EACA,CACE,QAA0B,UAAjB,CAA4B,MAArB,IAA6B,KAAK,SAAS,CAAC,EAC9D,CAEQ,EAIhB,IAAM,EAAY,KAAK,SAAS,CAAC,GAGjC,OAAQ,GACN,IAAA,QACE,QAAQ,KAAK,CAAC,GACd,KACF,KAAA,OACE,QAAQ,IAAI,CAAC,EAMjB,CAsBF,kEC5IA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAQe,SAAS,EAAY,OAClC,CAAK,OACL,CAAK,CAIN,EACC,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KAER,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,2BAA4B,CAAE,KAAM,WAAY,KAAM,QAAS,EAAG,EAC7E,EAAG,CAAC,EAAM,EAEV,IAAM,EAAU,GAAO,SAAS,WAAW,gBACvC,EAAM,OAAO,CACb,sFAEJ,MACE,CAAA,EAAA,EAAA,GAAA,EAAC,OAAA,CAAK,KAAK,cACT,CAAA,EAAA,EAAA,GAAA,EAAC,OAAA,UACC,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,8EACb,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,UAAU,CAAA,CACT,MAAM,6BACN,QAAS,EACT,QAAS,EACT,QAAQ,CAAA,CAAA,SAMpB"}