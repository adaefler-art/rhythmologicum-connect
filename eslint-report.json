[{"filePath":"C:\\dev\\rhythmologicum-connect\\app\\api\\admin\\funnels\\[id]\\__tests__\\route.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\dev\\rhythmologicum-connect\\app\\api\\admin\\funnels\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\dev\\rhythmologicum-connect\\app\\clinician\\funnels\\[id]\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'asEnvelope'. Either include it or remove the dependency array.","line":138,"column":6,"nodeType":"ArrayExpression","endLine":138,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [asEnvelope, funnelId]","fix":{"range":[4166,4176],"text":"[asEnvelope, funnelId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useEffect, useState, useCallback } from 'react'\r\nimport { useParams } from 'next/navigation'\r\nimport Link from 'next/link'\r\nimport { Input, Textarea, LoadingSpinner, ErrorState } from '@/lib/ui'\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\ntype Question = {\r\n  id: string\r\n  key: string\r\n  label: string\r\n  help_text: string | null\r\n  question_type: string\r\n  funnel_step_question_id: string\r\n  is_required: boolean\r\n  order_index: number\r\n}\r\n\r\ntype Step = {\r\n  id: string\r\n  funnel_id: string\r\n  order_index: number\r\n  title: string\r\n  description: string | null\r\n  type: string\r\n  content_page_id: string | null\r\n  content_page?: {\r\n    id: string\r\n    slug: string\r\n    title: string\r\n    excerpt: string | null\r\n    status: string\r\n  } | null\r\n  questions: Question[]\r\n}\r\n\r\ntype Funnel = {\r\n  id: string\r\n  slug: string\r\n  title: string\r\n  description: string | null\r\n  is_active: boolean\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\n// Translation helpers\r\nconst translateQuestionType = (type: string): string => {\r\n  const translations: Record<string, string> = {\r\n    slider: 'Schieberegler',\r\n    text: 'Text',\r\n    select: 'Auswahl',\r\n    textarea: 'Textfeld',\r\n    radio: 'Optionsfeld',\r\n    checkbox: 'Kontrollkästchen',\r\n  }\r\n  return translations[type] || type\r\n}\r\n\r\nconst translateStepType = (type: string): string => {\r\n  const translations: Record<string, string> = {\r\n    question_step: 'Fragen',\r\n    form: 'Formular',\r\n    info_step: 'Informationsschritt',\r\n    info: 'Info',\r\n    content_page: 'Inhaltsseite',\r\n    summary: 'Zusammenfassung',\r\n  }\r\n  return translations[type] || type\r\n}\r\n\r\nexport default function FunnelDetailPage() {\r\n  const params = useParams()\r\n  const funnelId = params.id as string\r\n\r\n  const [funnel, setFunnel] = useState<Funnel | null>(null)\r\n  const [steps, setSteps] = useState<Step[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [saving, setSaving] = useState(false)\r\n\r\n  // Edit mode state\r\n  const [editingFunnel, setEditingFunnel] = useState(false)\r\n  const [editedFunnel, setEditedFunnel] = useState<Partial<Funnel>>({})\r\n  const [editingStep, setEditingStep] = useState<string | null>(null)\r\n  const [editedStep, setEditedStep] = useState<Partial<Step>>({})\r\n\r\n  type Envelope<T> = {\r\n    success?: boolean\r\n    data?: T\r\n    error?: { message?: string; requestId?: string; details?: { requestId?: string } }\r\n  }\r\n\r\n  function asEnvelope<T>(value: unknown): Envelope<T> | null {\r\n    return value && typeof value === 'object' ? (value as Envelope<T>) : null\r\n  }\r\n\r\n  const loadFunnelDetails = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n\r\n      const response = await fetch(`/api/admin/funnels/${funnelId}`)\r\n\r\n      if (!response.ok) {\r\n        let requestId = response.headers.get('x-request-id')\r\n        let message = 'Failed to load funnel details'\r\n\r\n        try {\r\n          const json: unknown = await response.json()\r\n          const envelope = asEnvelope<unknown>(json)\r\n          const errorMessage = envelope?.error?.message\r\n          const errorRequestId = envelope?.error?.requestId || envelope?.error?.details?.requestId\r\n          if (typeof errorMessage === 'string' && errorMessage.length > 0) message = errorMessage\r\n          if (typeof errorRequestId === 'string' && errorRequestId.length > 0) requestId = errorRequestId\r\n        } catch {\r\n          // ignore json parse errors\r\n        }\r\n\r\n        throw new Error(requestId ? `${message} (requestId: ${requestId})` : message)\r\n      }\r\n\r\n      const json: unknown = await response.json()\r\n      const envelope = asEnvelope<{ funnel?: Funnel; steps?: Step[] }>(json)\r\n      const funnelData = envelope?.data?.funnel\r\n      const stepsData = envelope?.data?.steps\r\n\r\n      setFunnel(funnelData ?? null)\r\n      setSteps(Array.isArray(stepsData) ? stepsData : [])\r\n    } catch (err) {\r\n      console.error('Error loading funnel details:', err)\r\n      setError(err instanceof Error ? err.message : 'Fehler beim Laden der Funnel-Details')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [funnelId])\r\n\r\n  useEffect(() => {\r\n    loadFunnelDetails()\r\n  }, [loadFunnelDetails])\r\n\r\n  const toggleFunnelActive = async () => {\r\n    if (!funnel) return\r\n\r\n    try {\r\n      setSaving(true)\r\n      const response = await fetch(`/api/admin/funnels/${funnelId}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ is_active: !funnel.is_active }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        let requestId = response.headers.get('x-request-id')\r\n        let message = 'Failed to update funnel'\r\n\r\n        try {\r\n          const json: unknown = await response.json()\r\n          const envelope = asEnvelope<unknown>(json)\r\n          const errorMessage = envelope?.error?.message\r\n          const errorRequestId = envelope?.error?.requestId || envelope?.error?.details?.requestId\r\n          if (typeof errorMessage === 'string' && errorMessage.length > 0) message = errorMessage\r\n          if (typeof errorRequestId === 'string' && errorRequestId.length > 0) requestId = errorRequestId\r\n        } catch {\r\n          // ignore\r\n        }\r\n\r\n        throw new Error(requestId ? `${message} (requestId: ${requestId})` : message)\r\n      }\r\n\r\n      const json: unknown = await response.json()\r\n      const envelope = asEnvelope<{ funnel?: Funnel }>(json)\r\n      setFunnel(envelope?.data?.funnel ?? null)\r\n    } catch (err) {\r\n      console.error('Error updating funnel:', err)\r\n      alert(`Fehler beim Aktualisieren des Funnels: ${err instanceof Error ? err.message : 'Unbekannter Fehler'}`)\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const startEditingFunnel = () => {\r\n    setEditingFunnel(true)\r\n    setEditedFunnel({\r\n      title: funnel?.title || '',\r\n      description: funnel?.description || '',\r\n    })\r\n  }\r\n\r\n  const cancelEditingFunnel = () => {\r\n    setEditingFunnel(false)\r\n    setEditedFunnel({})\r\n  }\r\n\r\n  const saveFunnelEdit = async () => {\r\n    if (!funnel) return\r\n\r\n    // Client-side validation\r\n    const title = editedFunnel.title?.trim() || ''\r\n    if (title.length === 0) {\r\n      alert('Titel darf nicht leer sein')\r\n      return\r\n    }\r\n    if (title.length > 255) {\r\n      alert('Titel ist zu lang (maximal 255 Zeichen)')\r\n      return\r\n    }\r\n\r\n    const description = editedFunnel.description?.trim() || ''\r\n    if (description.length > 2000) {\r\n      alert('Beschreibung ist zu lang (maximal 2000 Zeichen)')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setSaving(true)\r\n      const response = await fetch(`/api/admin/funnels/${funnelId}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          title,\r\n          description,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        let requestId = response.headers.get('x-request-id')\r\n        let message = 'Failed to update funnel'\r\n\r\n        try {\r\n          const json: unknown = await response.json()\r\n          const envelope = asEnvelope<unknown>(json)\r\n          const errorMessage = envelope?.error?.message\r\n          const errorRequestId = envelope?.error?.requestId || envelope?.error?.details?.requestId\r\n          if (typeof errorMessage === 'string' && errorMessage.length > 0) message = errorMessage\r\n          if (typeof errorRequestId === 'string' && errorRequestId.length > 0) requestId = errorRequestId\r\n        } catch {\r\n          // ignore\r\n        }\r\n\r\n        throw new Error(requestId ? `${message} (requestId: ${requestId})` : message)\r\n      }\r\n\r\n      const json: unknown = await response.json()\r\n      const envelope = asEnvelope<{ funnel?: Funnel }>(json)\r\n      setFunnel(envelope?.data?.funnel ?? null)\r\n      setEditingFunnel(false)\r\n      setEditedFunnel({})\r\n    } catch (err) {\r\n      console.error('Error updating funnel:', err)\r\n      alert(`Fehler beim Speichern: ${err instanceof Error ? err.message : 'Unbekannter Fehler'}`)\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const startEditingStep = (step: Step) => {\r\n    setEditingStep(step.id)\r\n    setEditedStep({\r\n      title: step.title,\r\n      description: step.description,\r\n    })\r\n  }\r\n\r\n  const cancelEditingStep = () => {\r\n    setEditingStep(null)\r\n    setEditedStep({})\r\n  }\r\n\r\n  const saveStepEdit = async (stepId: string) => {\r\n    // Client-side validation\r\n    const title = editedStep.title?.trim() || ''\r\n    if (title.length === 0) {\r\n      alert('Schritt-Titel darf nicht leer sein')\r\n      return\r\n    }\r\n    if (title.length > 255) {\r\n      alert('Schritt-Titel ist zu lang (maximal 255 Zeichen)')\r\n      return\r\n    }\r\n\r\n    const description = editedStep.description?.trim() || ''\r\n    if (description.length > 2000) {\r\n      alert('Schritt-Beschreibung ist zu lang (maximal 2000 Zeichen)')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setSaving(true)\r\n      const response = await fetch(`/api/admin/funnel-steps/${stepId}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          title,\r\n          description,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json()\r\n        throw new Error(errorData.error || 'Failed to update step')\r\n      }\r\n\r\n      await loadFunnelDetails()\r\n      setEditingStep(null)\r\n      setEditedStep({})\r\n    } catch (err) {\r\n      console.error('Error updating step:', err)\r\n      alert(`Fehler beim Speichern: ${err instanceof Error ? err.message : 'Unbekannter Fehler'}`)\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const toggleQuestionRequired = async (questionId: string, currentRequired: boolean) => {\r\n    try {\r\n      setSaving(true)\r\n      const response = await fetch(`/api/admin/funnel-step-questions/${questionId}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ is_required: !currentRequired }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to update question')\r\n      }\r\n\r\n      // Reload data\r\n      await loadFunnelDetails()\r\n    } catch (err) {\r\n      console.error('Error updating question:', err)\r\n      alert('Fehler beim Aktualisieren der Frage')\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const moveStep = async (stepId: string, currentIndex: number, direction: 'up' | 'down') => {\r\n    const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1\r\n\r\n    // Check bounds\r\n    if (newIndex < 0 || newIndex >= steps.length) return\r\n\r\n    try {\r\n      setSaving(true)\r\n\r\n      // Get the other step that we're swapping with\r\n      const otherStep = steps[newIndex]\r\n\r\n      // Update both steps\r\n      await Promise.all([\r\n        fetch(`/api/admin/funnel-steps/${stepId}`, {\r\n          method: 'PATCH',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ order_index: newIndex }),\r\n        }),\r\n        fetch(`/api/admin/funnel-steps/${otherStep.id}`, {\r\n          method: 'PATCH',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ order_index: currentIndex }),\r\n        }),\r\n      ])\r\n\r\n      // Reload data\r\n      await loadFunnelDetails()\r\n    } catch (err) {\r\n      console.error('Error moving step:', err)\r\n      alert('Fehler beim Verschieben des Steps')\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center py-12\">\r\n        <LoadingSpinner size=\"lg\" text=\"Lade Funnel-Details…\" centered />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (error || !funnel) {\r\n    return (\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <ErrorState\r\n          title=\"Fehler beim Laden\"\r\n          message={error || 'Funnel nicht gefunden'}\r\n          centered\r\n        />\r\n        <div className=\"mt-4 text-center\">\r\n          <Link\r\n            href=\"/clinician/funnels\"\r\n            className=\"inline-flex items-center text-sm text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300 font-medium\"\r\n          >\r\n            ← Zurück zur Übersicht\r\n          </Link>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-6xl mx-auto\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <div className=\"mb-4\">\r\n          <Link\r\n            href=\"/clinician/funnels\"\r\n            className=\"inline-flex items-center text-sm text-sky-600 hover:text-sky-700 font-medium\"\r\n          >\r\n            ← Zurück zur Übersicht\r\n          </Link>\r\n        </div>\r\n\r\n        {/* Funnel Header - Editable */}\r\n        <div className=\"bg-white border border-slate-200 rounded-lg p-6 mb-6\">\r\n          <div className=\"flex items-start justify-between gap-4 mb-4\">\r\n            <div className=\"flex-1\">\r\n              {editingFunnel ? (\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label htmlFor=\"funnel-title\" className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                      Titel\r\n                    </label>\r\n                    <Input\r\n                      id=\"funnel-title\"\r\n                      type=\"text\"\r\n                      value={editedFunnel.title || ''}\r\n                      onChange={(e) =>\r\n                        setEditedFunnel({ ...editedFunnel, title: e.target.value })\r\n                      }\r\n                      inputSize=\"md\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label htmlFor=\"funnel-description\" className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                      Beschreibung\r\n                    </label>\r\n                    <Textarea\r\n                      id=\"funnel-description\"\r\n                      value={editedFunnel.description || ''}\r\n                      onChange={(e) =>\r\n                        setEditedFunnel({ ...editedFunnel, description: e.target.value })\r\n                      }\r\n                      rows={3}\r\n                      textareaSize=\"md\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    <button\r\n                      onClick={saveFunnelEdit}\r\n                      disabled={saving}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {saving ? 'Speichert…' : 'Speichern'}\r\n                    </button>\r\n                    <button\r\n                      onClick={cancelEditingFunnel}\r\n                      disabled={saving}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      Abbrechen\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div>\r\n                  <h1 className=\"text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-50 mb-2\">\r\n                    {funnel.title}\r\n                  </h1>\r\n                  {funnel.description && (\r\n                    <p className=\"text-sm text-slate-500 dark:text-slate-400 mb-3\">{funnel.description}</p>\r\n                  )}\r\n                  <div className=\"flex items-center gap-3 text-sm text-slate-400 dark:text-slate-500\">\r\n                    <span>ID: {funnel.slug}</span>\r\n                    <span>•</span>\r\n                    <span>{steps.length} Schritte</span>\r\n                    <span>•</span>\r\n                    <span>\r\n                      {steps.reduce((total, step) => total + step.questions.length, 0)} Fragen\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2\">\r\n              {!editingFunnel && (\r\n                <button\r\n                  onClick={startEditingFunnel}\r\n                  className=\"h-10 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors\"\r\n                >\r\n                  Bearbeiten\r\n                </button>\r\n              )}\r\n              <button\r\n                onClick={toggleFunnelActive}\r\n                disabled={saving}\r\n                className={`h-10 px-4 py-2 text-sm font-medium rounded-md transition-colors ${\r\n                  funnel.is_active\r\n                    ? 'bg-green-100 text-green-800 hover:bg-green-200'\r\n                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'\r\n                } disabled:opacity-50 disabled:cursor-not-allowed`}\r\n              >\r\n                {saving ? 'Speichert…' : funnel.is_active ? 'Aktiv' : 'Inaktiv'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Steps List */}\r\n      <div className=\"space-y-6\">\r\n        <h2 className=\"text-xl font-semibold text-slate-900 dark:text-slate-50\">Schritte</h2>\r\n        {steps.map((step, stepIndex) => (\r\n          <div\r\n            key={step.id}\r\n            className=\"bg-white border border-slate-200 rounded-lg overflow-hidden\"\r\n          >\r\n            {/* Step Header */}\r\n            <div className=\"bg-slate-50 px-6 py-4 border-b border-slate-200\">\r\n              {editingStep === step.id ? (\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label htmlFor={`step-title-${step.id}`} className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                      Schritt-Titel\r\n                    </label>\r\n                    <Input\r\n                      id={`step-title-${step.id}`}\r\n                      type=\"text\"\r\n                      value={editedStep.title || ''}\r\n                      onChange={(e) => setEditedStep({ ...editedStep, title: e.target.value })}\r\n                      inputSize=\"md\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label htmlFor={`step-desc-${step.id}`} className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                      Schritt-Beschreibung\r\n                    </label>\r\n                    <Textarea\r\n                      id={`step-desc-${step.id}`}\r\n                      value={editedStep.description || ''}\r\n                      onChange={(e) =>\r\n                        setEditedStep({ ...editedStep, description: e.target.value })\r\n                      }\r\n                      rows={2}\r\n                      textareaSize=\"md\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    <button\r\n                      onClick={() => saveStepEdit(step.id)}\r\n                      disabled={saving}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      {saving ? 'Speichert…' : 'Speichern'}\r\n                    </button>\r\n                    <button\r\n                      onClick={cancelEditingStep}\r\n                      disabled={saving}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      Abbrechen\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div className=\"flex items-center justify-between gap-4\">\r\n                  <div className=\"flex-1\">\r\n                    <div className=\"flex items-center gap-3 mb-1\">\r\n                      <span className=\"text-xs font-semibold text-slate-500 uppercase\">\r\n                        Schritt {step.order_index + 1}\r\n                      </span>\r\n                      <span className=\"text-xs text-slate-400\">\r\n                        (Typ: {translateStepType(step.type)})\r\n                      </span>\r\n                    </div>\r\n                    <h3 className=\"text-lg font-semibold text-slate-900\">{step.title}</h3>\r\n                    {step.description && (\r\n                      <p className=\"text-sm text-slate-600 mt-1\">{step.description}</p>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <button\r\n                      onClick={() => startEditingStep(step)}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded transition-colors\"\r\n                    >\r\n                      Bearbeiten\r\n                    </button>\r\n                    <button\r\n                      onClick={() => moveStep(step.id, stepIndex, 'up')}\r\n                      disabled={stepIndex === 0 || saving}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded disabled:opacity-30 disabled:cursor-not-allowed transition-colors\"\r\n                      title=\"Nach oben\"\r\n                    >\r\n                      ↑\r\n                    </button>\r\n                    <button\r\n                      onClick={() => moveStep(step.id, stepIndex, 'down')}\r\n                      disabled={stepIndex === steps.length - 1 || saving}\r\n                      className=\"h-10 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded disabled:opacity-30 disabled:cursor-not-allowed transition-colors\"\r\n                      title=\"Nach unten\"\r\n                    >\r\n                      ↓\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Content Page Info (for content_page steps) */}\r\n            {step.type === 'content_page' && (\r\n              <div className=\"px-6 py-4 bg-blue-50 border-b border-blue-200\">\r\n                <div className=\"flex items-start justify-between gap-4\">\r\n                  <div className=\"flex-1\">\r\n                    <h4 className=\"text-sm font-semibold text-blue-900 mb-2\">Zugeordnete Inhaltsseite</h4>\r\n                    {step.content_page ? (\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-blue-900\">{step.content_page.title}</p>\r\n                        <p className=\"text-xs text-blue-700 mt-1\">Slug: {step.content_page.slug}</p>\r\n                        {step.content_page.excerpt && (\r\n                          <p className=\"text-xs text-blue-600 mt-1\">{step.content_page.excerpt}</p>\r\n                        )}\r\n                        <span className={`inline-block mt-2 px-2 py-1 text-xs rounded ${\r\n                          step.content_page.status === 'published'\r\n                            ? 'bg-green-100 text-green-800'\r\n                            : 'bg-yellow-100 text-yellow-800'\r\n                        }`}>\r\n                          {step.content_page.status === 'published' ? 'Veröffentlicht' : 'Entwurf'}\r\n                        </span>\r\n                      </div>\r\n                    ) : (\r\n                      <p className=\"text-sm text-red-700\">⚠️ Keine Inhaltsseite zugeordnet</p>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Questions */}\r\n            {step.questions.length > 0 && (\r\n              <div className=\"divide-y divide-slate-200\">\r\n                <div className=\"px-6 py-3 bg-slate-50 border-b border-slate-200\">\r\n                  <h4 className=\"text-sm font-semibold text-slate-700\">Fragen</h4>\r\n                </div>\r\n                {step.questions.map((question) => (\r\n                  <div key={question.id} className=\"px-6 py-4\">\r\n                    <div className=\"flex items-start justify-between gap-4\">\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center gap-2 mb-1\">\r\n                          <span className=\"text-xs font-semibold text-slate-500\">\r\n                            Frageschlüssel:\r\n                          </span>\r\n                          <span className=\"text-xs font-mono text-slate-500\">\r\n                            {question.key}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2 mb-1\">\r\n                          <span className=\"text-xs font-semibold text-slate-500\">Typ:</span>\r\n                          <span className=\"text-xs text-slate-500\">\r\n                            {translateQuestionType(question.question_type)}\r\n                          </span>\r\n                        </div>\r\n                        <p className=\"text-sm font-medium text-slate-900 mb-1\">\r\n                          {question.label}\r\n                        </p>\r\n                        {question.help_text && (\r\n                          <p className=\"text-xs text-slate-600\">{question.help_text}</p>\r\n                        )}\r\n                      </div>\r\n\r\n                      <button\r\n                        onClick={() =>\r\n                          toggleQuestionRequired(\r\n                            question.funnel_step_question_id,\r\n                            question.is_required\r\n                          )\r\n                        }\r\n                        disabled={saving}\r\n                        className={`px-3 py-1.5 text-xs font-medium rounded transition-colors ${\r\n                          question.is_required\r\n                            ? 'bg-orange-100 text-orange-800 hover:bg-orange-200'\r\n                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'\r\n                        } disabled:opacity-50 disabled:cursor-not-allowed`}\r\n                      >\r\n                        {question.is_required ? 'Pflichtfeld' : 'Optional'}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {step.questions.length === 0 && (\r\n              <div className=\"px-6 py-4 text-center text-sm text-slate-500\">\r\n                Keine Fragen in diesem Schritt\r\n              </div>\r\n            )}\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      {steps.length === 0 && (\r\n        <div className=\"bg-white border border-slate-200 rounded-lg p-8 text-center\">\r\n          <p className=\"text-slate-600\">Keine Schritte definiert.</p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\dev\\rhythmologicum-connect\\app\\clinician\\funnels\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]