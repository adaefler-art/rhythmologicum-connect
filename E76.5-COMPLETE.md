# E76.5 ‚Äî Prompt v1 (Diagnosis JSON Spec) + Output Schema Contract ‚Äî COMPLETE

## Summary

Successfully implemented E76.5: Diagnosis Prompt v1 with complete JSON schema specification, prompt bundle definition, minimal API wiring with feature flag, and comprehensive guardrails enforcement.

## What Was Delivered

### 1. Diagnosis Prompt Output Schema v1 (`lib/contracts/diagnosis-prompt.ts`)

**Schema Definition:**
- `DiagnosisPromptOutputV1Schema`: Complete Zod schema for LLM output validation
- Required fields:
  - `summary`: Brief analysis summary (10-1000 chars)
  - `patient_context_used`: Metadata about analyzed data
    - `assessments_count`, `date_range`, `data_sources`, `completeness_score`
  - `differential_diagnoses`: 1-5 diagnoses with rationale and confidence
    - `condition`, `rationale`, `confidence`, `supporting_factors`, `contradicting_factors`
  - `recommended_next_steps`: 1-10 prioritized actions
    - `step`, `rationale`, `priority`, `timeframe`
  - `urgent_red_flags`: Array of urgent findings
    - `flag`, `urgency`, `rationale`, `recommended_action`
  - `disclaimer`: Required legal disclaimer (50-500 chars)
  - `schema_version`: Version identifier ('v1')

**Type Safety:**
- `ConfidenceLevel`: very_low, low, moderate, high, very_high
- `UrgencyLevel`: routine, prompt, urgent, emergent
- `Priority`: low, medium, high, critical

**Validation Helpers:**
- `validateDiagnosisPromptOutputV1()`: Safe parse with typed result
- `hasValidDisclaimer()`: Verify disclaimer content
- `hasEmergentRedFlags()`: Check for emergent urgency
- `getHighestPriorityRecommendation()`: Get top priority step
- `getMostConfidentDifferential()`: Get highest confidence diagnosis

**Version Constants:**
- `DIAGNOSIS_PROMPT_BUNDLE_VERSION = 'v1.0.0'`
- `DIAGNOSIS_PROMPT_VERSION = 'v1.0.0'`
- `DIAGNOSIS_SCHEMA_VERSION = 'v1'`

### 2. Diagnosis Prompt in Registry (`lib/prompts/registry.ts`)

**Registry Entry:** `'diagnosis-v1.0.0'`

**Metadata:**
- `promptId`: 'diagnosis'
- `version`: 'v1.0.0'
- `description`: 'Generate comprehensive diagnosis analysis from patient context pack'
- `sectionKey`: 'diagnosis'
- `modelConfig`:
  - Provider: anthropic
  - Model: claude-sonnet-4-5-20250929
  - Temperature: 0.2
  - Max tokens: 8192
- `createdAt`: '2026-02-04T12:00:00.000Z'
- `immutable`: true

**System Prompt Guardrails:**
Critical constraints explicitly stated:
1. "NOT providing medical advice - output is for clinician review ONLY"
2. "You are NOT making final diagnoses"
3. "You do NOT prescribe treatments"
4. "You do NOT replace clinical judgment"
5. "All output is explicitly marked as 'not medical advice'"

**System Prompt Content:**
- Role definition: Clinical decision support AI
- Analysis approach: Evidence-based reasoning
- Output requirements: Structured JSON with disclaimer
- Disclaimer requirements: Must include "NOT medical advice" and "clinician review" language
- Example output structure provided

**User Prompt Template:**
- Placeholder: `{{contextPack}}`
- Instructions for analysis steps
- Safety-focused recommendations
- Schema compliance requirement

**Guardrails:**
- `noPHI`: true
- `noFantasyClaims`: true
- `onlyInternalRefs`: true
- `maxOutputLength`: 16000

### 3. Feature Flag (`lib/featureFlags.ts`)

**Added Flag:**
- `DIAGNOSIS_PROMPT_ENABLED`: boolean
- Environment variable: `NEXT_PUBLIC_FEATURE_DIAGNOSIS_PROMPT_ENABLED`
- Default: false (feature-gated)
- Integrated with existing feature flag system

**Type Safety:**
- Added to `FeatureFlags` type
- Accessible via `isFeatureEnabled('DIAGNOSIS_PROMPT_ENABLED')`

### 4. API Route (`apps/rhythm-studio-ui/app/api/studio/diagnosis/prompt/route.ts`)

**Endpoint:** `GET /api/studio/diagnosis/prompt`

**Functionality:**
- Returns prompt metadata and schema information
- Optional version query parameter (default: v1.0.0)
- Feature-gated behind `DIAGNOSIS_PROMPT_ENABLED`
- Authentication required (clinician or admin)
- Fetches prompt from registry

**Response (Success):**
```typescript
{
  success: true,
  data: {
    prompt_bundle_version: string,
    prompt_version: string,
    schema_version: string,
    metadata: PromptMetadata,
    placeholders: string[],
    guardrails: Guardrails
  }
}
```

**Endpoint:** `POST /api/studio/diagnosis/prompt`

**Functionality:**
- Validates diagnosis prompt output against v1 schema
- Feature-gated behind `DIAGNOSIS_PROMPT_ENABLED`
- Authentication required (clinician or admin)
- Uses `validateDiagnosisPromptOutputV1()` for validation

**Request Body:**
```typescript
{
  output: DiagnosisPromptOutputV1
}
```

**Response (Success):**
```typescript
{
  success: true,
  data: {
    valid: boolean,
    output?: DiagnosisPromptOutputV1,  // If valid
    errors?: ZodError[],               // If invalid
    schema_version: string
  }
}
```

**Security:**
- Server-side authentication check
- Role-based authorization (clinician/admin only)
- Feature flag gate
- Returns 401 for unauthenticated, 403 for unauthorized, 503 if disabled

### 5. Literal Callsite (Strategy A Compliance)

**File:** `apps/rhythm-studio-ui/app/admin/diagnostics/mcp-test/page.tsx`

**Added:**
- `testDiagnosisPromptGet()`: Tests GET endpoint
  - Literal string: `'/api/studio/diagnosis/prompt'`
- `testDiagnosisPromptValidate()`: Tests POST validation endpoint
  - Literal string: `'/api/studio/diagnosis/prompt'`
  - Sample output with all required fields
- UI section: "Diagnosis Prompt Schema (E76.5)"
- Two test buttons:
  - "Test GET Prompt Metadata"
  - "Test POST Validate Output"
- Result display with scrollable JSON output

**Compliance:**
- ‚úÖ Contains literal endpoint strings
- ‚úÖ Referenced as E76.5 in comments
- ‚úÖ Integrated with existing test page
- ‚úÖ Tests both GET and POST methods

### 6. Guardrails Verification (`scripts/ci/verify-e76-5-diagnosis-prompt.mjs`)

**Script Features:**
- Executable Node.js script
- 10 rule definitions with error codes
- Error code to rule ID mapping
- Violation reporting with "violates R-XYZ" format

**Rules Enforced:**
1. **R-E76.5-001**: Schema file must exist
2. **R-E76.5-002**: Schema must include all required fields
3. **R-E76.5-003**: Prompt must exist in registry with v1.0.0
4. **R-E76.5-004**: Prompt must include medical advice guardrails
5. **R-E76.5-005**: API route must exist
6. **R-E76.5-006**: Literal callsite must exist
7. **R-E76.5-007**: Feature flag must exist
8. **R-E76.5-008**: API must check authorization
9. **R-E76.5-009**: Version constants must be defined
10. **R-E76.5-010**: Validation helpers must exist

**Check Functions:**
- `checkDiagnosisPromptSchemaExists()`: Validates schema file and exports
- `checkDiagnosisPromptExists()`: Validates prompt registry entry
- `checkDiagnosisPromptAPIRouteExists()`: Validates API route implementation
- `checkDiagnosisPromptLiteralCallsiteExists()`: Validates Strategy A compliance
- `checkDiagnosisPromptFeatureFlagExists()`: Validates feature flag

**Error Codes:**
- `DIAGNOSIS_PROMPT_SCHEMA_MISSING`
- `DIAGNOSIS_PROMPT_SCHEMA_INCOMPLETE`
- `DIAGNOSIS_PROMPT_MISSING`
- `DIAGNOSIS_PROMPT_NO_GUARDRAILS`
- `DIAGNOSIS_PROMPT_API_MISSING`
- `DIAGNOSIS_PROMPT_LITERAL_MISSING`
- `DIAGNOSIS_PROMPT_FEATURE_FLAG_MISSING`
- `DIAGNOSIS_PROMPT_NO_AUTHORIZATION`
- `DIAGNOSIS_PROMPT_VERSION_MISSING`
- `DIAGNOSIS_PROMPT_VALIDATION_HELPERS_MISSING`

**Integration:**
- Added to `package.json` scripts: `npm run verify:e76-5`
- Exit codes: 0 (pass), 1 (violations), 2 (script error)

### 7. RULES_VS_CHECKS_MATRIX (`docs/guardrails/RULES_VS_CHECKS_MATRIX_E76_5.md`)

**Document Structure:**
- Overview and terminology
- Detailed matrix for each rule
- Summary table
- Known gaps section
- Diff report (rules without checks, checks without rules, scope mismatches)

**Coverage:**
- 10/10 rules enforced (100%)
- All checks reference their rule IDs
- All rules have check implementation
- No orphan rules or checks

**Known Gaps Documented:**
1. Field type validation (presence only, not Zod types)
2. Prompt template syntax validation
3. Helper function logic testing
4. Authorization logic (text search, not execution)
5. Version format validation (semver compliance)

## Verification

### All Guardrails Pass
```bash
$ npm run verify:e76-5

üîç E76.5: Verifying Diagnosis Prompt Schema implementation...

‚úÖ All E76.5 guardrails satisfied

Verified 10 rules:
  ‚úì R-E76.5-001: Diagnosis prompt output schema (v1) must exist
  ‚úì R-E76.5-002: Schema must include all required fields
  ‚úì R-E76.5-003: Prompt must exist in registry with version v1.0.0
  ‚úì R-E76.5-004: Prompt must include medical advice guardrails
  ‚úì R-E76.5-005: API route must exist
  ‚úì R-E76.5-006: Literal callsite must exist
  ‚úì R-E76.5-007: Feature flag must exist
  ‚úì R-E76.5-008: API route must check authorization
  ‚úì R-E76.5-009: Prompt bundle version and prompt version constants defined
  ‚úì R-E76.5-010: Schema must include validation helpers
```

### Lint Passing
All modified files pass ESLint with no errors or warnings.

### Strategy A Compliance
‚úÖ Endpoint wiring: Literal callsite exists (`/api/studio/diagnosis/prompt`)  
‚úÖ Feature flag gate: `DIAGNOSIS_PROMPT_ENABLED` (default: false)  
‚úÖ No orphan endpoints: Test page includes literal strings

## Technical Decisions

### Schema Design
- **Zod for validation**: Type-safe schema with runtime validation
- **Structured confidence levels**: Enum-based confidence/urgency/priority
- **Mandatory disclaimer**: Enforced via schema min length (50 chars)
- **Array constraints**: Min/max lengths prevent under/over-specification

### Prompt Design
- **Explicit guardrails**: System prompt states constraints clearly
- **Example output**: Helps LLM understand expected structure
- **Temperature 0.2**: Lower temperature for more consistent medical analysis
- **Max tokens 8192**: Allows detailed responses within limits

### API Design
- **Dual endpoints**: GET for metadata, POST for validation
- **Feature flag gate**: Prevents premature production use
- **Authorization required**: Clinician/admin only access
- **Server-side validation**: Never trust client for schema validation

### Security
- **No PHI in output**: Explicitly stated in guardrails
- **Medical advice disclaimer**: Required in every output
- **Professional judgment required**: Emphasized in system prompt
- **Server-side auth**: All checks done server-side

## Usage Example

### Fetching Prompt Metadata
```typescript
const response = await fetch('/api/studio/diagnosis/prompt')
const { data } = await response.json()
// data.prompt_version = 'v1.0.0'
// data.schema_version = 'v1'
// data.metadata = { promptId, version, description, ... }
```

### Validating Output
```typescript
const response = await fetch('/api/studio/diagnosis/prompt', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    output: {
      summary: '...',
      patient_context_used: { ... },
      differential_diagnoses: [ ... ],
      recommended_next_steps: [ ... ],
      urgent_red_flags: [],
      disclaimer: 'This is NOT medical advice...',
      schema_version: 'v1'
    }
  })
})
const { data } = await response.json()
// data.valid = true|false
// data.errors = [...] (if invalid)
```

### Client-Side Validation
```typescript
import { validateDiagnosisPromptOutputV1 } from '@/lib/contracts/diagnosis-prompt'

const result = validateDiagnosisPromptOutputV1(output)
if (result.success) {
  console.log('Valid:', result.data)
} else {
  console.error('Errors:', result.error)
}
```

## Files Modified

### New Files
- `lib/contracts/diagnosis-prompt.ts` (284 lines)
- `apps/rhythm-studio-ui/app/api/studio/diagnosis/prompt/route.ts` (231 lines)
- `scripts/ci/verify-e76-5-diagnosis-prompt.mjs` (459 lines)
- `docs/guardrails/RULES_VS_CHECKS_MATRIX_E76_5.md` (447 lines)

### Modified Files
- `lib/prompts/registry.ts` (+119 lines)
- `lib/featureFlags.ts` (+4 lines)
- `apps/rhythm-studio-ui/app/admin/diagnostics/mcp-test/page.tsx` (+76 lines)
- `package.json` (+1 script)

**Total:** 4 new files, 4 modified files, ~1621 lines added

## Next Steps

### Integration with E76.4 Worker
The diagnosis prompt can be integrated with the E76.4 worker by:
1. Fetching prompt from registry in worker
2. Calling LLM with system/user prompts
3. Validating response with `validateDiagnosisPromptOutputV1()`
4. Storing validated output in `diagnosis_artifacts` table

### Environment Configuration
To enable in production:
```bash
NEXT_PUBLIC_FEATURE_DIAGNOSIS_PROMPT_ENABLED=true
```

### CI/CD Integration
Add to CI pipeline:
```yaml
- name: Verify E76.5 Guardrails
  run: npm run verify:e76-5
```

## Issue Requirements Met

‚úÖ Defined prompt bundle (prompt_bundle_version/prompt_version)  
‚úÖ Defined JSON Schema v1 for diagnosis artifacts  
‚úÖ Included all required fields: summary, patient_context_used, differential_diagnoses (with rationale/confidence), recommended_next_steps, urgent_red_flags, disclaimer  
‚úÖ Explicit instruction: No medical advice, only for clinician review  
‚úÖ Minimal wiring (flagged) as part of this PR  
‚úÖ Prompt + Schema documented and validated against expected output  
‚úÖ At least one in-repo literal callsite exists  
‚úÖ Endpoint wiring gate shows no orphan for this endpoint  
‚úÖ Every rule has a check implementation  
‚úÖ Every check references a rule-ID  
‚úÖ Output contains "violates R-XYZ" for easy diagnosis  
‚úÖ RULES_VS_CHECKS_MATRIX_E76_5.md created with diff report  

## Acceptance Criteria

- [x] Prompt+Schema documented and validated against output
- [x] At least one in-repo literal callsite exists
- [x] Endpoint wiring gate shows no orphan for this endpoint
- [x] Every rule has a check implementation (Script/CI)
- [x] Every check references a rule-ID
- [x] Check output contains "violates R-XYZ"
- [x] RULES_VS_CHECKS_MATRIX.md + Diff-Report exists
